<!DOCTYPE html>
<html>
<head>
<title>Tabular Tracker Capture</title>
<meta charset="UTF-8">

	<!-- Credit: 
		'webL10n' - implemented by Victor Garcia, vgarciabnz@gmail.com
	-->
	<script src="js/jQuery/jquery-1.11.1.min.js"></script>
	<script src="js/jQuery/jquery-ui.min.js"></script>
	<script src="js/jQuery/jquery.ui.core.js"></script>
	<script src="js/jQuery/jquery.ui.widget.js"></script>
	<script src="js/jQuery/jquery.ui.datepicker.js"></script>
	<script src="js/jQuery/jquery.dateFormat-1.0.js"></script>
	<script src="js/jQuery/jquery.watermark.js"></script>
	<script src="js/jQuery/jquery.cookie.js"></script>
	<script src="js/jQuery/jquery.blockUI.js"></script>
	<script src="js/moment.min.js"></script>

	<script src="js/gmap3/gmap3.min.js"></script> 
	<script src="js/gmap3/gmap3-menu.js"></script>

	<script src="js/app/dialogLoading.js"></script>
	<script src="js/app/util.js"></script>
	<script src="js/app/RESTUtil.js"></script>
	
	<link rel="stylesheet" href="css/jQuery/jquery.ui.all.css">
	<link rel="stylesheet" href="css/jQuery/jquery-ui.css" />
	<link rel="stylesheet" href="css/gmap3/gmap3-menu.css" />
	<link rel="stylesheet" href="css/app/style.css">

	<link rel="resource" type="application/l10n" href="locales/locales.ini" />
	<script src="js/l10n.js"></script>

	<!-- URL addresses (Dhis site, home, api) -->
	<script>


		// ==========================
		// OVERVIEW: 
		//	Class / Function Orders

		// === Core Classes ===
		// - TabularDataEntry Class : The main class
		// - SearchPanel
		// - DefaultProgram_TEA_Manager
		// - ProgramManager
		// - PersonList
		// - PersonEvent Class

		// - DataInMemory Class

		// - ProgramRule Class
		// - ProgramRuleUtil Class (Static)

		// === Popup Form Classes ===
		// - PersonDialogForm Class
		// - LanguageSetting Class
		// - SettingForm Class
		// - OrgUnitMapPopup

		// - GMapHelper (Static)

		// === Static Helper Util Classes ===
		// - DHISUtil Class (Static)
		// - AppUtil Class (Static)
		// - FormUtil Class (Static)
		// - PersonUtil Class (Static)
		// - EventUtil Class (Static)
		// - Weekly Class (Static)
		// - Monthly Class (Static)		
		// - DBSetting Class (Static)
		// - MsgManager Class (Static)

		// === Common Static Helper Class in JS File ===
		// - DialogLoading Class (Static)
		// - Util Class (Static)		
		// - RESTUtil Class (Static)

		// ==========================


		// ------------------------------------
		// *** DHIS AppStore Deploy Version ***
		// -- App Manifest Json (Get this via Synch, so that it is defined ahead)
		var _appManifest = $.parseJSON( RESTUtil.getSynchData( 'manifest.webapp' ) );
		// -- URLs
		var _dhisSiteURL = _appManifest.activities.dhis.href.replace( '/dhis-web-maintenance-appmanager', '' ) + '/';
		// ------------------------------------

		// -------------------
		// *** PSI Version ***
		//var _dhisSiteURL = "../../";
		// -------------------

		var _dhisHomeURL = _dhisSiteURL + 'dhis-web-dashboard-integration/index.action';

		var _queryURL_api = _dhisSiteURL + 'api/';

		var _queryURL_me = _queryURL_api + "me";

		var _queryURL_systemInfo = _queryURL_api + "system/info"

		var _queryURL_appTitle = _queryURL_api + 'systemSettings?key=applicationTitle';

		var _queryURL_OrgUnit = _queryURL_api + "organisationUnits";

		var _queryURL_Program = _queryURL_api + "programs/";
		var _queryURL_ProgramList = _queryURL_api + "programs.json";
		var _queryURL_ProgramStages = _queryURL_api + "programStages";
		var _queryURL_DataElementDetail = _queryURL_api + "dataElements/";
		var _queryURL_OptionSets = _queryURL_api + "optionSets/";

		var _queryURL_ProgramStageInstance = _queryURL_api + "events/"; 

		var _queryURL_PersonSubmit = _queryURL_api + "trackedEntityInstances";
		var _queryURL_PersonQuery = _queryURL_api + "trackedEntityInstances"; 

		var _queryURL_PersonAttributes = _queryURL_api + "trackedEntityAttributes.json?paging=false&viewClass=detail&fields=id,name,valueType,optionSetValue,optionSet[id,name,options[id,code,name,displayName]]";

		var _queryURL_TrackedEntities = _queryURL_api + "trackedEntities";

		var _queryURL_EventQuery = _queryURL_api + "events.json?paging=false&skipPaging=true";
		var _queryURL_EventSubmit = _queryURL_api + "events";

		var _queryURL_TEIFromEventQuery = _queryURL_api + "events/eventRows.json?paging=false&skipPaging=true";

		var _queryURL_ProgramEnrollmentSubmit = _queryURL_api + "enrollments";
		var _queryURL_ProgramEnrollmentQuery = _queryURL_api + "enrollments.json";

		var _queryURL_ProgramRules = _queryURL_api + "programRules";
		var _queryURL_ProgramRuleVariables = _queryURL_api + "programRuleVariables";

		var _queryURL_PersonDataValidate = _dhisSiteURL + "dhis-web-caseentry/validateTrackedEntityInstance.action";

	</script>

	<!-- OrgUnit Tree Related -->
	<script type="text/javascript" src="js/DHIS/oust_v2.js"></script>

	<!-- Main App Coding -->
	<script>
	
		// Global variables/objects

		// -- Static definitions
		var _Success = 1;
		var _Fail = 0;

		var _dateFormat_Picker_YYMMDD = "yy/mm/dd";
		var _dateFormat_Picker_YYMMDD_Dash = "yy-mm-dd";
		var _dateFormat_YYYYMMDD = "yyyy/MM/dd";
		var _dateFormat_YYYYMMDD_Dash = "yyyy-MM-dd";
		
		var _dateFormat_DDMMMYYYY = "dd MMM yyyy";

		var _status_ACTIVE = "ACTIVE";
		var _status_CANCELLED = "CANCELLED";
		var _status_COMPLETED = "COMPLETED";

		var _view = 'view';
		var _view_Yes = 'y';


		// -- Instances and variables
		var _today = new Date();

		var _TabularDEObj;

		var _weekStartDate;
		var _weekEndDate;

		var l10n;
		var _appInitialized = false;
		var _userLanguage;

		var _deploymentManagerId = 'jamesc'; // userID for some feature on 'Setting' popup - 'latest version number update / 'incomplete' event user role'


		// =========================================================
		// On localization and page load run
		
		// This method is called when localization and page are loaded
		document.webL10n.ready( function() 
		{
			l10n = document.webL10n;

			if( _userLanguage == null ) {

				// First call to document.webL10n.ready
				DHISUtil.retrieveUserAccount( function( json_data ) 
				{
					_userLanguage = json_data.settings.keyUiLocale;
					l10n.setLanguage(_userLanguage);
				});

			} else if ( !_appInitialized ){
				// Second call to document.webL10n.ready

				// Loading message popup initial setup 
				DialogLoading.initialSetup();

				MsgManager.initialSetup();

				// Alert User if some cached files are out of synch.
				AppUtil.CheckCachedFileSynch();

				// DHIS system related value set
				DHISUtil.retrieveAndSet_DHISData();

				// Pre-retrieve User Info - so same retrieval afterwards reuse this from memory
				DHISUtil.preRetrieve_UserInfo();

				// Main class create/run
				_TabularDEObj = new TabularDataEntry();

				_appInitialized = true;
			} 
		});

		// =========================================================
		//  Classes

		// -------------------------------------------
		// Class - TabularDataEntry
		//			- The main class.  This class represents the entire TabularDataEntry, thus, includes all the class/object.
		function TabularDataEntry()
		{
			var me = this;

			// App Setting Form Popup
			me.settingForm = new SettingForm();

			// Data in memory access
			me.dataInMemory = new DataInMemory();

			// Setting Related
			me.searchPanel = new SearchPanel( me );

			// Person List
			me.personList = new PersonList( me );

			// OrgUnitMap Popup
			me.orgUnitMapPopup = new OrgUnitMapPopup( me );

			// ProgramRule
			me.programRule = new ProgramRule( me );


			// --------------------------
			// Method Calls From Child Object to each other

			// -- SettingForm Related --------

			me.getCountryLevel = function()
			{
				return me.settingForm.getCountryLevel();
			}

			me.checkIncompleteAction_UserRole = function( runFunc )
			{
				me.settingForm.checkIncompleteAction_UserRole( runFunc );
			}


			// -- SearchPanel Related --------

			me.populateProgramStages = function( programStageTag, programVal )
			{
				me.searchPanel.programManager.populateProgramStages( programStageTag, programVal );
			}

			me.populatePrograms = function( programTag )
			{
				me.searchPanel.programManager.populatePrograms( programTag );
			}

			me.getProgramStageList = function( programId )
			{
				return me.searchPanel.programManager.getProgramStageList( programId );
			}

			me.resetUnderPersonOptions = function()
			{
				me.searchPanel.resetUnderPersonOptions();
			}

			me.getOrgUnitId = function()
			{
				return me.searchPanel.getOrgUnitId();
			}

			me.getEventQueryBaseUrl = function()
			{
				return me.searchPanel.getEventQueryBaseUrl();
			}

			me.getTEIFromEventQueryBaseUrl = function()
			{
				return me.searchPanel.getTEIFromEventQueryBaseUrl();
			}

			me.getSelectedProgramId = function()
			{
				return me.searchPanel.programManager.selectedProgramId;
			}

			me.getSelectedProgram = function()
			{
				return me.searchPanel.programManager.selectedProgram;
			}

			me.getSelectedProgramType = function()
			{
				return me.searchPanel.programManager.getSelectedProgramType();
			}

			me.isCase_MEwR = function()
			{
				return me.searchPanel.programManager.isCase_MEwR();
			}

			me.isCase_SEwoR = function()
			{
				return me.searchPanel.programManager.isCase_SEwoR();
			}

			me.getDefaultStartDate = function()
			{
				return me.searchPanel.getDefaultStartDate();
			}

			me.getDefaultEndDate = function()
			{
				return me.searchPanel.getDefaultEndDate();
			}

			me.isCase_ListAllPersonHistoricalEvents = function()
			{
				return me.searchPanel.isCase_ListAllPersonHistoricalEvents();
			}
			
			me.isCase_SearchAllProgram = function()
			{
				return me.searchPanel.isCase_SearchAllProgram();
			}
			
			me.getSearchProgramStatus = function()
			{
				return me.searchPanel.getSearchProgramStatus();
			}

			me.setPersonFoundNoSpanTag = function( inputText )
			{
				me.searchPanel.personFoundNoSpanTag.html( inputText );	
			}

			me.getProgramList_Full = function()
			{
				return me.searchPanel.programManager.getProgramList_Full();
			}

			me.getProgramStageList_Full = function()
			{
				return me.searchPanel.programManager.getProgramStageList_Full();
			}

			me.getProgramStageData_ById = function( programStageId )
			{
				return me.searchPanel.programManager.getProgramStageData_ById( programStageId );
			}

			me.getProgramTrackedEntityAttributes = function()
			{
				return me.searchPanel.defaultProgram_TEA_Manager.getProgramTrackedEntityAttributes();
			}

			me.getFirstDisplayAttribute = function()
			{
				return me.searchPanel.defaultProgram_TEA_Manager.getFirstDisplayAttribute();
			}

			me.getInDisplayListCount = function()
			{
				return me.searchPanel.defaultProgram_TEA_Manager.getInDisplayListCount();
			}


			// -- PersonList Related -------

			me.resetMainList = function()
			{
				me.personList.resetMainList();
			}

			me.populatePersonData = function( returnFunc )
			{
				return me.personList.populatePersonData( returnFunc );
			}				

			me.personInfoPopup = function( personInfoTag, afterSaveAction )
			{
				me.personList.personInfoPopup( personInfoTag, afterSaveAction );
			}

			me.retrieveAndPopulateEvents = function( tableCurrent, execFunc )
			{
				return me.personList.personEvent.retrieveAndPopulateEvents( tableCurrent, execFunc );
			}

			me.getMainPersonTableTag = function()
			{
				return me.personList.mainPersonTableTag;
			}

			me.hideMainSections = function()
			{
				return me.personList.hideMainSections();
			}

			me.showMainSection = function()
			{
				return me.personList.showMainSection();
			}

			me.getJson_PersonList_EventDateChecked = function()
			{
				return me.personList.json_PersonList_EventDateChecked;
			}

			me.getPerson_WithDoneStage = function( personId, execFunc )
			{
				return me.personList.getPerson_WithDoneStage( personId, execFunc );
			}

			me.retreivePersonListWithEvents = function( populateFunc )
			{
				return me.personList.personEvent.retreivePersonListWithEvents( populateFunc );
			}

			me.setPersonInfoRow = function( trCurrent, item_person )
			{
				me.personList.setPersonInfoRow( trCurrent, item_person );
			}

			/*
			me.programEnroll = function( personId, programId, orgUnitId, eventDateInFormat, newlyEnrolledAction, successAction, failAction )
			{
				return me.personList.programEnroll( personId, programId, orgUnitId, eventDateInFormat, newlyEnrolledAction, successAction, failAction );
			}
			*/

			me.checkProgramEnroll = function( personId, programId, orgUnitId, enrolledAction, notEnrolledAction )
			{
				me.personList.checkProgramEnroll( personId, programId, orgUnitId, enrolledAction, notEnrolledAction );
			}

			me.programEnroll = function( personId, programId, orgUnitId, eventDateInFormat, successAction, failAction )
			{
				me.personList.programEnroll(  personId, programId, orgUnitId, eventDateInFormat, successAction, failAction );
			}

			me.createPersonTableHeaders = function( programTrackedEntityAttributes )
			{
				me.personList.createPersonTableHeaders( programTrackedEntityAttributes );
			}

			me.populatePersonAttirbutesToRow = function( trCurrent, attributes )
			{
				me.personList.populatePersonAttirbutesToRow( trCurrent, attributes );
			}

			me.addTo_DoneStage = function( trPersonRow, stageId )
			{
				me.personList.addTo_DoneStage( trPersonRow, stageId );
			}

			// PersonEvent Related 
			me.getAttrControlsTemplate = function()
			{
				return me.personList.personEvent.getAttrControlsTemplate();
			}


			// ========================================================

			// Methods
			me.setupTopSection = function()
			{
				// Set click event - back to application
				$( '#headerBanner,#headerText,#closeButton' ).click( function() { window.location.href = _dhisHomeURL; } );

				// Get application title
				$.get( _queryURL_appTitle, function( json_Data )
				{
					$( '#headerText' ).text( Util.getNotEmpty( json_Data.applicationTitle ) );
				});


				$( '#settingFormOpen' ).click( function()
				{
					me.settingForm.openForm();

					return false;
				});
			}

			// ========================================================

			me.initialSetup = function( )
			{	

				me.setupTopSection();

				// get Setting Data to keep in memory and check for required setting data for this app.
				me.settingForm.loadSettingDataInitially_AndCheckRequired();

				// Hide the person list.
				me.searchPanel.setVisibility_MainSectionDiv( false );

				// Initially set focus on OrgUnit Search Tag
				me.searchPanel.orgUnitNameTag.val( '' ).focus();


				/*
				$( '#testBtn' ).click( function()
				{
					console.log( 'selected Program: ' + JSON.stringify( me.searchPanel.programManager.selectedProgram ) );
				});
				*/

			}


			// Initial Setup Call
			me.initialSetup( );
		}

		// Class - TabularDataEntry
		// -------------------------------------------


		// -------------------------------------------
		// Class - SearchPanel
		//			- Setting data holding class
		function SearchPanel( TabularDEObj )
		{
			var me = this;

			me.TabularDEObj = TabularDEObj;

			me.queryURL_OrgUnit = _queryURL_api + 'organisationUnits/'; //EmUlPkdz1t8.json?viewClass=basic
			me.queryURL_OrgUnitNameQuery = _queryURL_api + 'organisationUnits.json?paging=false&fields=name,id,level,parents[id,name,level],ancestors[id,name,level]&filter=name:ilike:';
			
			// Tages..
			me.orgUnitMapSmall_DivTag = $( '#orgUnitMapSmall' );
			me.orgUnitRowTag = $( '#orgUnitRow' );
			me.orgUnitNameTag = $( '#orgUnitName' );	// Default OrgUnit Search By Name
			me.orgUnitTreeBtnTag = $( '#orgUnitTreeBtn' );

			me.defaultDateRowTag = $( '#defaultDateRow' );
			me.defaultDateTag = $( '#defaultDate' );
			me.defaultDateFromTag = $( '#defaultDateFrom' );
			me.defaultDateToTag = $( '#defaultDateTo' );

			//me.periodRadio_MonthTag = $( '#periodRadio_Month' );

			me.defaultRetrievalRowTag = $( '#defaultRetrievalRow' );
			me.executeRetrievalTag = $( '#executeRetrieval' );

			me.defaultProgramRowTag = $( '#defaultProgramRow' );
			me.defaultProgramTag = $( '#defaultProgram' );
			me.defaultProgramNoteSpanTag = $( '#defaultProgramNote' );
			me.personFoundNoSpanTag = $( '#personFoundNo' );
			me.personList_DescSpanTag = $( '#personList_Desc' );

			me.personEventSearchOptionsTag = $( '#personEventSearchOptions' );

			me.programStatusListTag = $( '#programStatusList' );
			me.searchAllProgramTag = $( '#searchAllProgram' );
			me.listAllPersonHistoricalEventsTag = $( '#listAllPersonHistoricalEvents' );

			me.searchResultMsgRowTag = $( '#searchResultMsgRow' );
			me.searchResultMessageTag = $( '#searchResultMessage' );

			me.defaultDateType;
			me.defaultDateFrom;
			me.defaultDateTo;
			
			// Set program manager
			me.programManager = new ProgramManager( me.TabularDEObj, me.defaultProgramTag );

			me.defaultProgram_TEA_Manager = new DefaultProgram_TEA_Manager();

			// OrgUnit Selection Tree Popup
			me.orgUnitSelectionTreePopup = new OrgUnitSelectionTreePopup( me );


			me.countrySelectedId;
			me.orgUnitSelectedId;
		
			me.userAccessableOrgUnits;
			
			me.countryOrgUnitId = "";
			
			me.orgUnitSearchRequests = [];
			me.orgUnitSearchParentsRequests = [];

			// ----------------------------------
			// Functions 


			me.isCase_ListAllPersonHistoricalEvents = function()
			{
				return me.listAllPersonHistoricalEventsTag.is( ":checked" );
			}
			
			me.isCase_SearchAllProgram = function()
			{
				return me.searchAllProgramTag.is( ":checked" );
			}

			me.getCountryId = function()
			{
				return me.countryOrgUnitId;
			}
						
			me.setCountryId = function( orgUnitId, ouParents )
			{
				me.countryOrgUnitId = "";

				var countryLevel = me.TabularDEObj.getCountryLevel();

				if ( countryLevel !== undefined )
				{
					if ( ouParents !== undefined )
					{
						$.each( ouParents, function( i, item )
						{
							if ( item.level == countryLevel )
							{
								me.countryOrgUnitId = item.id;
								
								return false;
							}
						});
					}
					else
					{
						// CHANGED: Oct 5, 2017
						$.get( me.queryURL_OrgUnit + orgUnitId + '.json?fields=ancestors[id,name,level]', function( json_data )
						{
							if ( json_data.ancestors !== undefined )
							{
								$.each( json_data.ancestors, function( i, item )
								{
									if ( item.level == countryLevel )
									{
										me.countryOrgUnitId = item.id;
										
										return false;
									}
								});
							}
						});
					}
				}
			}
			
			me.setOrgUnitTags = function( orgUnitId, orgUnitName ) 
			{
				me.orgUnitNameTag.val( orgUnitName );
				me.orgUnitSelectedId = orgUnitId;

				Util.paintClear( me.orgUnitNameTag );
			}

			me.getOrgUnitId = function()
			{
				return me.orgUnitSelectedId;
			}


			me.retrieveUserAccessOrgUnits = function( execFunc )
			{
				DHISUtil.retrieveUserInfo( function( json_data )
				{
					me.userAccessableOrgUnits = json_data.organisationUnits;
					execFunc();
				});					
			}

			me.displayOrgUnitPersonCount = function( orgUnitId )
			{
				var personFoundCount = 0;

				// Set small page size since we only need number from total count
				
				var queryUrl = _queryURL_PersonQuery + ".json?skipPaging=true&fields=trackedEntityInstance&ou=" + orgUnitId;
								
				$.get( queryUrl, function( personList )
				{
					//me.json_PersonList = personList;

					if( personList !== undefined && personList.trackedEntityInstances !== undefined )
					{
						personFoundCount = personList.trackedEntityInstances.length;

						me.personFoundNoSpanTag.text( personFoundCount );
						me.personFoundNoSpanTag.attr( "title", "TEIs in OrgUnit: " + personFoundCount );
					}					
				});
			}

			me.clear_OrgUnitData = function()
			{
				delete me.orgUnitSelectedId;
				me.personFoundNoSpanTag.text( '' ).attr( "title", "" );	
				me.orgUnitMapSmall_DivTag.hide( '500' );
			}
			
			me.resetSetting_OrgUnitAndBelow = function()
			{
				me.orgUnitNameTag.val( '' );

				me.clear_OrgUnitData();

				me.setVisibility_Section( me.orgUnitRowTag, false );

				me.resetSetting_ProgramAndBelow();
			}

			me.resetSetting_ProgramAndBelow = function()
			{
				// program related reset
				me.programManager.resetSelectedProgram();

				me.defaultProgram_TEA_Manager.setProgramTrackedEntityAttributes( new Array() );
				me.defaultProgramNoteSpanTag.text( '' );

				// Should set as a function for reset
				me.setVisibility_Section( me.defaultProgramRowTag, false );	

				me.resetSetting_PeriodAndBelow();
			}


			me.resetSetting_PeriodAndBelow = function()
			{
				me.hidePeriodInputs();

				Util.paintAttention( me.defaultDateRowTag.find( 'input[type="radio"]' ).prop( 'checked', false ) );

				me.setVisibility_Section( me.defaultDateRowTag, false );	

				me.resetSetting_executeRetrieval();
				me.resetUnderPersonOptions();
				me.resetMainDataRelated();
			}


			me.resetSetting_executeRetrieval = function()
			{
				me.setVisibility_Section( me.defaultRetrievalRowTag, false );
			}


			me.resetUnderPersonOptions = function()
			{
				me.programStatusListTag.val( _status_ACTIVE );

				me.searchAllProgramTag.prop( 'checked', false );
				me.listAllPersonHistoricalEventsTag.prop( 'checked', false );
				
				me.setVisibility_Section( me.personEventSearchOptionsTag, false );
			}


			me.resetMainDataRelated = function()
			{
				me.setVisibility_MainSectionDiv( false );

				//json_PersonList = null;

				me.personList_DescSpanTag.html( "" );
				me.searchResultMsgRowTag.hide();
				me.searchResultMessageTag.text( "" );
			}


			me.setVisibility_Section = function( sectionTag, visible )
			{
				Util.disableTag( sectionTag, !visible );

				if( !visible )
				{
					sectionTag.slideUp( 400 );
				}
				else
				{
					sectionTag.slideDown( 400 );
				}
			}

			me.setVisibility_MainSectionDiv = function( visible )
			{
				me.TabularDEObj.hideMainSections();
				
				if ( visible )
				{
					me.TabularDEObj.showMainSection(); 
				}
			}


			me.showRetrievelButton = function()
			{
				me.setVisibility_Section( me.defaultRetrievalRowTag, true );
			}


			me.retrieveProgramPersonAttributeData = function( programId, returnFunc )
			{
				var programTrackedEntityAttributes = new Array();

				if ( programId != '' )
				{
					RESTUtil.getAsynchData( _queryURL_Program + programId + '.json?fields=id,programTrackedEntityAttributes[displayInList,allowFutureDate,mandatory,trackedEntityAttribute[id,name]]'
						, function( json_Program )
						{
							if ( json_Program.programTrackedEntityAttributes !== undefined )
							{
								$.each( json_Program.programTrackedEntityAttributes, function( i_attribute, item_attribute ) 
								{
									programTrackedEntityAttributes.push( { "id": item_attribute.trackedEntityAttribute.id, "name": item_attribute.trackedEntityAttribute.name, "mandatory": item_attribute.mandatory, "displayInList": item_attribute.displayInList } );
								});
							}

							returnFunc( programTrackedEntityAttributes );
						}
					);
				}
				else
				{
					returnFunc( programTrackedEntityAttributes );
				}
			}

			
			me.getEventQueryBaseUrl = function()
			{
				return _queryURL_EventQuery + '&programStatus=' + me.programStatusListTag.val();
			}

			me.getTEIFromEventQueryBaseUrl = function()
			{
				return _queryURL_TEIFromEventQuery + '&programStatus=' + me.programStatusListTag.val();
			}

			me.getSearchProgramStatus = function()
			{
				return me.programStatusListTag.val();
			}

			// ----------------------------------
			// Event related

			me.setUp_OrgUnitAutoSelection = function( orgUnitNameTag )
			{
				orgUnitNameTag.autocomplete( {
					source: 
						function( request, response ) 
						{
							orgUnitNameTag.removeClass( "ui-autocomplete-loading" );

							// Reset orgUnitSelectedId and below section
							me.orgUnitSelectionTreePopup.clearSelections();
							me.clear_OrgUnitData();
							me.resetSetting_ProgramAndBelow();

							me.orgUnitSearchRequests = FormUtil.abortAndClear_XhrRequest( me.orgUnitSearchRequests );
							me.orgUnitSearchParentsRequests = FormUtil.abortAndClear_XhrRequest( me.orgUnitSearchParentsRequests );
							
							
							var json_orgUnitList_new = new Array();


							if ( request.term.length >= 2 )
							{

								var xhr_ouSearch = RESTUtil.getAsynchData( me.queryURL_OrgUnitNameQuery + request.term
								, function( json_orgUnits ) 
								{

									var json_orgUnitList = json_orgUnits.organisationUnits;

									if( Util.checkDataExists( json_orgUnitList ) )
									{
										
										var deferredArrActions_ouAccessCheck = [];

										QuickLoading.dialogShowAdd( 'orgUnitLoading' );

										// Due to 'ancesters' and 'parents' compatibility, copy 'ancestors' data
										// into 'parents' and use 'parents' always.
										AppUtil.copyAncestorsToParents( json_orgUnitList );


										$.each( json_orgUnitList, function( i_ou, item_ou)
										{
											if ( item_ou.parents !== undefined )
											{
												if ( me.checkUserAccessable( item_ou.parents ) )
												{
													json_orgUnitList_new.push( me.getOUSelectionFormatted( item_ou, item_ou.parents ) );
												}
											}
											else
											{
												var xhr_parents = RESTUtil.getAsynchData( me.queryURL_OrgUnit + item_ou.id + '/parents.json?fields=name,id,level', function( json_orgUnitParents ) 
												{
													var ouParents = json_orgUnitParents.organisationUnits;
													if ( me.checkUserAccessable( ouParents ) )
													{
														json_orgUnitList_new.push( me.getOUSelectionFormatted( item_ou, ouParents ) );
													}
												}
												, function() {}
												);

												deferredArrActions_ouAccessCheck.push( xhr_parents );
												me.orgUnitSearchParentsRequests.push( xhr_parents );
											}
										});


										$.when.apply($, deferredArrActions_ouAccessCheck ).then( function( ) 
										{
											QuickLoading.dialogShowRemove( 'orgUnitLoading' );

											var json_orgUnitList_new_Sorted = Util.sortByKey( json_orgUnitList_new, "value" );

											response( json_orgUnitList_new_Sorted );
										});
									}
								}
								, function() {}
								, function() { QuickLoading.dialogShowAdd( 'orgUnitLoading' ); }
								, function() { QuickLoading.dialogShowRemove( 'orgUnitLoading' ); }
								);

								me.orgUnitSearchRequests.push( xhr_ouSearch );

							}
							else
							{
								response( json_orgUnitList_new );

								Util.paintAttention( orgUnitNameTag );
							}
						}
					,minLength: 0
					,delay: 800
					,select: 
						function( event, ui ) 
						{							
							me.orgUnitSelectionTreePopup.selectOrgUnit( ui.item.orgUnit.id, ui.item.parents );

							// On select, set orgunit info and perform followup steps
							me.onOrgUnitSelect( ui.item.orgUnit );

							orgUnitNameTag.removeClass( "ui-autocomplete-loading" );
							orgUnitNameTag.autocomplete( "close" );
						}
				} );
			}


			me.checkUserAccessable = function( parentOUs )
			{
				var isUserAccessOU = false;

				if ( Util.checkValue( parentOUs ) )
				{
					$.each( parentOUs, function( i_parentOU, item_parentOU )
					{
						$.each( me.userAccessableOrgUnits, function( i_userOU, item_userOU)
						{
							if ( item_userOU.id == item_parentOU.id )
							{
								isUserAccessOU = true;
								return false;
							}
						});

						if ( isUserAccessOU ) return false;
					});
				}

				return isUserAccessOU;
			}


			me.getOUSelectionFormatted = function( item_ou, parents )
			{
				var itemLabel = item_ou.name + " ( lvl:" + item_ou.level;

				if ( Util.getNotEmpty( item_ou.code ).length > 0)
				{
					itemLabel += ", code:" + Util.getNotEmpty( item_ou.code );
				}

				itemLabel += " )";

				return { "id": item_ou.id, "label": itemLabel, "value": item_ou.name, "orgUnit": item_ou, "parents": parents };
			}


			// On select, set orgunit info and perform followup steps
			me.onOrgUnitSelect = function( orgUnit, clearOu )
			{
				// When coming from orgUnitPopupTree selection, clear orgUnit Map data again.
				if ( clearOu !== undefined && clearOu )
				{
					me.clear_OrgUnitData();
					me.resetSetting_ProgramAndBelow();
				}

				var orgUnitId = orgUnit.id;

				// Set OrgUnit
				me.setOrgUnitTags( orgUnit.id, orgUnit.name );


				me.setVisibility_Section( me.defaultProgramRowTag, true );


				// Re-retrieve the programManager based on the orgUnit
				me.programManager.loadProgramList( orgUnitId );


				me.setCountryId( orgUnitId, orgUnit.parents );
				

				// Notify person count in the org unit
				me.displayOrgUnitPersonCount( orgUnitId );

				
				// Setup the orgUnit Map
				me.setUp_OrgUnitMap( orgUnitId );


				me.defaultProgramTag.focus();

			}

			// On reset orgunit, we need to remove the map from image, etc..

			me.setUp_OrgUnitMap = function( ouId )
			{
				// Get orgunit coordinate first
				RESTUtil.getAsynchData( me.queryURL_OrgUnit + ouId + '.json?fields=id,coordinates'
				, function( json_orgUnit ) 
				{
					if ( json_orgUnit.coordinates !== undefined )
					{
						var coordinatesData = $.parseJSON( json_orgUnit.coordinates );
						//[36.630948,-0.981278]

						if ( coordinatesData.length == 2 )
						{
							var longitude = coordinatesData[0];
							var latitude = coordinatesData[1];

							var mapUrl = 'https://maps.googleapis.com/maps/api/staticmap?';

							mapUrl += 'zoom=9&size=120x80';

							mapUrl += '&markers=size:tiny%7Ccolor:blue%7Clabel:S%7C' + latitude + ',' + longitude;

							mapUrl += '&center=' + latitude + ',' + longitude;

							// Set the map info
							$( '#orgUnitMapImage' ).attr( 'src', mapUrl ).attr( 'lat', latitude ).attr( 'lng', longitude );

							me.orgUnitMapSmall_DivTag.show( '600' );
						}
					}

				}
				, function() 
				{
					console.log( 'Failed to retrieve the org unit - during org unit map setup' );
				});
			}

			me.setUp_OrgUnitMapClick = function( )
			{
				$( '#orgUnitMapAnchor' ).click( function()
				{
					var orgUnitMapPopupForm = me.TabularDEObj.orgUnitMapPopup;

					// Set the image first
					var mapImgTag = $( this ).find( 'img' );
					
					//console.log( 'mapImgTag: ' + mapImgTag.length );

					orgUnitMapPopupForm.setUp_Map( mapImgTag.attr( 'lat' ), mapImgTag.attr( 'lng' ) );
					
					orgUnitMapPopupForm.dialogFormTag.dialog( "open" );

					return false;
				});
			}


			me.setUp_orgUnitTreePopup = function( onOrgUnitSelectFunc )
			{
				me.orgUnitTreeBtnTag.click( function()
				{
					me.orgUnitSelectionTreePopup.openForm();

					//return false;
				});

				me.orgUnitSelectionTreePopup.onOrgUnitSelectSet( onOrgUnitSelectFunc );

			}


			me.setPeriod_DefaultDates = function( date )
			{
				// Set day
				//me.defaultDateTag.val( $.format.date( date, _dateFormat_YYYYMMDD ) );

				// Set Week
				$( '#defaultWeek' ).val( Weekly.getLastWeekStr( date ) );


				// Set Month
				Monthly.setDate( $( '#defaultMonth_Month' ), $( '#defaultMonth_Year' ), date );

				var yesterday = new Date( date.getFullYear(), date.getMonth(), date.getDate() - 1 );

				// Date Period
				me.defaultDateFromTag.val( $.format.date( yesterday, _dateFormat_YYYYMMDD ) );
				me.defaultDateToTag.val( $.format.date( yesterday, _dateFormat_YYYYMMDD ) );
			}


			me.setPeriod_Events = function()
			{
				// Setup click event
				$( "input[type='radio'][name='period']" ).click( function() 
				{
					me.hidePeriodInputs();

					var radioBtn = $( this ).attr( 'value' );

					
					if ( radioBtn == 'month' )
					{
						$( '#defaultMonth' ).show();
					}
					else if ( radioBtn == 'week' )
					{
						$( '#defaultWeek' ).show();
					}
					else if ( radioBtn == 'custom' )
					{
						$( '#defaultDatePeriod' ).show();
					}

					me.defaultDateType = radioBtn;

					// Enable the populate button since date has been changed..
					//me.setStatus_PopulateButton();

					if ( me.TabularDEObj.isCase_MEwR() ) 
					{
						me.setVisibility_Section( me.personEventSearchOptionsTag, true );
					}

					// Perform the retrieval action
					//me.performDataRetrieval();

					// Show Data
					me.showRetrievelButton();


					// Scroll right end
					AppUtil.pageHScroll( "Right" );
				});		


				$( "input[type='radio'][name='period']" ).keydown( function( event ) 
				{
					if ( event.keyCode == 13 )
					{
						$( this ).click();
					}
				});

			}

			me.hidePeriodInputs = function()
			{
				$( '#defaultMonth' ).hide();
				$( '#defaultWeek' ).hide();
				$( '#defaultDatePeriod' ).hide();
			}

			me.getDefaultStartDate = function()
			{
				var date;

				if ( me.defaultDateType  == 'day' )
				{
					date = Util.getDate_FromYYYYMMDD( $( '#defaultDate' ).val() );
				}
				else if ( me.defaultDateType  == 'week' )
				{
					date = Weekly.getStartDate( $( '#defaultWeek' ).val() );
				}
				else if ( me.defaultDateType  == 'month' )
				{
					date = Monthly.getStartDate( $( '#defaultMonth_Month' ), $( '#defaultMonth_Year' ) );
				}
				else if ( me.defaultDateType  == 'custom' )
				{
					date = Util.getDate_FromYYYYMMDD( $( '#defaultDateFrom' ).val() );
				}
				
				return date;
			}


			me.getDefaultEndDate = function()
			{
				var date;

				if ( me.defaultDateType  == 'day' )
				{
					date = Util.getDate_FromYYYYMMDD( $( '#defaultDate' ).val() );
				}
				else if ( me.defaultDateType  == 'week' )
				{
					date = Weekly.getEndDate( $( '#defaultWeek' ).val() );
				}
				else if ( me.defaultDateType  == 'month' )
				{
					date = Monthly.getEndDate( $( '#defaultMonth_Month' ), $( '#defaultMonth_Year' ) );
				}
				else if ( me.defaultDateType  == 'custom' )
				{
					date = Util.getDate_FromYYYYMMDD( $( '#defaultDateTo' ).val() );
				}
								
				return date;
			}


			me.setDefaultDatePeriod_Related = function()
			{

				// Set Default Date RadioButton as 'Date'
				$( "input[type='radio'][name='period'][value='day']" ).prop('checked', true );
				me.defaultDateType  = 'day';
				$( '#defaultDate' ).show();
				
				// Set up the weekly date picker control
				Weekly.setWeekPicker( $( '#defaultWeek' ), me.showRetrievelButton );


				// Monthly Select List populate and event set.
				Monthly.populateMonthYear( $( '#defaultMonth_Month' ), $( '#defaultMonth_Year' ) );


				// Set the Default Date as today
				me.setPeriod_DefaultDates( _today );


				// ------------------------
				// Events Related

				me.setPeriod_Events();


				// On Date picker Selection, enable/disable Populate button depending on chocies
				Util.setupDatePicker( $( '.defaultDatePicker' ), function() 
				{
					//me.performDataRetrieval();
					me.showRetrievelButton();
				} );				


				// On Month/Year selection, Populate Option Checkbox selectoin, enable/disable Populate button depending on chocies
				$( '#defaultMonth_Month, #defaultMonth_Year' ).change( function() 
				{
					//me.performDataRetrieval();

					me.showRetrievelButton();

					// Enable the populate button since date has been changed..
					//me.setStatus_PopulateButton();					
				});

			}


			me.setDefaultProgramTag_Change = function()
			{

				me.defaultProgramTag.change( function() 
				{
					me.programManager.resetSelectedProgram();

					me.defaultProgramNoteSpanTag.text( '' );

					me.resetSetting_PeriodAndBelow();

					var selectedProgramId = $( this ).val();
					me.programManager.setSelectedProgram( selectedProgramId );

					if( selectedProgramId == '' )
					{
						me.defaultProgramNoteSpanTag.text( '*Please select a program.' );
						Util.paintAttention( me.defaultProgramTag );

						//me.setStatus_PopulateButton();					
					}
					else
					{

						Util.paintClear( me.defaultProgramTag );
					
						me.setVisibility_Section( me.defaultDateRowTag, true );

						DialogLoading.openWithCallback( function()
						{ 

							var selectedProgram = me.TabularDEObj.getSelectedProgram();


							// Preload program stage data elements data before actual loading of events list.
							me.preloadProgramStageDataElementsData( selectedProgramId );


							// Store the person attributes of the program - to be placed in person table columns (th)
							me.retrieveProgramPersonAttributeData( selectedProgramId
								, function( programTrackedEntityAttributes )
								{
									me.defaultProgram_TEA_Manager.setProgramTrackedEntityAttributes( programTrackedEntityAttributes );
								
									// If the selected program does not have 
									if ( me.TabularDEObj.isCase_MEwR() && programTrackedEntityAttributes.length == 0 )
									{
										alert( $( 'span.msg_NoProgramAttributes' ).text() );
										Util.paintAttention( me.defaultProgramTag );
									}
									else
									{
										me.defaultProgramNoteSpanTag.text( '' );
										Util.paintClear( me.defaultProgramTag );

										// Reset PersonList Table Structure/Data and populate the header + one empty row..

										// Reset the list of person  <-- Default Program selection will do this instead.
										me.TabularDEObj.resetMainList();


										// Make the person Main section visible
										//me.setVisibility_MainSectionDiv( true );
									}


									//me.setStatus_PopulateButton();

									DialogLoading.close();

									//me.defaultProgramTag.focus();

									$( 'input:radio[name="period"]')[0].focus();

								}

							);
					

						});

					}
				});
			}


			me.setUp_SearchOptions_Change = function()
			{

				$( '#' + me.searchAllProgramTag.attr( 'id' ) 
					+ ', #' + me.programStatusListTag.attr( 'id' ) 
					+ ', #' + me.listAllPersonHistoricalEventsTag.attr( 'id' ) 
				).change( function() 
				{
					//me.showRetrievelButton();
					me.performDataRetrieval();
				});
			}


			me.performDataRetrieval = function()
			{
				me.resetMainDataRelated();
			
				if ( me.TabularDEObj.isCase_SEwoR() )
				{
					me.TabularDEObj.retrieveAndPopulateEvents( me.TabularDEObj.personList.personEvent.mainEventTableTag, function( eventFoundNo )
					{

						me.searchResultMsgRowTag.show();
						me.searchResultMessageTag.text( "Found " + eventFoundNo + " event(s) for period from " + $.format.date( me.getDefaultStartDate(), "dd/MM/yyyy" ) + " to " + $.format.date( me.getDefaultEndDate(), "dd/MM/yyyy" ) + " at " + me.orgUnitNameTag.val() );
						
					});

				}
				else
				{
					me.TabularDEObj.populatePersonData( function( personFoundNo )
					{
						me.searchResultMsgRowTag.show();
						me.searchResultMessageTag.text( "Found " + personFoundNo + " client(s) with at least one event for period from " + $.format.date( me.getDefaultStartDate(), "dd/MM/yyyy" ) + " to " + $.format.date( me.getDefaultEndDate(), "dd/MM/yyyy" ) + " at " + me.orgUnitNameTag.val() );		

					});
				}


				me.setVisibility_MainSectionDiv( true );
			
			}


			me.preloadProgramStageDataElementsData = function( programId )
			{
				// Run below to PRELOAD Data Elements of Stages before the actual person data retrieval.
				//	- Since Below has memory loading - remembers for the loaded data.
				var programStageList = me.programManager.getProgramStageList( programId );

				if ( programStageList !== undefined )
				{
					$.each( programStageList, function( i_programStage, item_programStage )
					{
						me.TabularDEObj.dataInMemory.retrieveProgramStageData_WithDataElementsAndOptionSets( item_programStage.id );
					});
				}
			}


			// --------------------------
			// On Init Setup Method	

			me.initialSetup = function()
			{				

				// Set OrgUnit Auto Selection
				me.setUp_OrgUnitAutoSelection( me.orgUnitNameTag );

				me.retrieveUserAccessOrgUnits( function()
				{
					me.orgUnitRowTag.show();
					Util.paintAttention( me.orgUnitNameTag );
					me.orgUnitNameTag.focus();
				});


				// Set Event for Default Program Change
				me.setDefaultProgramTag_Change();

				// Set Default Date Period Related Initial/Event Set
				me.setDefaultDatePeriod_Related();


				// Added new.
				me.executeRetrievalTag.click( function()
				{
					me.performDataRetrieval();

					// Scroll left end
					AppUtil.pageHScroll( "Left" );
				});


				me.setUp_SearchOptions_Change();
				
				me.setUp_OrgUnitMapClick();

				me.setUp_orgUnitTreePopup( me.onOrgUnitSelect );
			}

			// --------------------------
			// Run methods

			// Initial Setup Call
			me.initialSetup();
		}


		// -------------------------------------------
		// Class - DefaultProgram_TEA_Manager
		//	- Default Program Tracked Entity Attribues Manager

		function DefaultProgram_TEA_Manager()
		{
			var me = this;
			//me.TabularDEObj = TabularDEObj;
			me.TEAs = []; // Default Program TrackedEntityAttributes;


			// Program selected are handled/stored in ProgramManager

			me.getProgramTrackedEntityAttributes = function()
			{
				return me.TEAs;
			}

			me.setProgramTrackedEntityAttributes = function( attributes )
			{
				me.TEAs = attributes;
			}


			me.getFirstDisplayAttribute = function()
			{
				var firstAttribute;

				// For each person attributes, add the person table column
				$.each( me.TEAs, function( i_attribute, item_attribute )
				{					
					if ( item_attribute.displayInList )
					{
						firstAttribute = item_attribute;
						return false;
					}
				});

				// firstAttribute.id 				
				return firstAttribute;
			}

			me.getInDisplayListCount = function()
			{
				i_attributeCount = 0;

				// For each person attributes, add the person table column
				$.each( me.TEAs, function( i_attribute, item_attribute )
				{
					if ( item_attribute.displayInList )
					{
						i_attributeCount++;
					}
				});

				return i_attributeCount;
			}
		}


		// Class - SearchPanel
		// -------------------------------------------


		// -------------------------------------------
		// Class - ProgramManager
		//			- Populates programs, so that it always holds the list.
		//			- which can be used by program over and over again without retrieveing again.
		//			- Retrieve/save/get program Rules

		function ProgramManager( TabularDEObj, defaultProgramTag )
		{
			var me = this;
			me.TabularDEObj = TabularDEObj;
				
			me.programList;  // [ { id:"", name:"", programStageList:[ { id:"", name:"" } ] } ]  <-- also add rules and ruleVariables

			me.selectedProgram;
			me.selectedProgramId;

			me.defaultProgramTag = defaultProgramTag;

			// ----------------------------------
			// Functions

			/*
			me.getSelectedProgramId = function()
			{
				return me.defaultProgramId;
			}
			*/

			me.getDefaultProgramFromListed = function( programId )
			{
				var program;

				if ( Util.checkValue( programId ) && Util.checkValue( me.programList ) )
				{
					for( i = 0; i < me.programList.length; i++ )
					{
						if ( me.programList[i].id == programId )
						{
							program = me.programList[i];
							break;
						}
					}
				}

				return program;
			}

			me.resetSelectedProgram = function()
			{
				delete me.selectedProgramId;
				delete me.selectedProgram;
			}


			// Main program select (after orgUnit selection)
			me.setSelectedProgram = function( programId )
			{
				if ( programId == '' )
				{
					me.resetSelectedProgram();
				}
				else
				{
					me.selectedProgramId = programId;

					me.selectedProgram = me.getDefaultProgramFromListed( programId );

					// program Rules and Variables 
					me.TabularDEObj.programRule.RetrieveAndSet_ProgramRulesAndVariables( me.selectedProgram );
				}
			};


			me.getSelectedProgramType = function()
			{
				var programType;

				if ( me.selectedProgram !== undefined )
				{
					programType = me.selectedProgram.programType;
				}

				return programType;
			}

			me.isCase_MEwR = function()
			{
				var programType = me.getSelectedProgramType();

				if ( Util.checkDefined( programType ) )
				{
					if ( programType == "WITH_REGISTRATION" )
					{
						return true;
					}
				}

				return false;
			}

			me.isCase_SEwoR = function()
			{
				var programType = me.getSelectedProgramType();

				if ( Util.checkDefined( programType ) )
				{
					if ( programType == "WITHOUT_REGISTRATION" )
					{
						return true;
					}
				}

				return false;
			}


			me.populatePrograms = function( selectTag )
			{
				Util.populateSelect( selectTag, "Program", me.programList );
				//selectTag.val( me.defaultProgramId );
			}

			me.populateProgramStages = function( selectTag, programId )
			{
				Util.populateSelect( selectTag, "ProgramStage", me.getProgramStageList( programId ) );
				//selectTag.val( me.defaultProgramId );
			}
			
			me.getProgramStageList = function( programId )
			{
				var programStages;

				var programList = me.TabularDEObj.dataInMemory.getProgramList_Full();

				// if these is no list for thie programId, generate one and add to the list.
				for( i = 0; i < programList.length; i++ )
				{
					if( programList[i].id == programId )
					{
						programStages = programList[i].programStages;
						break;
					}
				}

				return programStages;
			}

			me.getProgramStageList_FromSource = function( programId, programList )
			{
				var programStages;

				// if these is no list for thie programId, generate one and add to the list.
				for( i = 0; i < programList.length; i++ )
				{
					if( programList[i].id == programId )
					{
						programStages = programList[i].programStages;
						break;
					}
				}

				return programStages;
			}


			me.getProgramList_Full = function()
			{
				// This should be done only after fully loaded or use call back method..
				return me.TabularDEObj.dataInMemory.getProgramList_Full();
			}

			me.getProgramStageList_Full = function()
			{
				return me.TabularDEObj.dataInMemory.getProgramStageList_Full();
			}

			me.getProgramStageData_ById = function( programStageId )
			{
				var programStage;

				var programStages = me.TabularDEObj.dataInMemory.getProgramStageList_Full();

				if ( Util.checkDefined( programStages ) )
				{
					$.each( programStages.programStages, function( i_ps, item_ps )
					{
						if ( item_ps.id == programStageId )
						{
							programStage = item_ps;
							return false;
						}
					});
				}

				return programStage;				
			}


			// -------------------------------------------
			// -- Retrieve Methods -----------------

			me.retrieveProgram_ProgramList = function( orgUnitId, populateFunc )
			{
				//var queryUrl = _queryURL_ProgramList + '?paging=false&fields=id,name,programType&';

				var queryUrl = _queryURL_OrgUnit + "/" + orgUnitId + ".json?fields=id,programs[id,name,programType]";


				RESTUtil.getAsynchData( queryUrl, function ( json_ProgramList )
				{
					QuickLoading.dialogShowAdd( 'programLoading' );

					var programList_Temp = [];

					if ( Util.checkDataExists( json_ProgramList.programs )  )
					{							
						me.TabularDEObj.dataInMemory.retrieveProgramListWithStage_Full( 
							function( json_programListWithStage_Full ) 
							{
								//console.log( 'got Stage and sets' );

								$.each( json_ProgramList.programs, function( i_program, item_program ) 
								{
									programList_Temp.push( { "id": item_program.id, "name":  item_program.name, "programType": item_program.programType, "programStages":  me.getProgramStageList_FromSource( item_program.id, json_programListWithStage_Full ) } );

									//console.log( 'adding programStage to program' );

								});
	
								QuickLoading.dialogShowRemove( 'programLoading' );

								populateFunc( Util.sortByKey( programList_Temp, "name" ) );
							} 
						);							
					}
					else
					{
						QuickLoading.dialogShowRemove( 'programLoading' );

						populateFunc( programList_Temp );
					}
				}
				, function() {}
				, function() { QuickLoading.dialogShowAdd( 'programLoading' ); }
				, function() { QuickLoading.dialogShowRemove( 'programLoading' ); }	
				);
			}


			// -- Retrieve Methods -----------------
			// -------------------------------------------


			me.loadProgramList = function( orgUnitId )
			{				

				// Reset the programId
				me.resetSelectedProgram();

				// Retrieve the orgUnit filtered program list and programStage list
				me.retrieveProgram_ProgramList( orgUnitId, function( returnData )
				{
					me.programList = returnData;
						
					me.populatePrograms( me.defaultProgramTag );

					Util.paintAttention( me.defaultProgramTag );					
				});				
			}


			// --------------------------
			// Run methods

			me.initialSetup = function( )
			{	
				me.TabularDEObj.dataInMemory.retrieveProgramListWithStage_Full( function() {} );
			}

			// Initial Setup Call
			me.initialSetup( );
		}


		// -------------------------------------------
		// Class - PersonList
		//		Add 'Person' class and 'Event' class to add all the related methods to them.
		//		* Should have created each person object instance.
		//			- Seperate by instance storage and presentation of each
		//		But for now, we keep the event info in each html row
		
		function PersonList( TabularDEObj )
		{
			var me = this;

			me.TabularDEObj = TabularDEObj;

			me._TEISearchMaxAllowed = 100;

			me.mainPersonTableTag =  $( '#mainTable_Person' );
			me.mainPersonSectionTag =  $( '#mainSection_Person' );

			me.personAddNewRowTag = $( '.person_addNewRow' );

			me.personDialogForm = new PersonDialogForm( me.TabularDEObj );

			me.personEvent = new PersonEvent( me.TabularDEObj, me.mainPersonTableTag );

			me.json_PersonList_EventDateChecked;

			me.attr_PersonRowNo = "personrowno";
			me.attr_doneStages = 'done_stages';

			me.trTemplate_PersonHeaderTr = "<tr class='trPersonHeader'>"
											+ "<th class='blank' width='23px'>&nbsp;</th>"
											+ "</tr>"; 
			
			me.trTemplate_PersonRow = "<td DEID='personDetailToggle'><input type='image' class='personRowDelete dimImgWHover' alt='Delete Row' title='Delete Row' src='img/cross.png' style='border: 0px solid;' /><a class='detailToggle' href='' style='display:none;'>[+]</a></td>";

			me.itemTemplate_PersonInputAndInfo = "<input type='text' class='personSelect jq_watermark' placeholder='" + l10n.get('searchOrAddPerson') + "' size='25' />"
									+ "<button type='button' class='personInfo button smallRoundButton' infoType='" + me.personDialogForm.type_New + "' style='display:none; margin:2px 4px 2px 3px; font-size: 11px;' ><span nameId='AddPerson'>" + l10n.get('addPerson') + "</span></button>"
									+ "<button type='button' class='personInfo button smallRoundButton' infoType='" + me.personDialogForm.type_Exist + "' style='display:none; margin:2px 4px 2px 3px; font-size: 11px;' ><span nameId='UpdatePerson'>" + l10n.get('updatePerson') + "</span></button>"
									+ "<span class='personEventCountSec' style='display:none;color:#CCCCCC;font-size:9px;'>&nbsp;<span class='personEventCount'></span></span>";

			me.trTemplate_PersonDetail = "<td class='blank' colspan='0'></td>";

			me.trGeneratedTemplate = "";

			me.personSearchRequests = [];


			// ----------------------------------
			// Functions

			me.hideMainSections = function()
			{
				me.mainPersonSectionTag.hide();
				me.personEvent.mainEventSectionTag.hide();
			}

			me.showMainSection = function()
			{
				if ( me.TabularDEObj.isCase_MEwR() )
				{
					me.mainPersonSectionTag.show( 200 );
				}
				else if ( me.TabularDEObj.isCase_SEwoR() )
				{
					me.personEvent.mainEventSectionTag.show( 200 );
				}
			}


			me.resetMainList = function()
			{
				if ( me.TabularDEObj.isCase_MEwR() )
				{
					me.resetPersonList();
				}
				else if ( me.TabularDEObj.isCase_SEwoR() )
				{
					me.personEvent.resetEventList();
				}
			}

			me.clearPersonList = function( tableTag )
			{
				me.clearPersonTableRows( tableTag );

				// even clear headers - since we need to regenerate based on changed program attributes (displayed ones)
				tableTag.find( "tr" ).remove();
			}


			me.resetPersonList = function()
			{
				me.clearPersonList( me.mainPersonTableTag );

				// Remove the saved Tr Template
				me.trGeneratedTemplate = "";

				// Add Header 
				me.createPersonTableHeaders( me.TabularDEObj.getProgramTrackedEntityAttributes() );

				me.addInitialRow();
			}

			me.clearPersonTableRows = function( tableTag )
			{
				// Clear all the person list & their events
				tableTag.find( ".tbStyle_PersonDetail" ).remove();
				tableTag.find( "tr.trPerson, tr.trPersonDetail" ).remove();  // since we now have dynamic header
			}

			me.addInitialRow = function()
			{
				// TODO: call this method from a class...
				// Initial first blank row add
				me.addNewLastRow_Person( me.mainPersonTableTag );
			}

			me.getNewPersonRowCount = function( mainPersonTable )
			{
				var rowCount;

				var lastPersonRow = mainPersonTable.find( "tr.trPerson:last" );

				if ( lastPersonRow.length == 0 )
				{
					rowCount = 1;
				}
				else
				{
					var rowCount = parseInt( lastPersonRow.attr( me.attr_PersonRowNo ) ) + 1;
				}

				return rowCount;
			}


			// ---------
			// Set Person Table Header/Row/Data Related

			me.createPersonTableHeaders = function( programTrackedEntityAttributes )
			{
				
				me.mainPersonTableTag.append( me.trTemplate_PersonHeaderTr );

				var personTableHeader = me.mainPersonTableTag.find( 'tr.trPersonHeader' );

				var i_attributeCount = 0;

				// For each person attributes, add the person table column
				$.each( programTrackedEntityAttributes, function( i_attribute, item_attribute )
				{
					if ( item_attribute.displayInList )
					{
						personTableHeader.append( "<th class='orig' type='header_attribute_" + i_attributeCount + "' attributeid='" + item_attribute.id + "'>" + item_attribute.name + "</th>" );
						// "' style='max-width: 140px;'

						i_attributeCount++;
					}
				});


				// Add the last org info - the org the person belongs to. ID gets populated later
				personTableHeader.append( "<th class='orig' type='homeUnit' orguintid=''>" + l10n.get('homeUnit') + "</th>" );
			}


			me.createPersonTableRows = function( mainPersonTable, programTrackedEntityAttributes )
			{
				var trString = "";

				if ( Util.checkValue( me.trGeneratedTemplate ) )
				{
					trString = me.trGeneratedTemplate;
				}
				else
				{
					trString = me.trTemplate_PersonRow;

					var i_attributeCount = 0;

					// For each person attributes, add the person table column
					$.each( programTrackedEntityAttributes, function( i_attribute, item_attribute )
					{
						
						if ( item_attribute.displayInList )
						{

							var tdStr = "";

							if ( i_attributeCount == 0 )
							{
								tdStr = "<td type='attribute_" + i_attributeCount + "' attributeid='" + item_attribute.id + "' style='white-space: nowrap;' class='tdPersonInfo'>" + me.itemTemplate_PersonInputAndInfo + "</td>";

								// Enter text here for search or ...
							}
							else
							{
								tdStr = "<td type='attribute_" + i_attributeCount + "' attributeid='" + item_attribute.id + "' class='tdPersonInfo'></td>";
							}
							
							trString += tdStr;

							i_attributeCount++;
						}
					});


					// Add the last org info - the org the person belongs to. ID gets populated later
					trString += "<td type='homeUnit'></td>" ;

					me.trGeneratedTemplate = trString;
				}


				// Append the generated Tr info - * Use 'document.createElement()' to speed up.
				mainPersonTable.append( $( document.createElement( "tr" ) ).attr( 'class', 'trPerson' ).attr( 'done_stages', '' ).append( trString ) );
				
				
				var lastPersonRow = mainPersonTable.find( 'tr.trPerson:last' );

				// Add row delete event handler
				
				lastPersonRow.find( '.personRowDelete').click( function() 
				{
					var trCurrent = $( this ).closest( 'tr' );

					// Actually, this does not exists..
					var nextFocusTag = trCurrent.next( 'trPerson' );// Util.getNextRowFocus_Person( trCurrent );

					Util.setRowRemoval( trCurrent );

					( nextFocusTag.length == 1 ) ? nextFocusTag.focus() : me.personAddNewRowTag.focus();

					// Scroll to the bottom.
					$('html, body').scrollTop( $(document).height() );

				});

				return lastPersonRow;
			}


			me.populatePersonAttirbutesToRow = function( trCurrent, attributes )
			{
				if ( attributes !== undefined )
				{

					$.each( attributes, function( i_attribute, item_attribute )
					{

						var currentTd = trCurrent.find( "td[attributeid='" + item_attribute.attribute + "']" );

						if ( currentTd.length > 0 )
						{
							var inputField = currentTd.find( 'input' );

							var attributeValue = FormUtil.getFormattedAttributeValue( item_attribute );

							if ( inputField.length > 0 )
							{
								inputField.val( attributeValue );
							}
							else
							{
								// TODO: Need to get the display value of each attribue..
								currentTd.html( '<span>' + attributeValue + '</span>' );
							}
						}
						
					});
				}
			}

			// Set Person Table Header/Row/Data Related
			// ---------


			// -- Row Manipulation (Add/Remove) ----
			me.addNewLastRow_Person = function( mainPersonTable )
			{
				var newRowCount = me.getNewPersonRowCount( mainPersonTable );

				// Add 2 Rows (Person + PersonDetail)
				// Person Row Add
				var trCurrent = me.addPersonRow( mainPersonTable, newRowCount );

				// --- Set events ---
				me.personAutoSelection( trCurrent.find( '.personSelect' ) );
				
								
				// Person Detail Row Add - empty row		
				var trPersonDetail = me.addPersonDetailRow_Empty( mainPersonTable, trCurrent );

				return trCurrent;
			}


			me.addPersonRow = function( mainPersonTable, newRowCount )
			{
				
				var lastPersonRow = me.createPersonTableRows( mainPersonTable, me.TabularDEObj.getProgramTrackedEntityAttributes() );

				lastPersonRow.attr( me.attr_PersonRowNo, newRowCount );

				// Add dialog click event
				lastPersonRow.find( ".personInfo" ).hide().click( function() {
					me.personInfoPopup( $( this ) );
				});

				return lastPersonRow;
			}


			me.personInfoPopup = function( personInfoTag, afterSaveAction )
			{
				// Check the Default Program selection.
				// For new user case, alert if not selected
				var formType = personInfoTag.attr( "infoType" );

				var trCurrent = personInfoTag.closest("tr");
				var defaultProgramId = me.TabularDEObj.getSelectedProgramId();

				if ( formType == me.personDialogForm.type_New && !Util.checkValue( defaultProgramId ) )
				{
					// If the person form Type is 'New', but default Program is not selected,
					// Ask users to select one.
					alert( $( 'span.msg_SelectDefaultProgram' ).text() );
				}
				else
				{
					DialogLoading.openWithCallback( function()
					{ 								
						me.personDialogForm.openForm( trCurrent, formType, function()
						{
							DialogLoading.close();
						}
						, function()
						{
							if ( afterSaveAction !== undefined ) afterSaveAction();							
						});
					}
					);
				}
			}


			me.addPersonDetailRow_Empty = function( mainPersonTable, trPerson )
			{
				mainPersonTable.append( $( document.createElement( "tr" ) ).attr( 'class', 'trPersonDetail' ).attr( 'style', 'display:none;' ).append( me.trTemplate_PersonDetail ) );


				var personDetailRowCurrent = mainPersonTable.find( 'tr.trPersonDetail:last' );

				var personTableColumnNo = me.TabularDEObj.getInDisplayListCount() + 2;

				personDetailRowCurrent.find( 'td.blank' ).attr( 'colspan', personTableColumnNo );


				return personDetailRowCurrent;
			}


			// Functions
			// ----------------------------------


			// -- Person Auto Selected Related -------------------
			// ---------------------------------------------------

			me.personAutoSelection = function( el )
			{
				var trPersonTable = el.closest( "table" );
				var trCurrent = el.closest( "tr.trPerson" );

				el.autocomplete( {
					source: 
						function( request, response ) 
						{
							me.clearColor_duplicatePersonWarning( trPersonTable );

							// Clear the info
							me.setPersonInfoRow( trCurrent );

							// Hide the person detail row if expanded.
							Util.toggleTarget( trCurrent.find( '.detailToggle' ), trCurrent.next(), false );

							me.personSearchRequests = FormUtil.abortAndClear_XhrRequest( me.personSearchRequests );

							var json_persons_new = new Array();


							if ( request.term.length >= 2 )
							{
								var attribute0_id = me.getAttributeIdIfExists( trCurrent, 'attribute_0' );
								var attribute1_id = me.getAttributeIdIfExists( trCurrent, 'attribute_1' );

								if ( !Util.checkValue( attribute0_id ) ) 
								{
									el.removeClass( "ui-autocomplete-loading" );

									alert( $( 'span.msg_ProgramAttributeAtLeast' ).text() );
								}
								else
								{
									// ou Added for the limited feature..
									var requestUrl = _queryURL_PersonQuery + ".json?filter=" + attribute0_id + ":LIKE:" + request.term + "&ouMode=DESCENDANTS&ou=" + me.TabularDEObj.searchPanel.getCountryId();

									// Step 0. Check the search count first!!
									me.checkSearchMaxLimit( requestUrl, function( pass ) {

										if ( !pass )
										{
											el.removeClass( "ui-autocomplete-loading" );

											response( json_persons_new );
										}
										else
										{
											requestUrl += '&skipPaging=true';

											// Step 1. Search Person  --- TODO: do the loading message?
											var xhr_personSearch = RESTUtil.getAsynchData( requestUrl
											, function( json_Persons )
											{
												if( json_Persons.trackedEntityInstances !== undefined )
												{
													$.each( json_Persons.trackedEntityInstances, function( i, item_Person ) 
													{
														var attribute_first = Util.getFromList( item_Person.attributes, attribute0_id, "attribute" );

														var attributesLongDesc = attribute_first.value; 

														if ( Util.checkValue( attribute1_id ) ) 
														{
															var attribute_second = Util.getFromList( item_Person.attributes, attribute1_id, "attribute" );

															if ( attribute_second !== undefined )
															{
																attributesLongDesc += ', ' + attribute_second.value;
															}
														}

														json_persons_new.push( { "id": item_Person.trackedEntityInstance, "label": attributesLongDesc, "value": attribute_first.value } );

													});
												}
												
												response( Util.sortByKey( json_persons_new, 'label', true ) );
											}
											, function() {}
											, function() {}
											, function() { el.removeClass( "ui-autocomplete-loading" ); }
											);

											me.personSearchRequests.push( xhr_personSearch );
										}	
									});
								}	
							}
							else
							{
								el.removeClass( "ui-autocomplete-loading" );

								response( json_persons_new );
							}
						}
					,minLength: 0
					,delay: 800
					,select: 
						function( event, ui ) {

							el.removeClass( "ui-autocomplete-loading" );
							el.autocomplete( "close" );

							if( me.checkPersonExistInList( ui.item.id, el, trPersonTable ) )
							{
								$( this ).val( '' );
								return false;
							}
							else
							{
								DialogLoading.openWithCallback( 
									function()
									{ 
										me.getPersonById( ui.item.id, function( item_Person )
										{
											me.setPersonInfoRow( trCurrent, item_Person );

											me.populateAndSet_PersonDetailSection( trCurrent, trCurrent.next(), item_Person );

											DialogLoading.close();

											// Open up the Detail Part
											Util.toggleTarget( trCurrent.find( '.detailToggle' ), trCurrent.next() );
										});											
									}
								);
							}
						}
				} );
			}


			me.checkSearchMaxLimit = function( requestUrl, successFunc )
			{
				requestUrl += "&skipPaging=false&pageSize=1&totalPages=true&fields=trackedEntityInstance";

				RESTUtil.getAsynchData( requestUrl, function( jsonData )
				{
					if ( jsonData.pager !== undefined && jsonData.pager.total !== undefined )
					{
						var totalCount = jsonData.pager.total;

						if ( totalCount > me._TEISearchMaxAllowed )
						{
							alert( 'The search found too many result: ' + totalCount + ' (Max ' + me._TEISearchMaxAllowed + ').  Please add more detail to the search.' );
							successFunc( false );
						}
						else
						{
							successFunc( true );
						}
					}

				});
			}


			me.getPersonById = function( personId, execFunc )
			{
				PersonUtil.getPersonByID_Reuse( personId, function( item_person )
				{
					execFunc( item_person );
				});
			}


			me.getPerson_WithDoneStage = function( personId, execFunc )
			{
				PersonUtil.getPersonByID_Reuse( personId, function( item_person )
				{
					me.retrieveAndSetDoneProgramStages( item_person, function()
					{
						execFunc( item_person );
					});
				});
			}

			me.checkPersonExistInList = function( personId, currentInputTag, tableTag )
			{
				var existsAlready = false;

				var foundPersonTrTag = tableTag.find( 'tr.trPerson[uid="' + personId + '"]' );

				if ( foundPersonTrTag.length > 0 )
				{
					//Util.paintWarning( currentInputTag );
					Util.paintAttention( foundPersonTrTag.find( 'input.personSelect' ) );

					alert( $( 'span.msg_SamePersonInList' ).text() );

					existsAlready = true;
				}

				return existsAlready;
			}


			me.clearColor_duplicatePersonWarning = function( tableTag )
			{
				Util.paintClear( tableTag.find( 'input.personSelect' ) );
			}


			me.getAttributeIdIfExists = function( trCurrent, attributeNo )
			{
				var attributeId = '';

				var tdAttribute = trCurrent.find( "td[type='" + attributeNo + "']" );
				if ( tdAttribute.length == 1 )
				{
					attributeId = tdAttribute.attr( 'attributeid' );
				}
				
				return attributeId;
			}

			me.getAttributeValueById = function( attributes, attributeId )
			{
				var attributeValue = "";

				for (i = 0; i < attributes.length ;i++ )
				{
					if ( attributes[i].attribute == attributeId )
					{
						attributeValue = FormUtil.getFormattedAttributeValue( attributes[i] );

						break;
					}
				}

				return attributeValue;
			}

			me.getHeaderAttributeIndex = function( headers, attributeId )
			{
				var foundIndex;

				if ( attributeId != "" )
				{
					for ( i = 0; i < headers.length; i++ )
					{
						if ( headers[i].name == attributeId )
						{
							foundIndex = i;
							break;
						}
					}
				}

				return foundIndex;
			}



			me.setPersonInfoRow = function( trCurrent, item_Person )
			{

				// Initialize person event count
				me.setPersonEventCount( trCurrent );

				// Hide the buttons and images
				trCurrent.find( ".personInfo" ).hide();


				if( Util.checkDefined( item_Person ) )
				{
					var personId = item_Person.trackedEntityInstance;

					trCurrent.attr( 'uid', personId );
					trCurrent.next().attr( 'uid', personId );

					// set 'doneStage' attribute data
					if ( item_Person.doneStages !== undefined )
					{
						trCurrent.attr( me.attr_doneStages, item_Person.doneStages );
					}


					// Display Person Info Image Button
					trCurrent.find( ".personInfo[infoType='" + me.personDialogForm.type_Exist + "']" ).show();


					// Populate the person Attribute info.
					me.populatePersonAttirbutesToRow( trCurrent, item_Person.attributes );


					// Set person Home Unit - org Unit
					if ( Util.checkDefined( item_Person.orgUnit ) )
					{
						me.TabularDEObj.dataInMemory.retrieveOrgUnitName( item_Person.orgUnit, function( json_OrgUnit )
						{
							trCurrent.find( "td[type='homeUnit']" ).text( json_OrgUnit.name );
						});
					}


					// Hide row delete
					trCurrent.find( '.personRowDelete' ).hide();

					var trDetailRow = trCurrent.next();
				

					// When toggling anchor, show/hide the event list
					trCurrent.find( '.detailToggle' ).show().off( 'click' ).click( function() {
						
						Util.toggleTarget( $( this ), trDetailRow );


						// If event section is not setup/populated, create Table and load data, event setup
						var populateStatus = trDetailRow.attr( 'populateStatus' );

						// If it is not populated already, add table and populate event
						if ( !( Util.checkValue( populateStatus ) && populateStatus == 'Y' ) )
						{	
							// Populate table.
							me.populateAndSet_PersonDetailSection( trCurrent, trDetailRow, item_Person );
						}
						
						return false;
					} );


					// Set up the event count on the row
					if ( Util.checkDefined( item_Person.eventRows ) )
					{
						me.setPersonEventCount( trCurrent, item_Person.eventRows.length );
					}

					/*
					// TODO: Currently do not use this, but when opening the events, we need to use this?
					if( Util.checkDefined( json_Events_Data ) )
					{
						me.personEvent.populateEvents( trCurrent, trDetailRow.find( ".tbStyle_PersonDetail" ), json_Events_Data );
					}
					*/

				}
				else
				{
					// Clear person data
					// Attributes
					trCurrent.find( "td[type^='attribute_']" ).each( function()
					{
						var tdTag = $( this );
						if ( tdTag.attr( 'type' ) != 'attribute_0' )
						{
							tdTag.text( '' );
						}
					});

					// Remove 'doneStage' data
					trCurrent.attr( me.attr_doneStages, '' );

					trCurrent.attr( 'uid', '' );

					// Home Unit
					trCurrent.find( "td[type='homeUnit']" ).text( '' );


					if( trCurrent.find( ".personSelect" ).val() != "" )
					{
						trCurrent.find( ".personInfo[infoType='" + me.personDialogForm.type_New + "']" ).show();
					}


					// Show row delete
					trCurrent.find( ".personRowDelete" ).show();

					// Add Person Detail Toggle Anchor
					trCurrent.find( ".detailToggle" ).hide();
					
					// Add Event to the created toggle anchor
					//trCurrent.find(".detailToggle").click( personDetailToggle );
				}
			}


			me.setPersonEventCount = function( trPersonRow, count )
			{
				var personEventCountSecTag = trPersonRow.find( '.personEventCountSec' );
				var personEventCountTag = trPersonRow.find( '.personEventCount' );

				if ( count === undefined )
				{
					// Initialize
					personEventCountSecTag.hide();
					personEventCountTag.text( '' );
				}
				else
				{
					// Initialize
					personEventCountSecTag.show();
					personEventCountTag.text( count ).attr( 'title', 'Event Count' );
				}
			}


			me.populateAndSet_PersonDetailSection = function( trPersonRow, trDetailRow, item_Person )
			{
				var tdDetailSection = trDetailRow.find( 'td.blank' );
				var personId = item_Person.trackedEntityInstance;


				tdDetailSection.html( '' ).append( "<div class='divPersonDetail'><table class='tbStyle_PersonDetail'>"
											+ "<tr class='trEventHead'>"
												+ "<th class='orig'><span nameId='EventTableHeader_Date_OrgUnit'>" + l10n.get('dateOrgunit') + "</span></th>"
												+ "<th class='orig'><span nameId='EventTableHeader_Program_Stage'>" + l10n.get('programAndStage') + "</span></th>"
												+ "<th class='orig' align='center'><span nameId='EventTableHeader_Status'>" + l10n.get('status') + "</span></th>"
												+ "<th class='orig' type='delete'>&nbsp;</th>"
											+ "</tr>"
										+ "</table>"
										+ "<div class='divAddEvent' style='margin:2px 1px 4px 20px;'><span><button type='button' class='personEvent_addNewRow BlueButton' style='display:none; font-size:11px;'><span nameId='AddNewEventRow'>" + l10n.get('addEvent') + "</span></button></span><span style='width:24px;'>&nbsp;</span></div></div>" );


				var tbEvent = trDetailRow.find( '.tbStyle_PersonDetail' );
				var addNewEventRowButton = trDetailRow.find( '.personEvent_addNewRow' );


				// Set events on Person Detail seciton
				me.setEvents_PersonDetailRow( trPersonRow, tbEvent, addNewEventRowButton );


				// Populate the event data..
				var divPersonDetailTag = tdDetailSection.find( '.divPersonDetail' );
				

				me.personEvent.populateEventsByPersonId( personId, trPersonRow, divPersonDetailTag, function( json_Events )
				{
					
					// Show 'Add new event' button if Active program
					if ( me.TabularDEObj.getSearchProgramStatus() == _status_ACTIVE )
					{
						addNewEventRowButton.show();
					}

					// * After populating event data, Set 'DoneStage'
					me.setDoneStageRelated( item_Person, trPersonRow, function( doneStages )
					{
						// For already populated events case, if there is 'add new'
						// row added, remove the stage.
						me.personEvent.removeFromStageList( divPersonDetailTag.find( 'select.eventStage' ), doneStages );					
					});


					// Set event count update
					me.setPersonEventCount( trPersonRow, json_Events.length );

				});	

				// Set as populated
				trDetailRow.attr( 'populateStatus', 'Y' );			
			}


			// ------ Done Stages Related - BEGIN ------

			me.setDoneStageRelated = function( item_Person, trPersonRow, execFunc )
			{
				var divAddEvent = trPersonRow.next().find( ".divAddEvent" );

				// Disable the row 'add Event' button.. Initially..
				FormUtil.setTagAsWait( divAddEvent );

				// For Person, do event search for 'done' program stage (for non-repeatable)
				me.retrieveAndSetDoneProgramStages( item_Person, function()
				{
					if ( item_Person.doneStages !== undefined )
					{
						trPersonRow.attr( me.attr_doneStages, item_Person.doneStages );
					
						execFunc( trPersonRow.attr( me.attr_doneStages ) );
					}

					// Enable the row 'add Event' button..
					FormUtil.setTagAsWait_Clear( divAddEvent );
				});
			}

			me.addTo_DoneStage = function( trPersonRow, stageId )
			{
				var doneStages_Existing = trPersonRow.attr( me.attr_doneStages );
				
				if ( doneStages_Existing === undefined )
				{
					trPersonRow.attr( me.attr_doneStages, stageId + ';' );
				}
				else
				{
					trPersonRow.attr( me.attr_doneStages, doneStages_Existing + stageId + ';' );
				}
			}


			// ------ Done Stages Related - END ------


			me.setEvents_PersonDetailRow = function( trPerson, tbEvent, addNewEventRowButton )
			{
				
				//me.personEvent.addNewLastRow_Event( trPerson, tableCurrent, me.TabularDEObj.getSelectedProgramId() );

				// Set event handler for 'add new event row' button
				addNewEventRowButton.click( function() 
				{ 
					var eventDate = me.personEvent.addNewLastRow_Event( trPerson, tbEvent, me.TabularDEObj.getSelectedProgramId() );

					eventDate.focus();
				});
			}


			// -----
			// Populate Person Method.

			me.populatePersonData = function( returnFunc )
			{
				var tableTag = me.mainPersonTableTag;

				// Step 1. Clear the person/event data table
				me.clearPersonTableRows( tableTag );

					
				// Step 2. Retrieve person and events.
				me.TabularDEObj.retreivePersonListWithEvents( function( json_PersonEventsList )
				{

					// If there were no event, simply add one empty row.
					if ( json_PersonEventsList.length == 0 )
					{
						me.addNewLastRow_Person( tableTag );
						returnFunc( 0 );
					}
					else
					{
						// Retrieve each person information, sort them by first attribute, and display as person row.

						// Step 3. Sort the person by the first attribute
						var firstAttribute = me.TabularDEObj.getFirstDisplayAttribute();

						PersonUtil.setPersonWithFirstAttributeData( json_PersonEventsList, firstAttribute.id );


						var personEventObjList_Sorted = Util.sortByKey( json_PersonEventsList, PersonUtil.primaryAttributeVal, true );


						// Step 4. With person and person events within it, popuplate/display person only.
						$.each( personEventObjList_Sorted, function( i_person, item_person ) 
						{
							var trPersonLast = me.addNewLastRow_Person( tableTag );

							me.setPersonInfoRow( trPersonLast, item_person );

						});


						// Last emtpy row add
						me.addNewLastRow_Person( tableTag );
							
						returnFunc( personEventObjList_Sorted.length );
						
					}
				}
				, function( failed_Message )
				{
					returnFunc( 0 );

					alert( $( 'span.msg_EventRetrievalFailed' ).text() + '\n\n Error: ' + JSON.stringify( failed_Message ) );
				});
			}

			/*
			me.updatePersonWithDetails = function( json_PersonEventsList, execFunc )
			{
				var personTotal = json_PersonEventsList.length;
				var count = 0;

				$.each( json_PersonEventsList, function( i_person, item_person ) 
				{
					PersonUtil.getPersonByID_ReuseReload( item_person.trackedEntityInstance
					, function( json_Person )
					{
						Util.copyProperties( json_Person, item_person );
					}
					, function() {}
					, DialogLoading.open
					, function() 
					{
						DialogLoading.close();

						count++;

						if ( count == personTotal )
						{
							execFunc( json_PersonEventsList );
						}						
					}
					);
				});
			}*/

			/*
			me.retrievePersonAndPopulateInfo = function( personRowsTag, personCount )
			{
				personRowsTag.each( function( i )
				{
					var trPersonTag = $( this );
					var personUid = trPersonTag.attr( 'uid' );

					if ( Util.checkValue( personUid ) )
					{
						PersonUtil.getPersonByID_ReuseReload( personUid
						, function( json_Person )
						{
							if ( Util.checkDefined( json_Person ) ) 
							{
								// Populate the row with person obj.
								me.setPersonInfoRow( trPersonTag, json_Person );

								FormUtil.setTagAsWait_Clear( trPersonTag );
							}
						}
						, function() 
						{
							console.log( 'Failed to retrieve person data: ' + personUid );
						}
						);
					}

				});
			}
			*/


			// -- Person Auto Selected Related -------------------
			// ---------------------------------------------------

			me.checkProgramEnroll = function( personId, programId, orgUnitId, enrolledAction, notEnrolledAction )
			{
				// Check Enrollment first. //'&ou=' + orgUnitId
				RESTUtil.getAsynchData( _queryURL_ProgramEnrollmentQuery + '?trackedEntityInstance=' + personId + '&program=' + programId + '&ouMode=ALL'
					, function( json_ProgramEnrollment ) 
					{ 
						if ( Util.checkDefined( json_ProgramEnrollment ) 
							&& Util.checkDataExists( json_ProgramEnrollment.enrollments ) )
						{

							if ( Util.checkData_WithPropertyVal( json_ProgramEnrollment.enrollments, "status", _status_ACTIVE ) )
							{
								enrolledAction();
							}
							else
							{
								if ( me.TabularDEObj.getSelectedProgram().onlyEnrollOnce )
								{
									alert( $( 'span.msg_CanNotEnrol_PreviousEnroll' ).text() );
								}
								else
								{
									notEnrolledAction();
								}
							}
						}
						else
						{
							notEnrolledAction();
						}
					}
					, notEnrolledAction
				);
			}

			me.programEnroll = function( personId, programId, orgUnitId, eventDateInFormat, successAction, failAction )
			{
				// Enroll the user
				var json_Enroll = { "trackedEntityInstance": personId, "orgUnit": orgUnitId, "program": programId, "enrollmentDate": eventDateInFormat } //, "dateOfIncident": eventDateInFormat };

				RESTUtil.submitData( json_Enroll, _queryURL_ProgramEnrollmentSubmit, "POST"
					, function( returnData )
					{
						if ( successAction !== undefined ) successAction( returnData );
					}
					, function( returnData )
					{
						if ( failAction !== undefined ) failAction( returnData );
					}
				);
			}

			me.retrieveAndSetDoneProgramStages = function( item_person, execFunc )
			{
				// If the person has non-repeatable stages that are 'done', 
				// mark the stage, so that this person can not add that stage anymore.

				var programStageList = me.TabularDEObj.getProgramStageList( me.TabularDEObj.getSelectedProgramId() );

				var deferredArrActions_checkStages = [];

				$.each( programStageList, function( i_programStage, item_programStage )
				{
					if ( !item_programStage.repeatable )
					{
						deferredArrActions_checkStages.push( 
							RESTUtil.getAsynchData( me.TabularDEObj.getEventQueryBaseUrl() 
								+ '&programStage=' + item_programStage.id 
								+ '&trackedEntityInstance=' + item_person.trackedEntityInstance
							, function( eventsRetrieved )
							{
								if ( Util.checkValue( eventsRetrieved.events ) ) 
								{
									if ( item_person.doneStages === undefined )
									{
										item_person.doneStages = item_programStage.id + ";";
									}
									else
									{
										item_person.doneStages += item_programStage.id + ";";
									}
								}
							}
							, function() 
							{ 
								console.log( 'Failed - On retrieveAndSetDoneProgramStages.  Stage: ' + item_programStage.id + ', TrackedEntityInstance: ' + item_person.trackedEntityInstance ); 
							} ) );	
					}
				});
					

				$.when.apply($, deferredArrActions_checkStages ).then( function( ) 
				{
					execFunc();
				});		
			}


			me.setupAddNewPersonRow = function()
			{
				me.personAddNewRowTag.click( function() 
				{
					var trPersonLast = me.addNewLastRow_Person( me.mainPersonTableTag );

					trPersonLast.find( '.personSelect' ).focus();
				});
			}

			// Initial Setup Call
			me.initialSetup = function()
			{				
				me.setupAddNewPersonRow();
			}

			// --------------------------
			// Run methods

			// Initial Setup Call
			me.initialSetup();
		}

		// PersonList Class
		// -------------------------------------------


		// -------------------------------------------
		// Class - PersonEvent

		function PersonEvent( TabularDEObj, mainPersonTableTag )
		{
			var me = this;

			me.TabularDEObj = TabularDEObj;

			me.mainPersonTableTag =  mainPersonTableTag;

			me.mainEventTableTag =  $( '#mainTable_Event' );
			me.mainEventSectionTag =  $( '#mainSection_Event' );


			me.attr_EventRowNo = "eventrowno";


			me.buttonTemplate_Complete = "<button type='button' class='button eventComplete' style='display:none;'><span nameId='CompleteEvent'>" + l10n.get('complete') + "</span></button><button type='button' class='button eventIncomplete' style='display:none;'><span nameId='IncompleteEvent'>" + l10n.get('incomplete') + "</span></button>";


			me.trTemplate_EventRow = "<td class='orig'><input type='text' class='eventDate datepicker' caltype='upToToday' size='12'><br><span class='eventOrgUnit'></span></td>"
				+ "<td class='orig'><div><select class='eventProgram' style='margin: 1px 1px;display:none;' />"
					+	"<div class='eventProgramDiv divReadOnly'></div></div>"
					+	"<div><select class='eventStage' style='margin: 1px 1px;'/><div class='eventStageDiv  divReadOnly'></div></div><div><button class='eventCreate button smallRoundButton' style='font-size: 10px;' >&nbsp;&nbsp;<span nameId='CreateEvent' style='font-size: 10px;'>Create</span>&nbsp;&nbsp;</button></div></td>"
				
				+ "<td class='orig' align='center'><span class='eventStatus' style='font-size: 11px;'></span></td>"
				//	+ "<div>" + me.buttonTemplate_Complete + "</div></td>"

				+ "<td class='orig tdEventDelete'><input type='image' class='eventRowDelete dimImgWHover' alt='Delete Row' title='Delete Row' src='img/cross.png' style='border: 0px solid;' /><input type='image' class='eventDelete dimImgWHover' alt='Delete Event' title='Delete Event' src='img/cross.png' style='display:none; border: 0px solid;' /></td>";

			me.AttributeControlsTemplate = "<input type='text' class='datepicker' style='display:none;' size='11' /><input class='textbox' style='display:none;' type='text' size='25' height='20px' /><textarea class='textarea' style='display:none;' cols='15' rows='2'></textarea><input class='checkbox' style='display:none;' type='checkbox' /><select class='dropdown' style='display:none;'><option value=''>Select Value</option></select><span class='label' style='display:none;'></span>";  
			// Should use separate for 'AttributeControl'
			// Larger Text fields, etc..

			me.thTemplate_CompleteButton = "<th class='added' colcount='' type='completed_button'>&nbsp;</th>";
			me.tdTemplate_CompleteButton = "<td class='added' type='completed_button' colcount=''>" + me.buttonTemplate_Complete + "</td>";


			// ======================
			// Methods

			// ----------------------
			// Public Getters

			me.getAttrControlsTemplate = function()
			{
				return me.AttributeControlsTemplate;
			}


			// Public Getters
			// ----------------------

			// ----------------------------------------------------------------------
			// Event List without Person List related

			me.clearEventList = function()
			{
				me.mainEventTableTag.find( "tr.trEventData" ).remove();
				me.mainEventTableTag.find( "tr.trEventHead th.added" ).remove();
			}

			me.resetEventList = function( )
			{
				me.clearEventList();

				me.addNewLastRow_Event( undefined, me.mainEventTableTag, me.TabularDEObj.getSelectedProgramId() );


				me.mainEventSectionTag.find( '.personEvent_addNewRow' ).off( 'click' ).on( 'click', function() 
				{ 
					var eventDate = me.addNewLastRow_Event( undefined, me.mainEventTableTag, me.TabularDEObj.getSelectedProgramId() );

					eventDate.focus();
				});
			}

			// Event List without Person List related
			// ----------------------------------------------------------------------


			me.getNewPersonEventRowCount = function( tableCurrent )
			{
				var rowCount;

				var lastRow = tableCurrent.find( "tr.trEventData:last" );

				if ( lastRow.length == 0 )
				{
					rowCount = 1;
				}
				else
				{
					var rowCount = parseInt( lastRow.attr( me.attr_EventRowNo ) ) + 1;
				}

				return rowCount;
			}


			me.setEventCreateButtonEnable = function( trCurrent )
			{
				var eventDate = trCurrent.find( ".eventDate" );
				var eventStage = trCurrent.find( ".eventStage" );
				var eventCreateTag = trCurrent.find( ".eventCreate" );

				// Disable the button initially
				Util.disableTag( eventCreateTag, true );
		
				if ( Util.checkCalendarDateStrFormat( eventDate.val() ) )
				{
					if ( me.TabularDEObj.isCase_SEwoR() || eventStage.val() != '' )
					{
						Util.disableTag( eventCreateTag, false );
					}
				}
			}


			me.addNewLastRow_Event = function( trPerson, tableCurrent, programId )
			{
				var newRowCount = me.getNewPersonEventRowCount( tableCurrent );

				// Person Row Add
				var trCurrent = me.addEventRow( newRowCount, tableCurrent );
				var trHead = tableCurrent.find( "tr.trEventHead:first" );

				// Populate Program and Stage
				var eventDate = trCurrent.find( ".eventDate" );
				var eventProgram = trCurrent.find( ".eventProgram" );
				var eventProgramDiv = trCurrent.find( "div.eventProgramDiv" );
				var eventStage = trCurrent.find( ".eventStage" );
				var eventCreateTag = trCurrent.find( ".eventCreate" );


				// Event Date Datepicker setup
				//   - Initially, event date is empty and program stage is disabled.
				//   - When event date is selected, enable program stage and set focus on that stage.
				Util.setupDatePicker( eventDate
					, function() 
					{ 
						Util.disableTag( eventStage, true );

						if ( Util.checkCalendarDateStrFormat( eventDate.val() ) ) Util.disableTag( eventStage, false );

						me.setEventCreateButtonEnable( trCurrent );

						( me.TabularDEObj.isCase_SEwoR() ) ? eventCreateTag.focus() : eventStage.focus(); 

					}
					, undefined
					,"upToToday"
				);


				// For program, set is as display only. 
				Util.selectOption_WithOptionalInsert( eventProgram, programId, me.TabularDEObj.getProgramList_Full() );
				eventProgram.hide();
				eventProgramDiv.show().html( eventProgram.find( 'option:selected' ).text() );


				// Populate Stage list.
				if( Util.checkValue( eventProgram.val() ) )
				{
					me.TabularDEObj.populateProgramStages( eventStage, eventProgram.val() );


					// If MEwR case, see if person has done stage list.
					// If there is, remove them from the programStage selection.
					if ( trPerson !== undefined )
					{
						var doneStages = trPerson.attr( me.TabularDEObj.personList.attr_doneStages );

						me.removeFromStageList( eventStage, doneStages );
					}

					// Disable the ProgramStage - Initially
					Util.disableTag( eventStage, true );					
				}

				// Set the event button Disable - initially
				me.setEventCreateButtonEnable( trCurrent );


				// On stage change, check stage value and event date value.
				eventStage.change( function() 
				{
					me.setEventCreateButtonEnable( trCurrent );

					eventStage.focus();
				});



				// If Single Event without Registration case, hide program & stage
				if ( me.TabularDEObj.isCase_SEwoR() )
				{
					eventProgram.closest( 'div' ).hide();
					eventStage.closest( 'div' ).hide();
					eventStage.val( eventStage.find( 'option:nth-child(2)' ).val() );
				}


				eventCreateTag.click( function() 
				{					
					var programStageSelected = eventStage.val();

					// Check eventDate and eventStage value
					if ( Util.checkCalendarDateStrFormat( eventDate.val() ) && programStageSelected != ''  )
					{

						// 1. Generate the event and put the event id into the ..
						me.eventCreate( trCurrent
						, function( eventId, eventStatus )
						{
							// Check for program stage 'non-repeatableness'
							// and add to 'DontStage' is applicable.
							var programStageData_Selected = me.TabularDEObj.getProgramStageData_ById( programStageSelected );

							if ( me.TabularDEObj.isCase_MEwR() && Util.checkDefined( programStageData_Selected ) && Util.checkDefined( programStageData_Selected.repeatable ) &&  !programStageData_Selected.repeatable )
							{
								// Add this uid to the doneStage
								me.TabularDEObj.addTo_DoneStage( trPerson, programStageSelected );
							}


							eventStage.attr( "selectedProgramStage", programStageSelected ); 

							// 2. Populate the data element columns
							me.populateEventColumnsAndData( trHead, trCurrent, programStageSelected
							, function()
							{	
								//var eventId = trCurrent.attr( "uid" );	
								// Set this - for complete button show/hide & complete event handler set.
								me.setEventFixedColumn_ForExisting( trCurrent, eventId, eventStatus );
								
								// setTimeout due to the first time Async Data Element retrieval and rendering.
								setTimeout( function() 
								{
									me.getFirstDEControl( trCurrent ).focus();
								}
								, 400);
																
							});

						});

					}
					else
					{
						alert( $( 'span.msg_CheckEventDateStage' ).text() );

						eventDate.focus();
					}
				});

				// Return the reference to the first control, so that it can be focused after the row generate.
				return eventDate;
			}

			me.removeFromStageList = function( eventStage, doneStages )
			{
				if ( doneStages != "" )
				{
					var doneStageArr = doneStages.split(";");

					$.each( doneStageArr, function( i_stage, item_stage )
					{	
						var stageId = Util.trim( item_stage );

						if ( stageId != "" )
						{
							eventStage.find( 'option[value="' + stageId + '"]' ).remove();
						}
					});
				}
			}


			me.getFirstDEControl = function( trCurrent )
			{
				// Set focuse to the first DE element
				return trCurrent.find( "td[colcount='0']" ).find( FormUtil.getStr_Views() ).first();

				//if ( firstDEControl.length > 0 )
			}


			// =========================================================
			// Event Create/Delete Related


			me.eventCreate = function( trCurrent, successFunc )
			{
				//var returnVal = false;

				// check date, program, programstage
				var eventDate = trCurrent.find( "input.eventDate" );
				var eventProgram = trCurrent.find( "select.eventProgram" );
				var eventStage = trCurrent.find( "select.eventStage" );
				//var eventStatus = trCurrent.find( "span.eventStatus" );

				var eventDel = trCurrent.find( "input.eventDelete" );

				var personUid = trCurrent.closest( '.trPersonDetail' ).attr( 'uid' );
				var orgUnitUid = me.TabularDEObj.getOrgUnitId();

				var eventDateInFormat = Util.formatDate( eventDate.val() );


				// Need to check if the program Stage has (programStages.captureCoordinates 

				var json_Data = {"program": eventProgram.val(), "programStage": eventStage.val(),"orgUnit": orgUnitUid, "eventDate": eventDateInFormat, "coordinate": {}, "status": _status_ACTIVE };
  

				if ( me.TabularDEObj.isCase_SEwoR() )
				{
					me.eventCreate_SubmitData( json_Data, trCurrent, function( eventId, status )
					{
						successFunc( eventId, status );
					});
				}
				else
				{
					json_Data.trackedEntityInstance = personUid;

			
					// Check for Enrollment.  If enrolled already, create event.  If not, open PersonInfo Popup.
					me.TabularDEObj.checkProgramEnroll( personUid, eventProgram.val(), orgUnitUid
					, function()
					{
						me.eventCreate_SubmitData( json_Data, trCurrent, function( eventId, status )
						{
							successFunc( eventId, status );
						});								
					}
					, function()
					{
						// Alert proper message here.
						alert( $( 'span.msg_NotEnrolled' ).text() );

						var personInfoTag = trCurrent.closest( '.trPersonDetail' ).prev().find( '.personInfo:visible' );

						me.TabularDEObj.personInfoPopup( personInfoTag, function()
						{
							// Doesn't work well.  - due to timing..
							me.eventCreate_SubmitData( json_Data, trCurrent, function( eventId, status )
							{
								successFunc( eventId, status );
							});							
						});
					});

				}
			}


			me.eventCreate_SubmitData = function( json_Data, trCurrent, successFunc )
			{
				RESTUtil.submitData( json_Data, _queryURL_EventSubmit, "POST"
					, function( returnData )
					{
						if ( returnData !== undefined && returnData.response !== undefined && returnData.response.importSummaries !== undefined )
						{
							var importSummary = returnData.response.importSummaries[0];

							if ( importSummary.status == "SUCCESS" )
							{
								trCurrent.attr( "uid", importSummary.reference );
								
								successFunc( importSummary.reference, json_Data.status );
							}
						}
						else
						{
							alert( $( 'span.msg_FailedToCreateEvent' ).text() + '\n\n Error: ' + JSON.stringify( returnData ) );
						}
					}
					, function( returnData ) 
					{
						alert( $( 'span.msg_FailedToCreateEvent' ).text() + '\n\n Error: ' + JSON.stringify( returnData ) );
					}
					, function()
					{
						// Loading..
						DialogLoading.open();
					}
					, function()
					{
						// Loading finish..
						DialogLoading.close();
					}
				);
			}


			this.setStatusRelated = function( trCurrent, eventId, programStageId, status )
			{
				var eventDate = trCurrent.find( "input.eventDate" );
				var eventStatus = trCurrent.find( "span.eventStatus" );
				var eventDel = trCurrent.find( "input.eventDelete" );
				var eventRowDel = trCurrent.find( "input.eventRowDelete" );
				var eventComplete = trCurrent.find( "button.eventComplete" );
				var eventIncomplete = trCurrent.find( "button.eventIncomplete" );
				var eventProgramDiv = trCurrent.find( "div.eventProgramDiv" );
				var eventStageDiv = trCurrent.find( "div.eventStageDiv" );

				// Set Status
				eventStatus.html( status );

				if( status == _status_ACTIVE )
				{
					eventIncomplete.hide();

					// Delete related
					eventDel.show();

					// remove previous click event
					eventDel.off( 'click' );
					eventRowDel.off( 'click' );

					eventDel.click( function() { me.eventDelete( trCurrent, eventId ); });

					// Complete related
					eventComplete.show();

					eventComplete.off( "click" ).on( "click", function() 
					{
						me.completeEvent( trCurrent, eventId, programStageId );
					});
				}
				else if( status == _status_COMPLETED )
				{
					eventDel.hide();
					eventComplete.hide();

					me.TabularDEObj.checkIncompleteAction_UserRole( function() 
					{
						eventIncomplete.show();
					});

					eventIncomplete.off( "click" ).on( "click", function() 
					{
						me.incompleteEvent( trCurrent, eventId, programStageId );
					});

					me.TabularDEObj.dataInMemory.retrieveProgramStageData( programStageId, function( json_ProgramStage )
					{
						if ( json_ProgramStage.blockEntryForm )
						{
							// Disable all the DataElements controls - move the control rendering area..
							me.setEventDEControlDisable( trCurrent );
						}
					});
				}


				if ( me.TabularDEObj.getSearchProgramStatus() != _status_ACTIVE )
				{
					eventDel.hide();
					eventComplete.hide();
					eventIncomplete.hide();

					me.setEventFixedColumnDisable( trCurrent );
					me.setEventDEControlDisable( trCurrent );					
					Util.paintClear( eventProgramDiv );
					Util.paintClear( eventStageDiv );

					eventProgramDiv.css( 'color', '#80808F' );
					eventStageDiv.css( 'color', '#80808F' );
				}

			}


			me.setEventFixedColumn_ForExisting = function( trCurrent, eventId, status )
			{
				var eventDate = trCurrent.find( "input.eventDate" );
				var eventProgram = trCurrent.find( "select.eventProgram" );
				var eventStage = trCurrent.find( "select.eventStage" );
				var eventProgramDiv = trCurrent.find( "div.eventProgramDiv" );
				var eventStageDiv = trCurrent.find( "div.eventStageDiv" );
				var eventRowDelete = trCurrent.find( ".eventRowDelete" );
				var eventCreateTag = trCurrent.find( ".eventCreate" );

				// event date update are place in 'setEventDateSave()'

				// disable the controls
				//Util.disableTag( eventDate, true );
				Util.disableTag( eventCreateTag, true );

				eventProgram.hide();
				eventStage.hide();
				eventCreateTag.hide();

				eventProgramDiv.show().text( eventProgram.find( 'option:selected' ).text() );
				//eventStageDiv.show().html( eventStage.find( 'option:selected' ).text() );
				eventStageDiv.show();

				var selectedStageId = eventStage.attr( "selectedProgramStage" );

				if ( selectedStageId != "" )
				{
					// Simply used to get programStage name.  <-- should do a more efficient way for this..
					me.TabularDEObj.dataInMemory.retrieveProgramStageData( selectedStageId, function( json_ProgramStage )
					{
						eventStageDiv.text( json_ProgramStage.name );
						eventStageDiv.attr( 'uid', json_ProgramStage.id );
					});
				}

				// color the controls
				//Util.paintResult( eventDate, true );
				Util.paintLightGreen( eventProgramDiv );
				Util.paintLightGreen( eventStageDiv );

				// Hide the simple row delete
				eventRowDelete.hide();
				Util.disableTag( eventRowDelete, true );

				// Set status, delete, completed status button related actions.
				me.setStatusRelated( trCurrent, eventId, selectedStageId, status );

			}


			me.eventDelete = function( trCurrent, eventUid )
			{		
				
				if( confirm( $( 'span.msg_ConfirmDelete' ).text() ) )
				{
					// Find the next tabbing tag first.
					var nextTabTag = EventUtil.getNextRowFocus_Event( trCurrent );

					RESTUtil.submitData( undefined, _queryURL_EventSubmit + '/' + eventUid, "DELETE"
						, function()
						{
							MsgManager.msgAreaShow( $( 'span.msg_EventDeleted' ).text() );
																
							var tableCurrent = trCurrent.closest( 'table' );

							// Remove this row and set focus on next tag
							Util.setRowRemoval( trCurrent, function()
							{							
								// If this is the last row in this table, remove all the DE data columns.
								if ( tableCurrent.find( 'tr.trEventData' ).length == 0 )
								{
									tableCurrent.find( 'tr.trEventHead' ).find( 'th.added' ).remove();
								}
								
								// Set focus to the next tag.
								if ( nextTabTag !== undefined )
								{
									nextTabTag.focus();
								}
							});
							
						}
						, function( errorMsg )
						{							
							var auditMsg = "";

							//console.log( 'errorMsg: ' + errorMsg + ', obj: ' + JSON.stringify( errorMsg ) );


							if ( errorMsg !== undefined && errorMsg.responseJSON !== undefined )
							{
								var devMsg = errorMsg.responseJSON.devMessage;

								if ( devMsg !== undefined )
								{
									console.log( 'errorMsg.devMessage: ' + devMsg + ', audit:' +
									devMsg.indexOf( "audit" ) );

									if ( devMsg.indexOf( "audit" ) >= 0 )
									{
										auditMsg += '  ErrorMsg: Due to the associated audit data existing, delete is not allowed.';
									}

								}
							}
							// Need to display information about the audit info..

							alert( $( 'span.msg_EventDeleteFailed' ).text() + auditMsg );

							trCurrent.find( "input.eventDelete" ).focus();

						}
					);
				}
			}


			me.completeEvent = function( trCurrent, eventUid, programStageId )
			{		
				if ( me.checkCompulsoryData( trCurrent ) && ProgramRuleUtil.checkProgramRuleData( trCurrent ) )
				{
					if( confirm( $( 'span.msg_ConfirmEventComplete' ).text() ) )
					{
						me.eventUpdate( trCurrent, _status_COMPLETED
							, function()
							{
								// Find the next tabbing tag first.
								var nextTabTag = EventUtil.getNextRowFocus_Event( trCurrent );

								// Update the completeted row info/setting..
								me.setStatusRelated( trCurrent, eventUid, programStageId, _status_COMPLETED );

								if ( nextTabTag !== undefined )
								{
									nextTabTag.focus();
								}
							}
						);
					}
				}
			}


			me.incompleteEvent = function( trCurrent, eventUid, programStageId )
			{		
				if( confirm( $( 'span.msg_ConfirmEventIncomplete' ).text() ) )
				{
					me.eventUpdate( trCurrent, _status_ACTIVE
						, function()
						{
							// Find the next tabbing tag first.
							var nextTabTag = EventUtil.getNextRowFocus_Event( trCurrent );

							// Update the completeted row info/setting..
							me.setStatusRelated( trCurrent, eventUid, programStageId, _status_ACTIVE );

							if ( nextTabTag !== undefined )
							{
								nextTabTag.focus();
							}
						}
					);
				}
			}


			me.addEventRow = function( newRowCount, tableCurrent )
			{
				tableCurrent.append( $( document.createElement( "tr" ) ).attr( 'class', 'trEventData' ).attr( 'uid', '' ).append( me.trTemplate_EventRow ) );

				var lastRow = tableCurrent.find( "tr.trEventData:last" );

				lastRow.attr( me.attr_EventRowNo, newRowCount );


				// Adjust the column count here.
				me.adjustNewRowTDCount( lastRow, tableCurrent );

				// Add delete row event
				lastRow.find( '.eventRowDelete').click( function() 
				{
					var trCurrent = $( this ).closest( 'tr' );

					// Find the next tabbing tag first.
					var nextTabTag = EventUtil.getNextRowFocus_Event( trCurrent );

					Util.setRowRemoval( trCurrent );

					// Set focus to the next tag.
					if ( nextTabTag !== undefined )
					{
						nextTabTag.focus();
					}
				});


				return lastRow;
			}


			me.adjustNewRowTDCount = function( trCurrent, tableCurrent )
			{
				//var columnCount = tableCurrent.find("th.added").length;

				tableCurrent.find( "th.added" ).each( function( index ) {
					
					trCurrent.append( "<td class='added' colCount='" + $( this ).attr("colCount") + "'>&nbsp;</td>");
				} );
			}


			me.adjustRowsTDCount = function( tableCurrent )
			{
				var columnCount = tableCurrent.find("th.added").length;

				tableCurrent.find( "tr.trEventData" ).each( function( i_tr, item_tr ) {

					// For each data row, check if each row has enough td.
					// If not, add them.
					me.addTDRow( $(this), columnCount );

				} );

				//trCurrent.append( "<td colCount='" + $( this ).attr("colCount") + "'>&nbsp;</td>");

			}


			me.addTDRow = function( trCurrent, totalColumnCount )
			{
				var tdCount = trCurrent.find( "td.added" ).length;

				if( tdCount < totalColumnCount )
				{
					for( var i = tdCount; i < totalColumnCount; i++)
					{					
						trCurrent.append( "<td class='added' colCount='" + i + "'>&nbsp;</td>");
					}
				}
			}

			// Event Create/Delete Related
			// =========================================================


			// =========================================================
			// Retrieve and Populate Event Related
			

			me.populateEventsByPersonId = function( personId, trPersonRow, divPersonDetailTag, successFunc )
			{

				// NOTE: Populate event that does not have register date/orgUnit
				// first <-- auto generated events on enrollment to program
				me.getUnregisteredEventsByPersonId( personId, divPersonDetailTag, function( events_unregistered )
				{
					// Retrieve registered events
					var requestUrl = me.getEventsSearchUrl( personId );
					var json_EventList = new Array();
					var tbEvents = divPersonDetailTag.find( ".tbStyle_PersonDetail" );

					RESTUtil.getAsynchData( requestUrl, function( json_Events )
					{	
						// Combine unregistered and registered events
						if ( Util.checkDataExists( json_Events.events ) )
						{
							var json_EventList_Sorted = Util.sortByKey( json_Events.events, "eventDate" );

							json_EventList = $.merge( events_unregistered, json_EventList_Sorted );
						}
						else if ( events_unregistered.length > 0 )
						{
							json_EventList = events_unregistered;
						}

						if ( json_EventList.length > 0 )
						{
							me.populateEvents( trPersonRow, tbEvents, json_EventList );
						}
						else
						{
							// If no event found, create the new event row
							me.addNewLastRow_Event( trPersonRow, tbEvents, me.TabularDEObj.getSelectedProgramId() );
						}

						successFunc( json_EventList );
					}
					, function() { successFunc( json_EventList ); }
					, function() { FormUtil.setTagAsWait( divPersonDetailTag ); }
					, function() { FormUtil.setTagAsWait_Clear( divPersonDetailTag ); }
					);
				});
			}

			me.getUnregisteredEventsByPersonId = function( personId, divPersonDetailTag, returnFunc )
			{
				var json_EventList = new Array();
				var requestUrl = me.getUnregisteredEventsSearchUrl( personId );

				RESTUtil.getAsynchData( requestUrl, function( json_Events )
				{					
					if ( Util.checkDataExists( json_Events.events ) )
					{
						$.each( json_Events.events, function( i_event, item_event )
						{
							if ( item_event.eventDate === undefined )
							{
								json_EventList.push( item_event );
							}
						});
					}

					returnFunc( json_EventList );
				}
				, function() { returnFunc( json_EventList ); }
				, function() { FormUtil.setTagAsWait( divPersonDetailTag ); }
				, function() { FormUtil.setTagAsWait_Clear( divPersonDetailTag ); }
				);
			}


			// To be executed by 'Populate' button. - if Program is SEwoR.
			me.retrieveAndPopulateEvents = function( tableCurrent, execFunc )
			{
				// Step 1. Clear the person/event data table
				me.clearEventList();

				var foundNo = 0;

				var requestUrl = me.getEventsSearchUrl();
					
				RESTUtil.getAsynchData( requestUrl, function( json_Events )
				{
					if ( Util.checkDataExists( json_Events.events ) )
					{
						var json_EventList_Sorted = Util.sortByKey( json_Events.events, "eventDate" );

						me.populateEvents( undefined, tableCurrent, json_EventList_Sorted );

						foundNo = json_Events.events.length;
					}


					if ( foundNo == 0 )
					{
						// Create the new event row - simply get basic info
						me.addNewLastRow_Event( undefined, me.mainEventTableTag, me.TabularDEObj.getSelectedProgramId() );
					}

					execFunc( foundNo );
				}
				, function( failed_Message )
				{
					execFunc( foundNo );					

					alert( $( 'span.msg_EventRetrievalFailed' ).text() + '\n\n Error: ' + JSON.stringify( failed_Message ) );

				}
				, DialogLoading.open
				, DialogLoading.close					
				);	
			}


			// =========================================================
			// Populate Event Column Related

			// Move this to populate Layout method section
			me.populateEventColumnsAndData = function( trHead, trCurrent, programStageUid, runAfterwards_Func, item_event )
			{

				me.TabularDEObj.dataInMemory.retrieveProgramStageData( programStageUid, function( json_ProgramStage )
				{

					trCurrent.find( "td.added" ).html( "" ).attr( "DEID", "" );

					var count_columnExisting = trHead.find( ".added" ).length;
					//var count_dataElements = json_ProgramStage.programStageDataElements.length;
					var count_current = 0;


					var cssTD_DENameDisplay = "style=''";
					var cssTH_DENameDisplay = "style=''";

					if ( me.TabularDEObj.isCase_SEwoR() )
					{
						cssTD_DENameDisplay = "style='display:none;'";
					}
					else 
					{
						cssTH_DENameDisplay = "style='display:none;'";
					}


					// TODO: place class='before' coordinate at here?
					//		Add class
					if ( Util.checkDefined( json_ProgramStage.captureCoordinates ) && json_ProgramStage.captureCoordinates )
					{
						var coordinateControlTemplate = "<div id='eventCoordinateDiv'><table class='tbNone11'><tr><td><span style='font-size: 11px;'>Lat:</span></td><td><input type='text' class='eventCoorLat' size='7' " + _view + "='" + _view_Yes + "' + style='margin-bottom:1px;'/></td></tr><tr><td><span style='font-size: 11px;'>Long:</span></td><td><input type='text' class='eventCoorLng' size='7' " + _view + "='" + _view_Yes + "'/></td></tr></table></div>";

						me.setColumns_AddedPart( count_current++, count_columnExisting, trCurrent, trHead, undefined, "Coordinates", cssTH_DENameDisplay, cssTD_DENameDisplay, coordinateControlTemplate );
					}

					
					// For each data elements, add column.
					$.each( json_ProgramStage.programStageDataElements, function( i, item ) {

						me.setColumns_AddedPart( count_current, count_columnExisting, trCurrent, trHead, item, "", cssTH_DENameDisplay, cssTD_DENameDisplay, "" );

						count_current++;
					});


					// NOTE: Added Back From Old Version
					// After done with data elements, add complete button.
					if ( count_columnExisting > count_current )
					{
						trCurrent.find( "td[colCount='" + count_current + "']" ).append( me.buttonTemplate_Complete );

					}
					else
					{
						trHead.find( 'th[type="completed_button"]' ).attr( 'type', '' );

						trHead.append( me.thTemplate_CompleteButton ).find( 'th[type="completed_button"]' ).attr( 'colcount', count_current );

						trCurrent.append( me.tdTemplate_CompleteButton ).find( 'td[type="completed_button"]' ).attr( 'colcount', count_current );
					}
					

					me.adjustRowsTDCount( trCurrent.closest( ".tbStyle_PersonDetail" ) );

					// This is where the visible attribute is being set ('view=y') and controls are decided.
					me.setEventDEControlTypesAndValue( trCurrent, item_event );

					me.setEventDataSave( trCurrent );


					// -- PROGRAM RULE RELATED ------------
					var selectedProgram = me.TabularDEObj.getSelectedProgram();

					var personId = trCurrent.closest( 'tr.trPersonDetail' ).attr( 'uid' );


					// Add Program Rules (with events?)
					me.TabularDEObj.programRule.setUp_ProgramRules( 'Event_DE', personId, trCurrent, trCurrent.find( 'td.added' ), selectedProgram.rules, selectedProgram.ruleVariables );



					// Set td background switching event on focus
					FormUtil.setTabBackgroundColor_Switch( trCurrent.find( "input,select,button" ) );
					
					// 
					runAfterwards_Func();

				});

			}


			me.setColumns_AddedPart = function( i, count_columnAdded, trCurrent, trHead, deItem, titleName, cssTH_Name, cssTD_Name, controlsTemplate )
			{
				var deId = "";
				var compulsory = false;
				var compulsorySpan = "";


				if ( Util.checkDefined( deItem ) )
				{
					deId = deItem.dataElement.id;
					compulsory = deItem.compulsory;

					titleName = ( Util.checkValue( deItem.dataElement.formName ) ) ? deItem.dataElement.formName : deItem.dataElement.name;

					if ( deItem.compulsory )
					{
						compulsorySpan = "<span title='Compulsory' class='mandatory'>*</span>";
					}
				}


				// NOTE: Need to count this <-- so we can reuse the exisitng columns
				if( i < count_columnAdded )
				{
					// reuse the column
					trCurrent.find( "td[colCount='" + i + "']" ).attr( "DEID", deId ).attr("compulsory", compulsory ).append( "<span class='dataElementName' " + cssTD_Name + ">" + titleName + compulsorySpan + ": </span>" + controlsTemplate );
				}
				else
				{
					// create the column
					trHead.append( "<th class='added' colCount='" + i + "'><span class='dataElementName' " + cssTH_Name + ">" + titleName + compulsorySpan + "</span>&nbsp;</th>" );

					trCurrent.append( "<td class='added' DEID='" + deId + "' compulsory='" + compulsory + "'  colCount='" + i + "'><span class='dataElementName' " + cssTD_Name + ">" + titleName + compulsorySpan + ": </span>" + controlsTemplate + "</td>" );
				}

			}


			// =========================================================
			// Set Event DataElement Controls

			me.setEventDEControlTypesAndValue = function( trCurrent, item_event )
			{	

				var deValueSet = [];

				// Set values if available.
				if ( item_event !== undefined )
				{					
					if ( item_event.coordinate !== undefined )
					{
						// Put coordinate values to input tags
						me.populateCoordinateTagData( item_event.coordinate, trCurrent.find( "input.eventCoorLat" ), trCurrent.find( "input.eventCoorLng" ) );
					}


					// Set data element values to be populated once the controls are set.
					if( item_event.dataValues !== undefined )
					{
						$.each( item_event.dataValues, function( i_dataValue, item_dataValue ) 
						{
							if( item_dataValue.dataElement !== undefined )
							{
								deValueSet.push( { "de": item_dataValue.dataElement, "value": item_dataValue.value } );
							}
						});
					}
				}


				// Set Controls and values
				trCurrent.find( "td.added" ).each( function( index ) 
				{

					var tdTag = $( this ); 
					var DEID = tdTag.attr( "DEID" );


					if( Util.checkValue( DEID ) )
					{
						
						var deValue = Util.getFromList( deValueSet, DEID, "de" );

						// Get dataElement info
						me.TabularDEObj.dataInMemory.retrieveDataElement( DEID, function( json_DataElement )
						{
							var controlTag;
							var valType = json_DataElement.valueType;


							// TODO: Need to add validation of the type
							//		- INTEGER, LETTER, PHONE_NUMBER, etc..
							//		PersonUtil.setTagTypeValidation
							//		But, we need to perform this on 'saving' area and prevent it..
							//		So, for now, set it as attribute?

							if( json_DataElement.optionSetValue || valType == "BOOLEAN" )
							{
								var controlTag = me.setAndGetControlTag( tdTag, ".dropdown" );

								if( valType == "BOOLEAN" )
								{
									controlTag.append("<option value='true'>Yes</option>").append("<option value='false'>No</option>");						
								}
								else
								{
									// Get optionSet values
									me.TabularDEObj.dataInMemory.retrieveOptionSets( json_DataElement.optionSet.id, function( json_OptionSets )
									{
										$.each( json_OptionSets.options, function( i_Option, item_Option) 
										{
											EventUtil.appendSelectOption_Option( controlTag, item_Option );
										});

										if ( deValue !== undefined ) controlTag.val( deValue.value );
									});
								}
							}
							else if( valType == "TEXT" || valType == "USERNAME" || valType == "LETTER" || valType == "PHONE_NUMBER" || valType == "EMAIL" || valType == "DATETIME" || valType == "FILE_RESOURCE" || valType == "COORDINATE" )
							{
								var controlTag = me.setAndGetControlTag( tdTag, ".textbox" );
							}
							else if( valType == "LONG_TEXT" )
							{
								var controlTag = me.setAndGetControlTag( tdTag, ".textarea" );
							}
							else if ( valType.indexOf( "INTEGER" ) == 0 || valType == "UNIT_INTERVAL" )
							{
								var controlTag = me.setAndGetControlTag( tdTag, ".textbox" ).attr( "size", "5" );
							}
							else if ( valType == "NUMBER" || valType == "PERCENTAGE" )
							{
								var controlTag = me.setAndGetControlTag( tdTag, ".textbox" ).attr( "size", "8" );
							}
							else if( valType == "DATE" )
							{
								var controlTag = me.setAndGetControlTag( tdTag, ".datepicker" );
								Util.setupDatePicker( controlTag );
								/*, function() 
								{
									setTimeout( function() 
									{ 
										console.log( 'cal changed: ' + controlTag.val() );
										controlTag.focusout();
									}, 500 );
								} );*/
							}
							else if( valType == "TRUE_ONLY" || valType == "TRACKER_ASSOCIATE" )
							{
								var controlTag = me.setAndGetControlTag( tdTag, ".checkbox" );
							}
							else
							{
								//alert( "Unknown Column(DataElement) Type Found.  [Name: " + json_DataElement.name + ", ID: " + json_DataElement.id + ", valueType: " + valType + "]" );
								var controlTag = me.setAndGetControlTag( tdTag, ".label" ).html( '<span style="color:Red;">Not supported valueType: ' + valType + '</span>' );
							}


							// For validation, set 'valType' as attribute and check the type validation during saving ( on 'change' event )
							controlTag.attr( 'valType', valType );


							// Populate Data - Other than optionSet listings already applied above.
							if ( controlTag !== undefined && deValue !== undefined )
							{
								if( valType == "DATE" )
								{
									controlTag.val( Util.formatDateBack( deValue.value ) );
								}
								else if( valType == "TRUE_ONLY" || valType == "TRACKER_ASSOCIATE" )
								{
									controlTag.prop( 'checked', deValue.value );
								}
								else
								{
									controlTag.val( deValue.value );
								}
							}

						});
					}
				});
			}


			me.setAndGetControlTag = function( inputTag, className )
			{
				var controlTag;

				if ( className == '.datepicker' )
				{
					controlTag = $( '<input class="datepicker" type="text" size="11" />' );
				}
				else if ( className == '.textbox' )
				{
					controlTag = $( '<input class="textbox" type="text" size="15" height="20px" />' );
				}
				else if ( className == '.textarea' )
				{
					controlTag = $( '<textarea class="textarea" cols="15" rows="2"></textarea>' );
				}
				else if ( className == '.checkbox' )
				{
					controlTag = $( '<input class="checkbox" type="checkbox" />' );
				}
				else if ( className == '.dropdown' )
				{
					controlTag = $( '<select class="dropdown"><option value="">Select Value</option></select>' );
				}
				else if ( className == '.label' )
				{
					controlTag = $( '<span class="label"></span>' );
				}
				else
				{
					controlTag = $( '<span class="label"></span>' );
				}

				controlTag.attr( _view, _view_Yes );

				inputTag.append( controlTag );

				return controlTag;
			}


			me.setEventFixedColumnDisable = function( trCurrent )
			{
				// .find( FormUtil.getStr_Views() )
				trCurrent.find( "td.orig" ).find( "input,select" ).each( function( index ) {

					Util.disableTag( $( this ), true );
				});
			}

			me.setEventDEControlDisable = function( trCurrent )
			{
				// .find( FormUtil.getStr_Views() )
				trCurrent.find( "td.added" ).find( "input,select,textarea" ).each( function( index ) {

					Util.disableTag( $( this ), true );
				});
			}

			// Set Event DataElement Controls
			// =========================================================



			// ==============================================
			// Event Save Related

			me.setEventDataSave = function( trCurrent )
			{

				trCurrent.find( "input.eventDate" ).datepicker( "option", "onSelect", function() 
				{
					me.setStatusChecking( $( this ), true );

					me.eventUpdate( trCurrent );
				});

				trCurrent.find( "input.eventCoorLat, input.eventCoorLng" ).change( function () 
				{
					me.eventUpdate( trCurrent );
				});

				trCurrent.find( "td.added input.datepicker" ).focusout( function () 
				{
					var cntrl = $( this );
					setTimeout( function() 
					{ 
						//console.log( 'focus out val: ' + cntrl.val() );
						me.eventUpdatePartial( cntrl, trCurrent.attr( 'uid' ) );
					}, 200 );
				});

				trCurrent.find( "td.added input.textbox, td.added select, td.added textarea, td.added input.checkbox" ).change( function () 
				{
					me.eventUpdatePartial( $( this ), trCurrent.attr( 'uid' ) );
				});
			}


			me.setUp_EntryKeyTabbing = function( tags )
			{
				tags.keydown( function( event ) { me.moveNextOnEnter( event, $( this ) ); } );
			}

			me.setUp_OnChangeTabbing = function( tags )
			{
				tags.change( function( event ) 
				{ 
					tag = $( this );

					tag.parent().next().find( FormUtil.getStr_Views() ).first().focus().select();

				} );
			}

			me.moveNextOnEnter = function( event, tag )
			{
				if ( event.keyCode == 13 )
				{
					var nextTag = tag.parent().next().find( FormUtil.getStr_Views() ).first();
					
					nextTag.focus();

					nextTag.select();
				}
			}


			me.eventUpdate = function( trCurrent, newStatus, successAction )
			{
				// Assuming that the event was created before, by ProgramStage selection, 
				// when any of the values changes, update the event with all thoes values.
				
				// check date, program, programstage
				var eventDate = trCurrent.find( "input.eventDate" );
				var eventProgram = trCurrent.find( "select.eventProgram" );
				var eventStage = trCurrent.find( "select.eventStage" );
				var eventStatus = trCurrent.find( "span.eventStatus" );
				
				var eventCoorLat = trCurrent.find( "input.eventCoorLat" );
				var eventCoorLng = trCurrent.find( "input.eventCoorLng" );

				var personUid = trCurrent.closest( '.trPersonDetail' ).attr( 'uid' );
				var eventUid = trCurrent.attr( 'uid' );

				var eventDateInFormat = Util.formatDate( eventDate.val() );
				
				var status = eventStatus.text();

				if ( Util.checkValue( newStatus ) )
				{
					status = newStatus;
				}
							
				var json_Data = {"program": eventProgram.val(), "programStage": eventStage.attr( 'selectedprogramstage' ),"orgUnit": me.TabularDEObj.getOrgUnitId(), "eventDate": eventDateInFormat,  "coordinate": {}, "status": status, "dataValues": me.generateJSON_AllDataColumns( trCurrent ) };


				// if coordinates exists, add them.
				me.setCoordinateData( json_Data.coordinate, eventCoorLat, eventCoorLng );


				if ( !me.TabularDEObj.isCase_SEwoR() )
				{
					json_Data.trackedEntityInstance = personUid;
				}

				RESTUtil.submitData( json_Data, _queryURL_EventSubmit + '/' + eventUid, "PUT"
					, function()
					{						
						// Clear all coloring
						trCurrent.find( "td.added" ).find( "input,select" ).each( 
							function () 
							{
								Util.paintResult( $(this), false );
							}
						);

						trCurrent.find( "[status='checking']" ).each( 
							function () 
							{
								$(this).attr( "status", "updated" );				 
								Util.paintResult( $(this), true );
							}
						);
						
						if ( successAction !== undefined ) successAction();
					}
					, function()
					{
						alert( $( 'span.msg_EventUpdateFailed' ).text() );
					}
				);
				
			}


			me.eventUpdatePartial = function( tag, eventId, successAction )
			{
				// Check the Validation
				if ( me.validateEventDEControlVal( tag ) )
				{
					var dataElementId = tag.closest( "td" ).attr( "DEID" );
			
					if ( Util.checkValue( eventId ) && Util.checkValue( dataElementId ) )
					{
						var dataValue = me.getDataValue_FromTag( tag );

						var dataElementValue = { "dataElement": dataElementId };

						if ( dataValue != "" ) dataElementValue.value = dataValue;

						var json_Data = { "dataValues": [ dataElementValue ] };


						var queryUrl = _queryURL_EventSubmit + '/' + eventId + '/' + dataElementId;

						RESTUtil.submitData( json_Data, queryUrl, "PUT"
						, function()
						{
							tag.attr( "status", "updated" );				 
							Util.paintResult( tag, true );
							
							if ( successAction !== undefined ) successAction();
						}
						, function()
						{
							tag.attr( "status", "failed" );
							Util.paintWarning( tag );

							alert( $( 'span.msg_EventUpdateFailed' ).text() );
						}
						);
					}	
				}
			};


			me.validateEventDEControlVal = function( inputTag )
			{
				var pass = true;
				var valType = inputTag.attr( 'valType' );

				if ( valType !== undefined && valType != '' )
				{
					pass = FormUtil.validateValueType( inputTag, valType );
				}

				return pass;
			}


			me.checkCompulsoryData = function( trCurrent )
			{
				var pass = true;

				trCurrent.find( "td.added[compulsory='true']" ).find( FormUtil.getStr_Views() ).each( function( index ) 
				{
					var tag = $( this );
					
					var dataValue;

					// Check the class and covert the values
					if( tag.hasClass( "datepicker" ) )
					{
						dataValue = Util.formatDate( tag.val() );
					}
					else if( tag.hasClass( "checkbox" ) )
					{
						dataValue = tag.is( ":checked" ) ? "true" : "" ;
					}
					else
					{
						dataValue = tag.val();
					}

					if( !Util.checkValue( dataValue ) )
					{	
						Util.paintWarning( tag );
						pass = false;
					}
					else
					{
						Util.paintClear( tag );
					}
				});

				if ( !pass )
				{
					alert( $( 'span.msg_CompulsoryFill' ).text() );
				}

				return pass;
			}


			me.generateJSON_AllDataColumns = function( trCurrent )
			{
				var dataValues = new Array();

				trCurrent.find( "td.added" ).find( FormUtil.getStr_Views() ).each( function ( i ) 
				{
					var item = $(this);

					var dataElementUID = item.closest( "td" ).attr( "DEID" );
		
					if ( Util.checkValue( dataElementUID ) )
					{
						var dataValue = me.getDataValue_FromTag( item );

						if( Util.checkValue( dataValue ) )
						{						
							dataValues.push( { "dataElement": dataElementUID, "value": dataValue } );

							me.setStatusChecking( item, true );
						}
						else
						{
							me.setStatusChecking( item, false );
						}
					}

				});

				return dataValues;
			}


			me.getDataValue_FromTag = function( tag )
			{
				var dataValue = "";

				// Check the class and covert the values
				if( tag.hasClass( "datepicker" ) )
				{
					dataValue = Util.formatDate( tag.val() );
				}
				else if( tag.hasClass( "checkbox" ) )
				{
					dataValue = tag.is( ":checked" ) ? "true" : "" ;
				}
				else
				{
					dataValue = tag.val();
				}
			
				return dataValue;				
			}


			me.setStatusChecking = function( tag, isChecking )
			{
				var checkingStr = ( isChecking ) ? "checking" : "";

				tag.attr( "status", checkingStr );
			}


			me.setCoordinateData = function( coordinate, eventCoorLatTag, eventCoorLngTag )
			{
				me.setStatusChecking( eventCoorLatTag, false );
				me.setStatusChecking( eventCoorLngTag, false );
				
				if ( Util.checkValue( eventCoorLatTag.val() ) ) 
				{
					coordinate.latitude = eventCoorLatTag.val();
					me.setStatusChecking( eventCoorLatTag, true );
				}

				if ( Util.checkValue( eventCoorLngTag.val() ) ) 
				{
					coordinate.longitude = eventCoorLngTag.val();
					me.setStatusChecking( eventCoorLngTag, true );
				}
			}


			// Event Search from default setting - populate
			me.getEventsDefaultPopulate_SearchUrl = function()
			{				
				return me.buildSearchURLByParameter( me.TabularDEObj.getEventQueryBaseUrl() );
			}

			
			me.getTEIFromEvents_SearchUrl = function()
			{
				return me.buildSearchURLByParameter( me.TabularDEObj.getTEIFromEventQueryBaseUrl() );
			}


			me.buildSearchURLByParameter = function( baseURL )
			{
				var orgUnitId = me.TabularDEObj.getOrgUnitId();
				var programId = me.TabularDEObj.getSelectedProgramId();
				var startDate = me.TabularDEObj.getDefaultStartDate();
				var endDate = me.TabularDEObj.getDefaultEndDate();
				
				var searchAllProgramStr = "";

				if ( !me.TabularDEObj.isCase_SearchAllProgram() && Util.checkValue( programId ) )
				{
					searchAllProgramStr = '&program=' + programId;
				}

				return baseURL 
				+ '&orgUnit=' + orgUnitId 
				+ '&startDate=' + $.format.date( startDate, _dateFormat_YYYYMMDD_Dash ) 
				+ '&endDate=' + $.format.date( endDate, _dateFormat_YYYYMMDD_Dash ) 
				+ searchAllProgramStr; 
			}

			
			me.getEventsSearchUrl = function( personId )
			{
				var returnUrl = "";


				// If list All perosn historical events flag is set, remove the date/program/orgUnit filter.
				if ( me.TabularDEObj.isCase_ListAllPersonHistoricalEvents() && me.TabularDEObj.isCase_MEwR() )
				{
					returnUrl = me.TabularDEObj.getEventQueryBaseUrl();
				}
				else
				{
					returnUrl = me.getEventsDefaultPopulate_SearchUrl();
				}

				if ( Util.checkValue( personId ) )
				{
					returnUrl += '&trackedEntityInstance=' + personId;
				}

				return returnUrl;
			}


			me.getUnregisteredEventsSearchUrl = function( personId )
			{
				return me.TabularDEObj.getEventQueryBaseUrl() 
				+ '&trackedEntityInstance=' + personId 
				+ '&program=' + me.TabularDEObj.getSelectedProgramId();				
			}

			// -------------------------------------
			// -- Populate Events Related ----------

			me.populateEvents = function( trPerson, item_EventTable, json_Events )
			{
				//var orgUnitUid = me.TabularDEObj.getOrgUnitId();
				item_EventTable.find( "tr.trEventData" ).remove();
				item_EventTable.find( "tr.trEventHead th.added" ).remove();

				if( Util.checkDataExists( json_Events ) )
				{
					$.each( json_Events, function( i_event, item_event ) 
					{
						// Create the new event row - simply get basic info
						me.addNewLastRow_Event( trPerson, item_EventTable, item_event.program );

						// Populate Event Columns and Data.
						me.populateEventData( item_EventTable, item_event );

					});
				}
			}

			me.populateEventData = function( tableCurrent, item_event )
			{
				var trHead = tableCurrent.find( "tr.trEventHead:first" );
				var trCurrent = tableCurrent.find( "tr.trEventData:last" );


				// -----------------------------------------------
				// --- STEP 1. Populate first 3 row - Event date, program, stage
				var eventDate = trCurrent.find( "input.eventDate" );
				var eventOrgUnit = trCurrent.find( "span.eventOrgUnit" );
				var eventProgram = trCurrent.find( "select.eventProgram" );
				var eventStage = trCurrent.find( "select.eventStage" );
				var eventStatus = trCurrent.find( "span.eventStatus" );
				var eventDel = trCurrent.find( "input.eventDelete" );

				if ( item_event.eventDate !== undefined )
				{
					eventDate.val( Util.formatDateBack( item_event.eventDate ) );
				}
				
				// Select Program/ProgramStages <-- if not in select option, add one.
				Util.selectOption_WithOptionalInsert( eventProgram, item_event.program, me.TabularDEObj.getProgramList_Full() );
				
				Util.selectOption_WithOptionalInsert( eventStage, item_event.programStage, me.TabularDEObj.getProgramStageList_Full() );
				//eventProgram.val( item_event.program );
				//eventStage.val( item_event.programStage );

				eventStage.attr( "selectedProgramStage", item_event.programStage ); 

				// Disable 3 rows
				// put event id
				trCurrent.attr( "uid", item_event.event );	
				

				// Set Event Org Unit Name - only for MEwR case.
				if ( !me.TabularDEObj.isCase_SEwoR() )
				{
					if ( Util.checkValue( item_event.orgUnitName ) )
					{
						eventOrgUnit.text( item_event.orgUnitName );
					}
					else if ( Util.checkValue( item_event.orgUnit ) )
					{
						me.TabularDEObj.dataInMemory.retrieveOrgUnitName( item_event.orgUnit, function( json_OrgUnit ) 
						{
							eventOrgUnit.text( json_OrgUnit.name );
						});
					}
				}


				// -----------------------------------------------
				// --- STEP 2. Render the program stage selected data element controls

				// Populate the data element columns
				me.populateEventColumnsAndData( trHead, trCurrent, item_event.programStage, function() 
				{ 
					me.setEventFixedColumn_ForExisting( trCurrent, item_event.event, item_event.status );
				}
				, item_event );

			}


			me.populateCoordinateTagData = function( coordinate, latTag, lngTag )
			{
				if ( coordinate !== undefined )
				{
					if ( coordinate.latitude !== undefined ) latTag.val( coordinate.latitude );
					if ( coordinate.longitude !== undefined ) lngTag.val( coordinate.longitude );
				}
			}

			// -- Populate Events Related ----------
			// -------------------------------------


			me.retreivePersonListWithEvents = function( returnFunc )
			{
				var personEventList = new Array();

				//var requestUrl = me.getEventsDefaultPopulate_SearchUrl();
				var requestUrl = me.getTEIFromEvents_SearchUrl();


				// Get the search criteria Events
				RESTUtil.getAsynchData( requestUrl, function( json_Events ) 
				{
					// Sort the personInfo here.
					if ( json_Events.eventRows !== undefined )
					{
						// Use this personLis to group the events under?
						personEventList = me.createPersonEventList( json_Events.eventRows );
					}						

					// Empty personObjList_Sorted..
					returnFunc( personEventList );

				}
				, function() 
				{
					console.log( 'Failed to query events' );
					returnFunc( personEventList );
				} 
				, DialogLoading.open
				, DialogLoading.close				
				);

			}


			me.createPersonEventList = function( eventTEIs )
			{
				var personList = new Array();

				$.each( eventTEIs, function( i_eventTEI, item_eventTEI ) 
				{
					if ( Util.checkValue( item_eventTEI.trackedEntityInstance ) )
					{
						var personObj = me.getPersonObject( personList, item_eventTEI );
												
						personObj.eventRows.push( item_eventTEI );
					}
				});
		
				return personList;
			}


			me.getPersonObject = function( personList, eventTEI )
			{
				var personObj = Util.getFromList( personList, eventTEI.trackedEntityInstance, 'trackedEntityInstance' );

				if ( personObj === undefined )
				{
					personList.push( { 'trackedEntityInstance': eventTEI.trackedEntityInstance, 'attributes': eventTEI.attributes, 'orgUnit': eventTEI.orgUnit, 'orgUnitName': eventTEI.orgUnitName, 'eventRows': [] } );

					personObj = Util.getFromList( personList, eventTEI.trackedEntityInstance, 'trackedEntityInstance' );
				}

				return personObj;
			}

		}

		// PersonEvent Class
		// -------------------------------------------


		// ============================================================================
		// ============================================================================

		// -------------------------------------------
		// Class - Data In Memory
		//			- Data In Memory holding class
		function DataInMemory()
		{
			var me = this;

			me.orgUnitNameList = new Array();

			me.programStageDataElements = new Array();
			me.dataElementList = new Array();
			me.dataElementOptionSets = new Array();

			me.programList_Full = new Array();
			me.programStageList_Full = new Array();
			me.programListWithStage_Full;


			// --------------------------
			// Run methods


			// ---------------------------------------
			// --- Each data retrieval method

			
			me.retrieveOptionSets = function( optionSetId, runFunc )
			{
				me.retrieveFromMemory( me.dataElementOptionSets, 'id', optionSetId, _queryURL_OptionSets + optionSetId + '.json?fields=id,name,options[id,displayName,name]', function( dataObj )
				{
					runFunc( dataObj );
				});
			}


			me.retrieveDataElement = function( dataElementId, runFunc )
			{
				me.retrieveFromMemory( me.dataElementList, 'id', dataElementId, _queryURL_DataElementDetail + dataElementId + '.json', function( dataObj )
				{
					runFunc( dataObj );
				});
			}


			me.retrieveProgramStageData = function( programStageId, runFunc )
			{
				me.retrieveFromMemory( me.programStageDataElements, 'id', programStageId, _queryURL_ProgramStages + '/' + programStageId + '.json?fields=id,name,displayName,description,repeatable,captureCoordinates,program[id,name],programStageDataElements[compulsory,sortOrder,allowFutureDate,dataElement[id,name,formName]]', function( dataObj )
				{
					if ( runFunc !== undefined )
					{
						runFunc( dataObj );
					}
				});
			}


			me.retrieveProgramStageData_WithDataElementsAndOptionSets = function( programStageId, runFunc )
			{
				me.retrieveFromMemory( me.programStageDataElements, 'id', programStageId, _queryURL_ProgramStages + '/' + programStageId + '.json?fields=id,name,displayName,description,repeatable,captureCoordinates,program[id,name],programStageDataElements[compulsory,sortOrder,allowFutureDate,dataElement[id,name,formName,valueType,optionSetValue,optionSet[id,name,displayName,options[id,name,code]]]]', function( dataObj )
					//dataElement[id,name,formName,type,textType
				{
					// Get dataElements and optionSets data and put into memory.
					me.processDataElementsAndOptionSets( dataObj );

					if ( runFunc !== undefined )
					{
						runFunc( dataObj );
					}
				});
			}

			me.processDataElementsAndOptionSets = function( json_programStage )
			{
				var progStageDEs = json_programStage.programStageDataElements;

				if ( Util.checkValue( progStageDEs ) )
				{
					$.each( progStageDEs, function( i_psde, item_psde )
					{
						var dataElementData = item_psde.dataElement;

						me.insertDirectToMemory( me.dataElementList, 'id', dataElementData.id, dataElementData );

						var optionSetData = dataElementData.optionSet;

						if ( optionSetData !== undefined )
						{
							me.insertDirectToMemory( me.dataElementOptionSets, 'id', optionSetData.id, optionSetData );
						}
					});
				}
			}


			me.retrieveOrgUnitName = function( orgUnitId, runFunc )
			{
				me.retrieveFromMemory( me.orgUnitNameList, 'id', orgUnitId, _queryURL_OrgUnit + '/' + orgUnitId + '.json?fields=id,name', function( dataObj )
				{
					runFunc( dataObj );
				});
			}


			me.retrieveProgramStageList = function( runFunc )
			{
				me.retrieveFromMemory( me.programStageList_Full, 'id', 'programStageFull', _queryURL_ProgramStages + '.json?paging=false&fields=id,name,displayName,description,repeatable,captureCoordinates,program[id,name],programStageDataElements[compulsory,sortOrder,allowFutureDate,dataElement[id,name,formName]]'
					, function( json_programStageList )
					{
						if ( runFunc !== undefined )
						{
							runFunc( json_programStageList );
						}
					}
				);
			}


			me.retrieveProgramListWithStage_Full = function( runFunc )
			{
				if ( me.programListWithStage_Full !== undefined )
				{
					runFunc( me.programListWithStage_Full );
				}
				else
				{
					me.retrieveFromMemory( me.programList_Full, 'id', 'programFull', _queryURL_ProgramList + '?paging=false&fields=id,name,programType,onlyEnrollOnce,trackedEntity[id,name]'
						, function( json_programList )
						{	
							me.retrieveProgramStageList( function( json_programStageList )
								{
									me.programListWithStage_Full = me.setProgramWithStage( json_programList.programs, json_programStageList.programStages );

									runFunc( me.programListWithStage_Full );
								}
							);

						}
					);
				}
			}


			// --- Each data retrieval method
			// ---------------------------------------

			// Retrieve from API or from memory if already retrieved.
			// This use queueing in case the data is already being in process of retrieving, but not yet finished.  We could use event call for each..
			me.retrieveFromMemory = function( dataList, idName, idValue, requestUrl, runFunc )
			{

				var json_Data = Util.getFromList( dataList, idValue, idName );

				if ( json_Data === undefined )
				{
					// For the first time requesting, create a queue and run Async..

					var dataNew = {};
					
					dataNew[ idName ] = idValue;
					dataNew.data = null;
					dataNew.requestQueue = new Array();
					dataNew.requestQueue.push( runFunc );

					dataList.push( dataNew );


					// Retrieve it
					RESTUtil.getAsynchData( requestUrl, function( dataObj ) 
					{
						// Once it gets data, run all the return functions..
						json_Data = Util.getFromList( dataList, idValue, idName );

						if ( Util.checkDefined( json_Data ) )
						{

							// TODO: run custom function if exists?


							json_Data.data = dataObj;

							$.each( json_Data.requestQueue, function( i_func, item_func )
							{
								item_func( dataObj );
							});

							// reset the queue.
							json_Data.requestQueue = new Array();
						}
						else
						{
							Util.write( 'RESTUtil.getAsynchData FOR MEMORY get undefined value back! - idName:' + idName + ', idValue:' + idValue + ', dataList:' + JSON.stringify( dataList ) );
						}

					});
				}
				else
				{
					if ( Util.checkDefined( json_Data.data ) )
					{
						runFunc( json_Data.data );

						// ?? run any queue function if still here?
					}
					else
					{
						// Add return fucntions to the queue.
						json_Data.requestQueue.push( runFunc );
					}
				}
			}


			me.insertDirectToMemory = function( dataList, idName, idValue, data )
			{
				var dataNew = {};
				
				dataNew[ idName ] = idValue;
				dataNew.data = data;
				dataNew.requestQueue = new Array();

				dataList.push( dataNew );
			}

			// -------------------
			// -- Helper methods

			me.setProgramWithStage = function( programs, programStages )
			{
				for( j = 0; j < programStages.length; j++ )
				{
					var item_stage = programStages[j];

					if ( item_stage.program !== undefined )
					{

						for( i = 0; i < programs.length; i++ )
						{
							if ( programs[i].id == item_stage.program.id )
							{
								var programMatch = programs[i];

								if ( programMatch.programStages === undefined )
								{
									programMatch.programStages = [];
								}

								programMatch.programStages.push( item_stage );

								break;
							}
						}
					}
				}

				return programs;
			}

			// -- Helper methods
			// -------------------

			// Run methods
			// --------------------------


			// --------------------------
			// Get methods

			me.getProgramList_Full = function()
			{
				return me.programListWithStage_Full; // pme.programList_Full[0].data;
			}

			me.getProgramStageList_Full = function()
			{
				return me.programStageList_Full[0].data;
			}

			// Get methods
			// --------------------------
		}

		// Data In Memory Class
		// -------------------------------------------


		// -------------------------------------------
		// -- ProgramRule Class
		function ProgramRule( TabularDEObj )
		{
			var me = this;

			me.TabularDEObj = TabularDEObj;

			me.loadedRules = [];

			me.varType = { "dataElement": "dataElement", "attribute": "attribute" };

			me.areaTagType = { "Event_DE": "Event_DE", "TEI_Attribute": "TEI_Attribute" };


			// 'rule' object has 'condition', 'programRuleActions'
			// later added 'conditionObjects', 'varTypesUsed'

			// -------------------------------

			// Initial Setup Call
			me.initialSetup = function()
			{				
			}

			// ----------------------------------------
			// -- 2 main functions --------------------

			// 1. Retrieve and Set Program Rule vairables to program Object
			me.RetrieveAndSet_ProgramRulesAndVariables = function( programObj )
			{
				if ( programObj !== undefined )
				{
					// Retrieve program Rules and Vairables  <-- if not already exists..
					me.retrieveProgramRules( programObj.id, function( json_Data )
					{

						if ( programObj.rules === undefined ) programObj.rules = [];
						
						$.each( json_Data.programRules, function( i_rule, item_rule )
						{
							var programRules = Util.getFromList( programObj.rules, item_rule.id, "id" )

							// if does not exists already, add it to the list.
							if ( programRules === undefined )
							{
								programObj.rules.push( item_rule );
							}
						});

					});


					me.retrieveProgramRuleVariables( programObj.id, function( json_Data )
					{
						if ( programObj.ruleVariables === undefined ) programObj.ruleVariables = [];
						
						$.each( json_Data.programRuleVariables, function( i_ruleVars, item_ruleVars )
						{
							var programRuleVariables = Util.getFromList( programObj.ruleVariables, item_ruleVars.id, "id" )

							if ( programRuleVariables === undefined )
							{
								programObj.ruleVariables.push( item_ruleVars );
							}
						});
					});
				}
			};


			// 2. Set ProgramRules on the form / event tags..
			// 'stageId' is not being used for now, but only being populated as attributes in tags.
			me.setUp_ProgramRules = function( areaType, personId, areaTag, tdTags, programRules, ruleVariables )
			{

				if ( programRules !== undefined && programRules.length > 0 )
				{

					// Resolve Rule
					var ruleIdList = [];

					
					// Check if the program rule already exists on the loaded memory (by checking id), and only load it to memory if it does not exists..
					// Take care of resolving rules as well..
					for( var i = 0; i < programRules.length; i++ )
					{
						ruleIdList.push( me.getAndSetRulesInMemory_WithResolved( programRules[i], ruleVariables ) );
					}

					me.setFormTag( areaType, personId, 'fakeStageId', ruleIdList, areaTag, tdTags );
				}
			};


			// ReRun the program rules
			me.reRun_AllProgramRules = function( areaType, personId, areaTags, programRules, ruleVariables )
			{
				// if areaTag is not empty..
				if ( areaTags.length > 0 && programRules !== undefined && programRules.length > 0 )
				{
					// Get Rule ID List
					var ruleIdList = [];
					
					for( var i = 0; i < programRules.length; i++ )
					{
						ruleIdList.push( me.getAndSetRulesInMemory_WithResolved( programRules[i], ruleVariables ) );
					}


					// If multiple rows exists, perform them one by one.
					areaTags.each( function( i )
					{
						var areaTag = $( this );
					
						me.performAllProgramRules( areaType, areaTag, ruleIdList, personId );
					});
				}
			};


			// ---------------------------------------------
			// -- Related Methods --------------------


			me.getAndSetRulesInMemory_WithResolved = function( programRule, ruleVariables )
			{
				var ruleId = programRule.id;

				var rule = me.getRuleDetailById( ruleId );

				if ( rule === undefined )
				{
					me.loadedRules.push( me.resolveRule( programRule, ruleVariables ) );
				}

				return ruleId;
			};


			me.getRuleDetailById = function( ruleId )
			{
				var ruleDetail;

				$.each( me.loadedRules, function( i_rule, item_rule )
				{
					if ( item_rule.id == ruleId )
					{
						ruleDetail = item_rule;
						return false;
					}
				});

				return ruleDetail;
			};

			// ------------------------


			me.retrieveProgramRules = function( programId, returnFunc )
			{
				var queryUrl = _queryURL_ProgramRules + '.json?paging=false&fields=id,condition,programRuleActions[id,programRuleActionType,dataElement[id],content,trackedEntityAttribute[id,name]]&filter=program.id:eq:' + programId;

				RESTUtil.getAsynchData( queryUrl, function( json_Data ) 
				{
					returnFunc( json_Data );
					//json_Data.programRules;
				});
			};


			me.retrieveProgramRuleVariables = function( programId, returnFunc )
			{
				var queryUrl = _queryURL_ProgramRuleVariables + '.json?paging=false&fields=id,name,programRuleVariableSourceType,program[id],programStage[id],trackedEntityAttribute[id],dataElement[id,valueType]&filter=program.id:eq:' + programId;

				RESTUtil.getAsynchData( queryUrl, function( json_Data ) 
				{
					returnFunc( json_Data );
					//json_Data.programRuleVariables;
				});
			};


			// -------------------------------------

			me.resolveRule = function( pRule, ruleVariables )
			{
				// Mainly used for translating Condition variable name into Uid.
				// Also, build the Used Object List in both Condition & Action.
				// Also, build the condition / action variable type used ( between dataElements and TEI attributes )

				// Replace the variable name to object id (ex. data Element id --> #{eed234sdf} )
				// - for attribute, it use A{--uid--} rather than #{--}


				var rule = JSON.parse( JSON.stringify( pRule ) );
				var condition = rule.condition;
				//var actions = rule.programRuleActions;

				rule.conditionObjects = [];
				rule.actionObjects = [];
				rule.varTypesUsed = { condition: { attributes: [], dataElements: [] }, action: { attributes: [], dataElements: [] } };
				rule.subRules = [];
				
				for( var j=0; j < ruleVariables.length; j++ )
				{
					var ruleVariable = ruleVariables[j];
					var type = ruleVariable.programRuleVariableSourceType;

					//type == "TEI_ATTRIBUTE" vs "DATAELEMENT_..." 
					var variableId = me.convertObjectIdToVariable( type, ruleVariable.name );


					if( condition.indexOf( variableId ) >= 0 )
					{
						var objectId = me.getObjectIdFromVariable( type, ruleVariable );
						
						// Collect the condition variables
						me.collectConditionVariables( objectId, type, ruleVariable, rule.conditionObjects );

						// Convert condition variable with name --> to Uid
						rule.condition = rule.condition.split( variableId ).join( me.convertObjectIdToVariable( type, objectId ) );

						// Collect the variable type - used in Condition
						me.collectVariableTypesUsed_Condition( rule.varTypesUsed.condition, type, objectId );
					}
				}
				
				// Get SubRules
				var conditionList = rule.condition.split( /[&&|\|\|]/g );
				
				for( var i in conditionList )
				{
					if( conditionList[i] !== "" )
					{
						var subRule = {};
						subRule.condition = conditionList[i];
						subRule.conditionObjects = [];
						
						for( var j=0; j < ruleVariables.length; j++ )
						{
							var ruleVariable = ruleVariables[j];
							var type = ruleVariable.programRuleVariableSourceType;
							var objectId = me.getObjectIdFromVariable( type, ruleVariable );
	
							if( subRule.condition.indexOf( objectId ) >= 0 )
							{
								// Collect the condition variables
								me.collectConditionVariables( objectId, type, ruleVariable, subRule.conditionObjects );
								subRule.condition = subRule.condition.split( variableId ).join( me.convertObjectIdToVariable( type, objectId ) );
							}
						}
						
						rule.subRules.push( subRule );
					}
				}

				// Collect the condition variables
				me.collectActionVariables( rule.programRuleActions, rule.actionObjects );
				
				// Collect the variable type - used in Action
				me.collectVariableTypesUsed_Action( rule.varTypesUsed.action, rule.programRuleActions );
				
				
				return rule;
			};

			
			// TODO: Need to pass the person ID!!!!
			me.setFormTag = function( areaType, personId, stageId, ruleIdList, areaTag, tdTags )
			{			
				// Rows are already created.  We need to tag them.
				//var rowTag = me.createRow( json_Data.programStages[j].id, psDataElements[i].dataElement, ruleIdList );

				if( ruleIdList.length > 0 )
				{
					// 1. Populate the Rule Related Tags First
					tdTags.each( function( index ) 
					{
						var tdTag = $( this ); 
						var elementId = ( areaType == me.areaTagType.Event_DE ) ? tdTag.attr( "deid" ) : tdTag.attr( "attributeid" ) ;

						if( Util.checkValue( elementId ) )
						{

							// NOTE: FOR NOW, ONLY IMPLEMENT 'INPUT' TAG ONES.
							var valTag = tdTag.find( FormUtil.getStr_Views() ).first();

							
							if ( valTag.length > 0 )
							{
								// Mark the tag that are needed for rule
								valTag.attr( 'rule_deId', elementId ).attr( 'rule_stageId', stageId );
						
								var rulePreloaded = "";
								var deRuleIdList = [];

								for ( var j = 0; j < ruleIdList.length; j++ )
								{
									var ruleId = ruleIdList[j];
									var rule = me.getRuleDetailById( ruleId );

									if( Util.findItemFromList( rule.conditionObjects, "id", elementId ) )
									{
										deRuleIdList.push( ruleId );
									}								
								}


								// Mark each tag with rule and setup the Change event.
								if( deRuleIdList.length > 0 )
								{
									valTag.attr( "rules", JSON.stringify( deRuleIdList ) );


									valTag.change( function()
									{
										// Execute all the rules related to the changed value.
										var rules = me.getRulesFromStr( $( this ).attr( "rules" ) );
										var valType = $( this ).attr( "valtype" );

										$.each( rules, function( i_rule, item_rule )
										{
											me.performProgamRuleForDataElement( areaType, areaTag, item_rule, personId );
										});
									});
								}
							}
						}					
					});


					// onLoad, execute all the rules once. - Including mixed hidden cases.
					me.performAllProgramRules( areaType, areaTag, ruleIdList, personId );

				}
			};


			me.performAllProgramRules = function( areaType, areaTag, ruleIdList, personId )
			{
				// onLoad, execute all the rules once. - Including mixed hidden cases.
				$.each( ruleIdList, function( i_rule, ruleId )
				{
					var rule = me.getRuleDetailById( ruleId );

					me.performProgamRuleForDataElement( areaType, areaTag, rule, personId );
				});
			}


			// -----------------------------------

			me.getRulesFromStr = function( ruleIdListAttr )
			{
				var rules = [];

				if ( ruleIdListAttr !== undefined && ruleIdListAttr != "" )
				{
					var ruleIdList = JSON.parse( ruleIdListAttr );

					for( var i=0; i < ruleIdList.length; i++ )
					{
						rules.push( me.getRuleDetailById( ruleIdList[i] ) );
					}
				}

				return rules;
			};
		

			// Perform action if the condition returns true.
			me.performProgamRuleForDataElement = function( areaType, areaTag, rule, personId )
			{
				//var ruleIdListAttr = deValTag.attr( "rules" );
				//var ruleId = ruleIdList[i];
				//var rule = me.getRuleDetailById( ruleId );

				if ( rule === undefined )
				{
					console.log( 'rule is undefined' );						
				}
				else
				{	
					me.checkConditionFromRule( areaType, areaTag, personId, rule, function( valid )
					{
						// CONSOLE
						//console.log( 'rule performed: ' + valid );

						// Per ProgramRule Action, find the action Target Control, and perform it.
						for( var j = 0; j < rule.programRuleActions.length; j++ )
						{
							var action = rule.programRuleActions[j];


							var targetDeId = ''
							if ( action.dataElement !== undefined ) targetDeId = action.dataElement.id;
							else if ( action.trackedEntityAttribute !== undefined ) targetDeId = action.trackedEntityAttribute.id;


							var targetTag = areaTag.find( "[rule_deId='" + targetDeId + "']" );


							// Reset the action info..
							// Clear the previous warning message
							areaTag.find( "img.action_Msg_" + action.id + "" ).remove();

							var actionTag = areaTag.find( ".action_Hidden_" + action.id );

							if ( actionTag.length > 0 )
							{
								actionTag.removeClass( "action_Hidden_" + action.id );
								
								//** IF THERE ARE OTHER HIDDEN Actions, do not enable it!!
								if ( actionTag.filter( "[class*=action_Hidden]" ).length == 0 )
								{
									actionTag.prop( 'disabled', false ).removeClass( "markDisabled" );
								}
							}


							// If the rule condition is valid, perform the action.
							if ( valid )
							{
								// ** It it marked with 'action_sourceDeId' only if the
								// action was taken <-- Like hidden.
								if( action.programRuleActionType == 'HIDEFIELD' )
								{
									targetTag.addClass( "action_Hidden_" + action.id );

									if ( !targetTag.hasClass( "markDisabled" ) ) targetTag.addClass( "markDisabled" );

									// Disable the tag..
									targetTag.prop( 'disabled', true );

								}
								else if( action.programRuleActionType == 'SHOWERROR' )
								{
									targetTag.after( '<img class="action_Msg_' + action.id + '  ruleStatus ruleError" alt="Rule Status" title="' + action.content + '" src="img/status_red.png" >' );
								}
								else if( action.programRuleActionType == 'SHOWWARNING' )
								{
									targetTag.after( '<img class="action_Msg_' + action.id + ' ruleStatus ruleWarning" alt="Rule Status" title="' + action.content + '" src="img/status_yellow.png">' );
								}
							}
						}
					});
				}
			};

			// -------------------------------------

			me.checkConditionFromRule = function( areaType, areaTag, personId, rule, returnFunc )
			{	
				try
				{
					me.getConditionObjValues( areaType, areaTag, personId, rule.conditionObjects, function( objValues )
					{
						if ( rule.conditionObjects.length == Util.getObjPropertyCount( objValues ) )
						{
							var condition = rule.condition;
							
							for( var i in rule.subRules )
							{
								var subValid = me.checkConditionFromRule_Inner( objValues, rule.subRules[i] );
								condition = condition.replace( rule.subRules[i].condition, " " + subValid  + " " );
							}
							
							var valid = eval( condition );
							returnFunc( valid );
						}
						else
						{
							// If object (DE) does not hold value, we do not need to proceed with condition calculation - it is 'not match' case automatically.
							console.log( 'condition object NOT MATCHED - conditionObjValue count' );
						}
					});					
				}
				catch (err)
				{
					// mesage show..
					MsgManager.msgAreaShow( "Error occurred during programRule processing.." );
					console.log( 'ProgramRule Error: ' + err );
					returnFunc( false );
				}
			};


			// TODO: item_Person OR item_lastEvent!!
			me.checkConditionFromRule_Inner = function( objValues, rule )
			{	
				// This handles multiple condition variable values comparison/mathmatics in a rule condition.

				var conditionObjects = rule.conditionObjects;

				var condition = rule.condition;
				var flag = true;
				var isMathCondition = true;
				
				
				// Check if there is any mathematic condition in the rule, such as ' a + b == c '
				for( var i in conditionObjects )
				{
					var valueType = conditionObjects[i].valueType;
					if( valueType != 'NUMBER' && valueType != 'INTEGER' && valueType != 'INTEGER_ZERO_OR_POSITIVE' 
						&& valueType != 'INTEGER_POSITIVE' && valueType != 'INTEGER_NEGATIVE'
						&& valueType != 'TRUE_ONLY' && valueType != 'BOOLEAN' )
					{
						isMathCondition = false;
					}
				}
								
				for( var i = 0; i < conditionObjects.length; i++ )
				{
					var conditionObject = conditionObjects[i];

					var deValue = ( objValues[ conditionObject.id ] !== undefined ) ? objValues[ conditionObject.id ] : "";
	
					if( deValue != "" )
					{
						var joinValue = isMathCondition ? deValue : "'" + deValue + "'";

						condition = condition.split( me.convertObjectIdToVariable( conditionObject.type, conditionObject.id ) ).join( joinValue );
					}
					else
					{
						flag = false;
					}
				}
				
				//console.log( 'flag: ' + flag + ', condition: ' + condition );
				// Check if there is any mathematic condition in the rule
				//if( flag )
				//{
					/* var subConditions = condition.split( /(&&|\|\|)/g );

					for( var j = 0; j < subConditions.length; j ++ )
					{
						var subResult = me.checkSimgleMathInCondition( condition );						
						condition = condition.split( condition ).join( subResult );
					} */
					
				//	flag = eval( condition );
				//}
				
				// CONSOLE
				//console.log( 'checkConditionFromRule_Inner, flag: ' + flag + ', math: ' + isMathCondition + ', condition: ' + condition );

				// return ( flag ) ? eval( condition ) : flag;
				return condition;
			};


			// Return only when all the values are retrieved or tried.
			me.getConditionObjValues = function( areaType, areaTag, personId, conditionObjects, returnFunc )
			{	
				var objValues = {};
				var totalCount = conditionObjects.length;
				var checkCount = 0;

				var orgUnitId = TabularDEObj.getOrgUnitId();
				var programId = TabularDEObj.getSelectedProgramId();


				// CONSOLE
				// Run the loading progress bar for this!!!!
				// $( '#programRuleLoading' ).show();


				$.each( conditionObjects, function( i_obj, item_obj )
				{

					// On demand or From Tag - find value.  
					// If not found matching tab, we expect 'undefined' to be there..
					if ( areaType == me.areaTagType.Event_DE )
					{
						if ( item_obj.type == EventUtil.varSrcType_DE_CurrentEvent )
						{
							if ( areaTag !== undefined && areaTag.length > 0 )
							{
								var conditionValTag = areaTag.find( "[rule_deId='" + item_obj.id + "']" );

								if ( conditionValTag.length > 0 )
								{
									objValues[ item_obj.id ] = conditionValTag.val();
								}
							}

							checkCount++;
						}
						else if ( item_obj.type == EventUtil.varSrcType_TEI_Attribute )
						{
							// Retrieve TEI_Attribute values first, and then, get data..
							PersonUtil.getPersonByID_Reuse( personId, function( item_Person )
							{
								// Check the count and only if the count is filled, call returnFunc
								var attributeData = Util.getFromList( item_Person.attributes, item_obj.id, "attribute" );

								if ( attributeData !== undefined ) objValues[ item_obj.id ] = attributeData.value;

							}, function()
							{
								checkCount++;

								if ( checkCount >= totalCount ) 
								{
									$( '#programRuleLoading' ).hide();
									returnFunc( objValues );
								}
							});
						}
						else
						{
							console.log( 'The programRule SOURCE Type, ' + item_obj.type + ', has not been implemented for now.' );

							// DISABLE THIS FOR NOW - FOR STABILITY
							// NOTE:
							//  - DUE TO this value happening before
							//		saving, the change of the value are not used in the programRule, which causes issue (due to previous value being used on the rule).
							//	- TO RESOLVE this, we have to clearly set how the rules will affect the value saving..

							/*
							// in Event_DE AreaType, 'areaTag' is eventRowTag
							var progStageId = EventUtil.getProgramStageId_FromRow( areaTag );
							var eventId = EventUtil.getEventId_FromRow( areaTag );

							EventUtil.getEventBySrcType( false, orgUnitId, programId, personId, item_obj.type, item_obj.programStageId, eventId, function( item_Event )
							{
								// CONSOLE
								console.log( 
								item_Event.dataValues ); 
								
								// Check the count and only if the count is filled, call returnFunc
								var dataElementData = Util.getFromList( item_Event.dataValues, item_obj.id, "dataElement" );

								if ( dataElementData !== undefined ) objValues[ item_obj.id ] = dataElementData.value;

							}, function()
							{
								checkCount++;

								if ( checkCount >= totalCount ) 
								{
									$( '#programRuleLoading' ).hide();
									returnFunc( objValues );
								}
							});
							*/
						}
					}
					else if ( areaType == me.areaTagType.TEI_Attribute )
					{
						if ( item_obj.type == EventUtil.varSrcType_TEI_Attribute )
						{
							if ( areaTag !== undefined && areaTag.length > 0 )
							{
								var conditionValTag = areaTag.find( "[rule_deId='" + item_obj.id + "']" );

								if ( conditionValTag.length > 0 )
								{
									objValues[ item_obj.id ] = conditionValTag.val();
								}
							}

							checkCount++;
						}
						else
						{
							// For event variables, get latest event on the program for the TEI(person)
							EventUtil.getEventBySrcType( false, orgUnitId, programId, personId, EventUtil.varSrcType_DE_NewestEventInProgram, undefined, undefined, function( item_Event )
							{
								// Check the count and only if the count is filled, call returnFunc
								var dataElementData = Util.getFromList( item_Event.dataValues, item_obj.id, "dataElement" );

								if ( dataElementData !== undefined ) objValues[ item_obj.id ] = dataElementData.value;

							}, function()
							{
								checkCount++;

								if ( checkCount >= totalCount ) 
								{
									$( '#programRuleLoading' ).hide();
									returnFunc( objValues );
								}
							});
						}
					}
				});


				if ( checkCount >= totalCount ) 
				{
					$( '#programRuleLoading' ).hide();
					returnFunc( objValues );
				}
			};

			
			me.convertObjectIdToVariable = function( type, id )
			{
				return ( type == EventUtil.varSrcType_TEI_Attribute ) ? "A{" + id + "}" : "#{" + id + "}";
			};
			
			me.getObjectIdFromVariable = function( type, ruleVariable )
			{
				return ( type == EventUtil.varSrcType_TEI_Attribute ) ? ruleVariable.trackedEntityAttribute.id : ruleVariable.dataElement.id;
			};

			// ------------------

			me.collectVariableTypesUsed_Condition = function( condition, varType, id )
			{
				// var varTypesUsed =  { condition: { attributes: [], dataElements: [] }, action: { attributes: [], dataElements: [] } };
				( varType == EventUtil.varSrcType_TEI_Attribute ) ? condition.attributes.push( id ) : condition.dataElements.push( id );
			};

			me.collectVariableTypesUsed_Action = function( action, programRuleActions )
			{
				// var varTypesUsed =  { condition: { attributes: [], dataElements: [] }, action: { attributes: [], dataElements: [] } };

				$.each( programRuleActions, function( i_action, item_action )
				{
					if ( item_action.trackedEntityAttribute !== undefined )
					{
						action.attributes.push( item_action.trackedEntityAttribute.id );
					}
					else if ( item_action.dataElement !== undefined )
					{
						action.dataElements.push( item_action.dataElement.id );
					}
				});
			};

			// ------------------

			me.collectConditionVariables = function( objectId, type, ruleVariable, conditionObjects )
			{
				var conditionObject = {};
				conditionObject.id = objectId;
				conditionObject.type = type;
				conditionObject.valueType = ruleVariable.dataElement.valueType;

				if( ruleVariable.programStage !== undefined )
				{
					conditionObject.programStageId = ruleVariable.programStage.id;
				}
				
				conditionObjects.push( conditionObject );
			};
				
			me.collectActionVariables = function( programRuleActions, actionObjects )
			{
				$.each( programRuleActions, function( i_action, item_action )
				{
					var objId = "";

					if ( item_action.trackedEntityAttribute !== undefined )
					{
						objId = item_action.trackedEntityAttribute.id;
					}
					else if ( item_action.dataElement !== undefined )
					{
						objId = item_action.dataElement.id;
					}

					if ( objId != "" && actionObjects.indexOf( objId ) >= 0 )
					{
						actionObjects.push( objId );
					}
				});
			};

			// ------------------


			me.checkConditionVarType = function( condition, varType ) // ruleIdList )
			{
				var matchFound = false;

				if ( varType == me.varType.dataElement )
				{
					if ( condition.dataElements.length > 0 )
					{
						matchFound = true;
					}
				}
				else if ( varType == me.varType.attribute )
				{
					if ( condition.attributes.length > 0 )
					{
						matchFound = true;
					}
				}

				return matchFound;
			};

			me.checkSimgleMathInCondition = function( matchStr )
			{
				var result = matchStr;
				var maths = matchStr.split( /(==|>=|<=|=|!=|<>|>|<)/g );
				
				// Check if mathematic string like this 'a + b == c'
				if( maths.length == 3 )
				{
					var value = eval( maths[0] );
					result = result.split( maths[0] ).join( value );	
				}
				
				// CONSOLE
				//console.log( 'checkSimgleMathInCondition, result: ' + result );
				//console.log( maths );

				return eval( result );
			};
			
			me.getOperators = function( condition )
			{
				var patt = new RegExp("(>=|<=|=|!=|<>|>|<)");
				var operator = patt.exec(condition);
				return operator;
			};


			// --------------------------
			// Run methods

			// Initial Run Call
			me.initialSetup();

		}
		// -- ProgramRule Class ---------------
		// -------------------------------------------

		// -------------------------------------------
		// -- ProgramRuleUtil Static Classes
		
		function ProgramRuleUtil() {}

		ProgramRuleUtil.checkProgramRuleData = function( areaTag )
		{
			var pass = true;

			// Program Rule error case occurances
			if ( areaTag.find( "img.ruleError" ).length > 0 )
			{
				pass = false;
				alert( $( 'span.msg_ProgramRuleError' ).text() );
			}

			return pass;
		};

		// -- ProgramRuleUtil Static Classes
		// -------------------------------------------


		// ============================================================================
		// ============================================================================


		// -------------------------------------------
		// Class - PersonDialogForm
		//		- Used for popup Person Add/Edit Form

		function PersonDialogForm( TabularDEObj )
		{
			var me = this;

			me.TabularDEObj = TabularDEObj;

			me.type_New = "New";
			me.type_Exist = "Exist";

			me.personDialogFormTag = $( "#personDialogForm" );

			me.personDialogTableTag = me.personDialogFormTag.find( "#person_Table" );

			me.currentPersonTr;

			me.json_PersonAttributes;

			me.trackedEntityId_Person;

			me.afterSaveAction;


			// -------------------------------------------
			// Methods

			me.openForm = function( currentTr, formType, returnFunc, afterSaveAction )
			{
				me.currentPersonTr = currentTr;

				me.afterSaveAction = afterSaveAction;


				// Make sure the attribute list is loaded first.
				me.checkAndLoadPersonAttributeData( function()
				{
					if ( me.setupForm( currentTr, formType ) )
					{
						// Set Program Rules - Attribute ones..
						var selectedProgram = me.TabularDEObj.getSelectedProgram();
						var personId = currentTr.attr( 'uid' );

						// Clear Memory Stored Event data.
						EventUtil.clearLatestEvent_Reuse( me.TabularDEObj, personId );

						// Add Program Rules (with events?)
						me.TabularDEObj.programRule.setUp_ProgramRules( 'TEI_Attribute', personId, me.personDialogTableTag, me.personDialogTableTag.find( 'td[type="attribute"]' ), selectedProgram.rules, selectedProgram.ruleVariables );


						me.personDialogFormTag.dialog( "open" );
					}

					if ( returnFunc !== undefined ) returnFunc();
				});
			}

			// ----------------------------------------------


			me.setupForm = function( trCurrent, type )
			{
				var setupStatus = false;
				var orgUnitId = me.TabularDEObj.getOrgUnitId();
				var defaultProgramId = me.TabularDEObj.getSelectedProgramId();


				if ( !Util.checkValue( defaultProgramId ) )
				{
					alert( $( 'span.msg_SelectDefaultProgram' ).text() );
				}
				else
				{

					// Clear Table
					me.personDialogTableTag.find( "tr" ).remove();


					var button_Create = $( ".ui-dialog-buttonpane button:contains('Create')" ).button();
					var button_Update = $( ".ui-dialog-buttonpane button:contains('Update')" ).button();

					button_Create.hide();
					button_Update.hide();


					me.personDialogFormTag.find( "#person_formType" ).val( type );
					

					// Render Attributes
					// Step 2. Add template row to the table <-- via append
					var programTrackedEntityAttributes = me.TabularDEObj.getProgramTrackedEntityAttributes();

					
					me.personDialogTableTag.append("<tr><th colspan='2' style='font-weight:bold; color: #555;'>" + l10n.get('attributes') + "</th></tr>");
					me.RenderPersonElements( programTrackedEntityAttributes, me.SetRowControls_Attribute );


					// Depending on 'New' or 'Existing' person data, populate the existing data.
					if( type == me.type_New ) 
					{
						// Load the suggested value
						var person_SuggestedTd = trCurrent.find( "td[type='attribute_0']" );
						var person_SuggestedVal = person_SuggestedTd.find( ".personSelect" ).val();
						var person_SuggestedAttrbuiteId = person_SuggestedTd.attr( 'attributeid' );

						me.SetRowControls_Attribute( person_SuggestedAttrbuiteId, false, person_SuggestedVal, true );

						button_Create.show();
					}					
					else if ( type == me.type_Exist )
					{

						button_Update.show();
						

						var personId = trCurrent.attr( 'uid' );
						me.personDialogFormTag.find( "#person_id" ).val( personId );



						// Clear the memory data - so that new data gets
						PersonUtil.clearPersonByID_Reuse( personId );

						// ?? TODO: Question: Why is this done by Synch??
						var item_Person = PersonUtil.getPersonByID( personId );



						// For person attributes, add value, and if not in program, hide them.
						PersonUtil.addIDtypeToID( item_Person );
						
						
						//Util.write( " ID create: " + JSON.stringify( item_Person ) );

						if ( Util.checkDefined( item_Person ) )
						{
							// This also renders non-program specific attributes as hidden.
							me.RenderPersonElements( item_Person.attributes, me.SetRowControls_Attribute, true );
						}
						else
						{
							alert( $( 'span.msg_PersonNotFound' ).text() );
						}
										
						// View Only
						//Util.disableTag( me.personDialogFormTag.find( "#person_Table" ).find( "input,select" ), true )

					}
						

					Util.setupDatePicker( me.personDialogTableTag.find( ".datepicker[caltype='none']" ), undefined, _dateFormat_Picker_YYMMDD_Dash );

					Util.setupDatePicker( me.personDialogTableTag.find( ".datepicker[caltype='birth']" ), undefined, _dateFormat_Picker_YYMMDD_Dash, "birthdate" );

					setupStatus = true;
				}

				return setupStatus;
			}


			me.FormPopupSetup = function()
			{

				// -- Set up the form -------------------
				me.personDialogFormTag.dialog({
				  autoOpen: false,
				  dialogClass: "noTitleStuff",
				  width: 430,
				  height: 400,
				  modal: true,
				  buttons: {
					"Create": function() {

						var dialogForm = $( this );

						// Perform the mandatory filled check first.
						if ( me.checkFieldsData() && ProgramRuleUtil.checkProgramRuleData( me.personDialogTableTag ) )
						{
							var orgUnitId = me.TabularDEObj.getOrgUnitId();
							var defaultProgramId = me.TabularDEObj.getSelectedProgramId();
							var defaultDateInFormat = $.format.date( me.TabularDEObj.getDefaultStartDate(), _dateFormat_YYYYMMDD_Dash );

							me.checkDuplicateData( orgUnitId, defaultProgramId, undefined, function()
							{
								var personData  = me.setupPersonData( orgUnitId );

								RESTUtil.submitData( personData, _queryURL_PersonSubmit, "POST"
									, function( returnData )
									{
										if ( returnData.response === undefined || returnData.response.status != 'SUCCESS' )
										{
											me.personCreateUpdate_Fail_Handle( returnData );
										}
										else
										{																					
											var personId = returnData.response.reference;

											if ( Util.checkDefined( personId ) )
											{
												MsgManager.msgAreaShow( $( 'span.msg_PersonCreated' ).text() );
												 

												// Enroll
												me.TabularDEObj.checkProgramEnroll( personId, defaultProgramId, orgUnitId
												, function() 
												{
													if ( me.afterSaveAction !== undefined ) me.afterSaveAction();
												}
												, function()
												{
													me.TabularDEObj.programEnroll( personId, defaultProgramId, orgUnitId, defaultDateInFormat
													, function( returnData )
													{
														MsgManager.msgAreaShow( $( 'span.msg_ProgramEnrolled' ).text() );
														if ( me.afterSaveAction !== undefined ) me.afterSaveAction();
													}
													, function( returnData )
													{
														alert( $( 'span.msg_ProgramEnrollFailed' ).text() + '\n\n Error: ' + JSON.stringify( returnData ) );
													});
												});

												
												PersonUtil.getPersonByID_Reuse( personId, function( item_Person )
												{
													me.TabularDEObj.setPersonInfoRow( me.currentPersonTr, item_Person );

													// Auto Close after Create New
													dialogForm.dialog( "close" );
													me.currentPersonTr.find( '.personInfo' ).focus();
												});
											}
										}
									}
									, me.personCreateUpdate_Fail_Handle
								);
							});
						}

					},
					"Update": function() {

						var dialogForm = $( this );

						// Perform the mandatory filled check first.
						if ( me.checkFieldsData() && ProgramRuleUtil.checkProgramRuleData( me.personDialogTableTag ) )
						{
							var orgUnitId = me.TabularDEObj.getOrgUnitId();
							var defaultProgramId = me.TabularDEObj.getSelectedProgramId();
							var defaultDateInFormat = $.format.date( me.TabularDEObj.getDefaultStartDate(), _dateFormat_YYYYMMDD_Dash );

							var personId = me.personDialogFormTag.find( "#person_id" ).val();

							me.checkDuplicateData( orgUnitId, defaultProgramId, personId, function()
							{

								var personData  = me.setupPersonData( orgUnitId );

								RESTUtil.submitData( personData, _queryURL_PersonSubmit + '/' + personId, "PUT"
									, function( returnData )
									{

										if ( returnData.response === undefined || returnData.response.status != 'SUCCESS' )
										{
											me.personCreateUpdate_Fail_Handle( returnData );
										}
										else
										{

											MsgManager.msgAreaShow( $( 'span.msg_PersonInfoUpdated' ).text() );
		

											// Enroll
											me.TabularDEObj.checkProgramEnroll( personId, defaultProgramId, orgUnitId
											, function() 
											{
												if ( me.afterSaveAction !== undefined ) me.afterSaveAction();
											}
											, function()
											{
												me.TabularDEObj.programEnroll( personId, defaultProgramId, orgUnitId, defaultDateInFormat
												, function( returnData )
												{
													MsgManager.msgAreaShow( $( 'span.msg_ProgramEnrolled' ).text() );
													if ( me.afterSaveAction !== undefined ) me.afterSaveAction();
												}
												, function( returnData )
												{
													alert( $( 'span.msg_ProgramEnrollFailed' ).text() + '\n\n Error: ' + JSON.stringify( returnData ) );
												});
											});


											// Clear the memory data
											PersonUtil.clearPersonByID_Reuse( personId );

											PersonUtil.getPersonByID_Reuse( personId, function( item_Person )
											{
												me.TabularDEObj.populatePersonAttirbutesToRow( me.currentPersonTr, item_Person.attributes );


												// Re-Run the ProgramRules on Event Rows
												me.reRun_EventRowProgramRules( me.currentPersonTr, personId );


												// Auto Close after Update
												dialogForm.dialog( "close" );
												me.currentPersonTr.find( '.personInfo' ).focus();

											});
										}

									}
									, me.personCreateUpdate_Fail_Handle
								);
							});
						}

					},
					"Close": function() {
						$( this ).dialog( "close" );

						me.currentPersonTr.find( '.personInfo' ).focus();
					}
				  }
				});		
			};

			
			// Re-Run the ProgramRules on Event Rows
			me.reRun_EventRowProgramRules = function( currentPersonTr, personId )
			{
				var selectedProgram = me.TabularDEObj.getSelectedProgram();

				var personEventsTag = currentPersonTr.closest( 'tbody' ).find( 'tr.trPersonDetail[uid="' + personId + '"]' );
				var eventRowTags = personEventsTag.find( 'table.tbStyle_PersonDetail tr.trEventData' );

				me.TabularDEObj.programRule.reRun_AllProgramRules( 'Event_DE', personId, eventRowTags, selectedProgram.rules, selectedProgram.ruleVariables );
			};


			// ----------------------------------------------

			me.getTrackedEntityId_Person = function()
			{
				if ( me.trackedEntityId_Person === undefined )
				{
					var json_TrackedEntities = $.parseJSON( RESTUtil.getSynchData( _queryURL_TrackedEntities + '.json?query=Person' ) );

					for ( i = 0; i < json_TrackedEntities.trackedEntities.length ; i++ )
					{
						var trackedEntity = json_TrackedEntities.trackedEntities[i];

						if ( trackedEntity.displayName == "Person" )
						{
							me.trackedEntityId_Person = trackedEntity.id;
							break;
						}
					}
				}

				if ( me.trackedEntityId_Person === undefined )
				{
					alert( $( 'span.msg_PersonNotFoundDHIS' ).text() );
				}

				return me.trackedEntityId_Person;
			}


			me.checkAndLoadPersonAttributeData = function( returnFunc )
			{
				if ( me.json_PersonAttributes !== undefined )
				{
					returnFunc( me.json_PersonAttributes );
				}
				else
				{
					me.retrievePersonAttributeList( function( json_teAttrs )
					{
						me.json_PersonAttributes = json_teAttrs;

						returnFunc( me.json_PersonAttributes );
					});
				}
			}

			me.retrievePersonAttributeList = function( returnFunc )
			{
				RESTUtil.retrieveManager.retrieveData( _queryURL_PersonAttributes
				, function( json_data ) 
				{
					if ( json_data.trackedEntityAttributes !== undefined ) returnFunc( json_data.trackedEntityAttributes );
					else alert( 'Failed to get "trackedEntityAttributes" from retrieved data.' );
				}
				, function()
				{
					alert( 'Failed to retrieve TEI attribute lists' );	
				});	
			}


			me.getAttributeInfoInMsg = function( inputStr )
			{
				var attributeInfo = {};

				$.each( me.json_PersonAttributes, function( i_attr, item_attr )
				{
					if ( inputStr.indexOf( item_attr.id ) >= 0 )
					{
						attributeInfo = item_attr;
						return false;
					}
				});

				return attributeInfo;
			}


			me.getErrorMessageFormatted = function( inputStr )
			{
				var errorMessage = inputStr.substring( 0, inputStr.indexOf( ':' ) );
	
				var valueStrIndexStart = inputStr.indexOf( ", value='" ) + 9;
				var valueStrIndexEnd = inputStr.indexOf( "'", valueStrIndexStart );

				var errorValue = inputStr.substring( valueStrIndexStart, valueStrIndexEnd );

				var attributeInfo = me.getAttributeInfoInMsg( inputStr );
				
				return '"' + attributeInfo.name + '", ' + errorValue + " - " + errorMessage;
			}

			me.getPersonAttributeById = function( json_PersonAttributes, attributeId )
			{
				var personAttribute;

				if ( Util.checkValue( attributeId ) && json_PersonAttributes !== undefined )
				{
					personAttribute = Util.getFromList( json_PersonAttributes, attributeId, "id" );
				}

				return personAttribute;
			}
			

			me.SetRowControls_Attribute = function( attributeId, mandatory, value, existingData )
			{
				var trCurrent;

				if ( existingData )
				{
					me.personDialogTableTag.find( "td[attributeid='" + attributeId + "']" ).each( function( index ) 
					{
						trCurrent = $( this ).closest( "tr" );
					});
				}


				// Step 1. Retrieve person attribute properties and display at here.
				var personAttribute = me.getPersonAttributeById( me.json_PersonAttributes, attributeId );
				

				if ( Util.checkDefined( personAttribute ) )
				{

					if ( trCurrent === undefined )
					{
						// Render the control and set value if availble
						var visibleInfo = "";

						// If this is from person, not from program, hide visibly, so that, for saveing/updating, it gets added. <-- even though it is not part of program info.
						if ( existingData )
						{
							visibleInfo = "style='display:none;'";
						}

						var mandatorySpan = "";
						var mandatoryAttribute = "";

						if ( mandatory )
						{
							mandatorySpan = "<span title='Mandatory' class='mandatory'>*</span>";
							mandatoryAttribute = "mandatory='true'";
						}


						// Step 2. Add template row to the table <-- via append
						me.personDialogTableTag.append("<tr " + visibleInfo + "><td><span class='attrname' attributeId='" + attributeId + "'>" + personAttribute.name + "</span>" + mandatorySpan + "</td><td type='attribute' " + mandatoryAttribute + " attributeId='" + attributeId + "'>" + me.TabularDEObj.getAttrControlsTemplate() + "</td></tr>");

						// Step 3. Show the proper control for the data type + value.
						var trCurrent = me.personDialogTableTag.find( "tr:last" );

						var controlTag = me.setAttributeControlType( trCurrent, personAttribute, value );

						controlTag.show();
					}
					else
					{
						me.setAttributeControlType( trCurrent, personAttribute, value );
					}
				}
				else
				{
					Util.write( 'Person Attributes not found - id:', attributeId );
				}
			};


			me.setAttributeControlType = function( trCurrent, personAttribute, value )
			{	
				var attributeControl;
				if ( !Util.checkDefined( value ) ) value = '';

				var valueType = personAttribute.valueType;

				if ( personAttribute.optionSetValue && personAttribute.optionSet !== undefined )
				{
					var optionSet = personAttribute.optionSet;
					var cntrDropdown = trCurrent.find( ".dropdown" );

					attributeControl = cntrDropdown.attr( _view, _view_Yes );

					cntrDropdown.empty();
					cntrDropdown.append( "<option value=''>Select Value</option>" );

					if ( optionSet.options !== undefined )
					{
						$.each( optionSet.options, function( i_Option, item_Option ) 
						{   
							EventUtil.appendSelectOption_Option( cntrDropdown, item_Option );
						});
					}
					
					Util.selectOption_WithOptionalInsert( cntrDropdown, value );
				}
				else if( valueType == "BOOLEAN" )
				{
					var cntrDropdown = trCurrent.find( ".dropdown" );

					attributeControl = cntrDropdown.attr( _view, _view_Yes );

					cntrDropdown.empty();
					
					FormUtil.setSelectTagOptions_YesNo( cntrDropdown );

					cntrDropdown.val( value );
				}
				else if( valueType == "TEXT" || valueType == "LONG_TEXT" || valueType == "NUMBER" || valueType == "LETTER" || valueType == "PHONE_NUMBER" || valueType == "EMAIL"  || valueType == "USERNAME" )
				{
					// TODO: For now, have 'username' display as textbox <-- should be user listing
					attributeControl = trCurrent.find( ".textbox" ).val( value ).attr( _view, _view_Yes );

					if ( valueType == "NUMBER" )
					{
						PersonUtil.setTagTypeValidation( attributeControl, "NUMBER" );
					}
					else if ( valueType == "LETTER" )
					{
						PersonUtil.setTagTypeValidation( attributeControl, "LETTER" );
					}
				}
				else if( valueType == "DATE" )
				{
					attributeControl = trCurrent.find( ".datepicker" ).val( value ).attr( _view, _view_Yes );

					// If it is birth date, set attribute for that, so that start/end year can be set appropriately.
					if ( Util.stringSearch( trCurrent.find( 'span.attrname' ).text(), "birth" ) )
					{
						attributeControl.attr( 'caltype', 'birth' );
					}
					else
					{
						attributeControl.attr( 'caltype', 'none' );
					}
				}
				else if( valueType == "TRUE_ONLY" || valueType == "TRACKER_ASSOCIATE" )
				{
					attributeControl = trCurrent.find( ".checkbox" ).attr( _view, _view_Yes ).prop( 'checked', value );
				}
				else
				{
					attributeControl = trCurrent.find( ".label" ).html( 'Currently Not Supported TEI Attribute valueType: ' + valueType ).attr( _view, _view_Yes );
				}

				return attributeControl;
			}
		
			
			me.RenderPersonElements = function( programTrackedEntityAttributes, setRowControlsFunc, existingData )
			{
				
				if ( programTrackedEntityAttributes !== undefined )
				{
					$.each( programTrackedEntityAttributes, function( i_element, item_element ) 
					{
						if ( Util.checkDefined( existingData ) )
						{
							var elementValue = FormUtil.getFormattedAttributeValue( item_element );

							setRowControlsFunc( item_element.id, item_element.mandatory, elementValue, true );
						}
						else
						{
							setRowControlsFunc( item_element.id, item_element.mandatory );
						}
					});
				}
			}


			me.setupPersonData = function( orgUnitId )
			{
				var newPersonObj = {};

				newPersonObj[ "orgUnit" ] = orgUnitId;

				newPersonObj[ "trackedEntity" ] = me.getTrackedEntityId_Person();

				newPersonObj[ "attributes" ] = me.constructAttributes();

				return newPersonObj;
			}


			me.checkFieldsData = function()
			{
				var pass = true;

				// Check Mandatory Fields and Number/Letter Only fields
				
				// Check Number/Letter highlightedness
				if ( me.personDialogTableTag.find( "td[type='attribute']" ).find( FormUtil.getStr_Views() ).filter( "[notvalid='Y']" ).length > 0 )
				{
					alert( $( 'span.msg_ValidFill' ).text() );
					return false;
				}

				// Check Mandatory
				me.personDialogTableTag.find( "td[type='attribute'][mandatory='true']" ).find( FormUtil.getStr_Views() ).each( function( index ) 
				{
					var item = $( this );
					
					var dataValue;
		
					// Check the class and covert the values
					if( item.hasClass( "datepicker" ) )
					{
						dataValue = Util.formatDate( item.val() );
					}
					else if( item.hasClass( "checkbox" ) )
					{
						dataValue = item.is( ":checked" ) ? "true" : "" ;
					}
					else
					{
						dataValue = item.val();
					}

					if( !Util.checkValue( dataValue ) )
					{	
						Util.paintWarning( item );
						pass = false;
					}
					else
					{
						Util.paintClear( item );
					}

				});

				if ( !pass )
				{
					alert( $( 'span.msg_MandatoryFill' ).text() );
				}

				return pass;
			}


			me.checkDuplicateData = function( orgUnitId, defaultProgramId, personId, runFunc )
			{
				// Prepare the data
				var paramData = 'orgUnitId=' + orgUnitId + '&programId=' + defaultProgramId;

				// determines update vs create
				if ( personId !== undefined ) paramData += '&uid=' + personId;

				var attributes = me.constructAttributes();

				$.each( attributes, function( i, item )
				{
					paramData += '&attr' + item.attribute + '=' + item.value;
				});


				runFunc();
				// Need to perform this via WebAPI version!!!


				/*
				$.ajax({
					type: "POST"
					,url: _queryURL_PersonDataValidate
					,data: paramData
					,datatype: "json"
					,async: true
					,success: function( returnData )
					{
						if ( returnData.response == 'success' && returnData.message == "" )
						{
							runFunc();
						}
						else
						{
							alert( 'Failed.  Reason: ' + returnData.message );
						}
					}
				});
				*/
			}


			me.constructAttributes = function()
			{
				var attributes = new Array();

				me.personDialogTableTag.find( "td[type='attribute']" ).find( FormUtil.getStr_Views() ).each( function( index ) 
				{
					//Util.write( "In each list.. " );

					var item = $( this );
					
					var attributeId = item.closest( "td" ).attr( "attributeId" );

					var dataValue;
		
					// Check the class and covert the values
					if( item.hasClass( "datepicker" ) )
					{
						dataValue = Util.formatDate( item.val() );
					}
					else if( item.hasClass( "checkbox" ) )
					{
						dataValue = item.is( ":checked" ) ? "true" : "" ;
					}
					else
					{
						dataValue = item.val();
					}

					if( Util.checkValue( dataValue ) )
					{					
						attributes.push( { "attribute": attributeId, "value": dataValue } );
					}
				});

				return attributes;
			}


			me.getActiveControlById = function( attributeId )
			{
				return me.personDialogTableTag.find( "td[type='attribute'][attributeid='" + attributeId + "']" ).find( FormUtil.getStr_Views() );
			}


			me.personCreateUpdate_Fail_Handle = function( returnData )
			{
				$( "#person_Result" ).val( "Fail" );

				var errorMsg = "";

				// Try to parse the error Message and highLight the fields
				if ( returnData.responseJSON !== undefined && returnData.responseJSON.response !== undefined && returnData.responseJSON.response.conflicts !== undefined )
				{
					var conflicts = returnData.responseJSON.response.conflicts;

					$.each( conflicts, function( i_conflict, item_conflict )
					{
						var issueNumber = i_conflict + 1;

						errorMsg += "Issue " + issueNumber + ": " + me.getErrorMessageFormatted( item_conflict.value ) + "\n";

						var attribute = me.getAttributeInfoInMsg( item_conflict.value );
						
						Util.paintWarning( me.getActiveControlById( attribute.id ) );
					});					
				}
				else
				{
					errorMsg = JSON.stringify( returnData );
				}

				alert( $( 'span.msg_PersonCreateUpdateFailed' ).text() + '\n\n' + errorMsg );

				me.personDialogFormTag.find( 'button' ).filter( ':visible' ).first().focus();
			}


			// Initial Setup Call
			me.initialSetup = function()
			{				
				me.FormPopupSetup();
			}


			// Initial Setup Call
			me.initialSetup();

		}

		// PersonDialogForm Class
		// -------------------------------------------


		// -------------------------------------------
		// Class - SettingForm
		//		- Used for popup Setting Form

		function SettingForm()
		{
			var me = this;

			me.dialogFormTag = $( "#settingDialogForm" );

			me.countryLevelTag = $( '#countryLevels' );

			me.currentVersionTag = $( '#currentVersion' );
			me.trLatestVersionTag = $( '#trLatestVersion' );
			me.latestVersionTag = $( '#latestVersion' );

			me.trIncompleteActionUserRoleTag = $( '#trIncompleteActionUserRole' );
			me.incompleteActionUserRoleTag = $( '#incompleteActionUserRole' );


			me.width = 400;
			me.height = 250;

			me.dbSettingName = "App_TabularData_SettingData";

			me.queryURL_orgUnitLevels = _queryURL_api + 'organisationUnitLevels.json?paging=false&fields=id,name,level';

			me.settingData;


			me.FormPopupSetup = function()
			{
				// -- Set up the form -------------------
				me.dialogFormTag.dialog({
				  autoOpen: false
				  ,dialogClass: "noTitleStuff"
				  ,width: me.width
				  ,height: me.height				  
				  ,modal: true				
				  ,buttons: {
					"Save": function() {
						var dialogForm = $( this );

						// Check the value and 
						var checkFail = false;
						
						if ( me.countryLevelTag.val() == "" )
						{
							checkFail = true;
							alert( $( 'span.msg_SettingData_MandatoryCountryLevel' ).text() );
						}

						if ( !checkFail )
						{

							var json_SettingData = ( me.settingData !== undefined ) ? me.settingData : { 'countryLevel': '' } ; 

							json_SettingData.countryLevel = me.countryLevelTag.val();

							if ( me.trLatestVersionTag.is( ':visible' ) )
							{
								json_SettingData.latestVersion = me.latestVersionTag.val();
							}


							if ( me.trIncompleteActionUserRoleTag.is( ':visible' ) )
							{
								json_SettingData.incompleteActionUserRole = me.incompleteActionUserRoleTag.val();
							}

							
							DBSetting.saveSettingValue( me.dbSettingName, json_SettingData
							, function()
							{
								me.settingData = json_SettingData;
								dialogForm.dialog( "close" );
							}
							, function()
							{
								alert( $( 'span.msg_SettingData_FailedToSave' ).text() );		
							});	
						}
					}
					,"Close": function()
					  {
						$( this ).dialog( "close" );
					  }

				  }				
				});		
			}


			me.openForm = function( status )
			{
				if ( status !== undefined && status == 'AtStart' )
				{
					me.dialogFormTag.find( '.ui-dialog-buttonpane' ).find( 'button:contains("Close")' ).button().hide();
				}

				me.populateSettingData();

				me.dialogFormTag.dialog( "open" );
			}

			me.populateSettingData = function()
			{
				if ( me.settingData !== undefined )
				{
					// set the tags value based on settingData
					if ( me.settingData.countryLevel !== undefined )
					{
						me.countryLevelTag.val( me.settingData.countryLevel );
					}

					if ( me.settingData.latestVersion !== undefined )
					{
						me.latestVersionTag.val( me.settingData.latestVersion );
					}

					if ( me.settingData.incompleteActionUserRole !== undefined )
					{
						me.incompleteActionUserRoleTag.val( me.settingData.incompleteActionUserRole );
					}
				}
			}

			me.getSettingData = function( execFunc )
			{
				if ( me.settingData !== undefined )
				{
					execFunc( me.settingData );
				}
				else
				{
					DBSetting.getSettingValue( me.dbSettingName
					, function( json_Data ) 
					{
						me.settingData = json_Data;

						execFunc( me.settingData );
					}
					, function( json_Data ) 
					{
						execFunc( me.settingData );
					});
				}
			}

			me.getCountryLevel = function()
			{
				var countryLevel;

				if ( me.settingData !== undefined )
				{
					countryLevel = me.settingData.countryLevel;
				}
				else
				{
					alert( $( 'span.msg_SettingData_CountryLevelNotDefined' ).text() );
				}

				return countryLevel;
			}


			// Check for existing country data and open if not setup yet
			me.checkRequiredData = function( json_Data )
			{
				if ( json_Data === undefined )
				{
					console.log( 'No setting data found.  Asking for setting data for the first time.' );

					me.openForm( 'AtStart' );
				}
				else if ( !( Util.checkDefined( json_Data ) && Util.checkValue( json_Data.countryLevel ) ) )
				{
					console.log( 'Setting data found, but country level is not set.  Asking for country level data.' );

					me.openForm( 'AtStart' );
				}				
			}


			me.checkIfNotLastVersion = function( json_Data )
			{
				// If the user is deploymentManager, show the version as editable
				if ( json_Data !== undefined && Util.checkValue( json_Data.latestVersion ) )
				{
					//get current version..
					var currentVersion = me.currentVersionTag.text();

					if ( currentVersion < json_Data.latestVersion )
					{
						var message = l10n.get( 'Msg_NotLatestVersion' );

						message = message.replace( '{--version--}', json_Data.latestVersion );
						//'This app is not the latest version, v ' + json_Data.latestVersion + '.  Please refresh the browser to get the latest version.';

						alert( message ); 

						MsgManager.msgAreaShow( message );
					}				
				}
			}


			me.checkIncompleteAction_UserRole = function( runFunc )
			{
				// If user has userRole that matches 'Incomplete Action User Role', execute 'runFunc'

				if ( me.settingData !== undefined && Util.checkValue( me.settingData.incompleteActionUserRole ) )
				{
					DHISUtil.retrieveUserInfo( function( json_Data )
					{
						var userRoles = json_Data.userCredentials.userRoles;

						if ( userRoles !== undefined )
						{
							$.each( userRoles, function( i_ur, item_ur )
							{
								if ( item_ur.name == me.settingData.incompleteActionUserRole )
								{
									runFunc();

									return false;
								}
							});
						}
					});
				}
			}


			me.loadSettingDataInitially_AndCheckRequired = function()
			{
				me.setRowVisibility();

				me.getSettingData( function( json_Data )
				{
					me.checkIfNotLastVersion( json_Data );
				
					me.checkRequiredData( json_Data );
				});
			}

			me.setRowVisibility = function()
			{
				DHISUtil.retrieveUserAccount( function( json_data ) 
				{
					if ( json_data.username == _deploymentManagerId )
					{
						me.trLatestVersionTag.show();

						me.trIncompleteActionUserRoleTag.show();
					}
				});	
			}


			// User Role should be loaded in the beginning and saved..
			// So that it can be reused..

			// Get User Role - Since using
			//me.



			me.setOrgUnitList = function( listTag )
			{
				listTag.empty();

				RESTUtil.getAsynchData( me.queryURL_orgUnitLevels
				, function( json_Data )
				{
					listTag.append( '<option value="">' + l10n.get('selectOrgunitLevel') + '</option>' );

					if ( json_Data !== undefined )
					{
						var json_Levels = json_Data.organisationUnitLevels;

						var json_Levels_Sorted = Util.sortByKey( json_Levels, "level" );

						$.each( json_Levels_Sorted, function( i, item ) {

							listTag.append( $( '<option></option>' ).attr( "value", item.level ).text( l10n.get('level') + ' ' + item.level + ' - ' + item.name ) );
						});
					}
				}
				, function() 
				{  
					alert( $( 'span.msg_SettingData_OrgUnitLevelNotFound' ).text() );
				});	

			}

			// Initial Setup Call
			me.initialSetup = function()
			{
				me.setOrgUnitList( me.countryLevelTag );
				
				me.FormPopupSetup();
			}

			// --------------------------
			// Run methods

			// Initial Run Call
			me.initialSetup();

		}

		// Class - SettingForm
		// -------------------------------------------


		// -------------------------------------------
		// OrgUnit Map Popup Class
		function OrgUnitSelectionTreePopup( TabularDEObj )
		{
			var me = this;

			me.TabularDEObj = TabularDEObj;

			me.dialogFormTag = $( "#orgUnitSelectionTreeDialogForm" );

			me.selectedOu;

			me.selectedOu_FromSearchPanel;

			me.onOrgUnitSelectFunc;


			// -- Methods ----------------

			me.FormPopupSetup = function()
			{
				// -- Set up the form -------------------
				me.dialogFormTag.dialog({
				  autoOpen: false,
				  dialogClass: "noTitleStuff",
				  width: 530,
				  height: 500,
				  modal: true,
				  buttons: {
					"Close": function() {
						$( this ).dialog( "close" );
					}
				  }
				});		
			}


			me.openForm = function()
			{
				me.dialogFormTag.show();

				me.dialogFormTag.dialog( "open" );
			}


			me.clearSelections = function()
			{
				selectionTreeSelection.clearSelections();
				selectionTreeSelection.collapseTree( $( '#selectionTree' ) );
			}

			me.selectOrgUnit = function( orgUnitId, parents )
			{
				selectionTreeSelection.collapseTree( $( '#selectionTree' ) );

				setTimeout( function()
				{
					selectionTreeSelection.expandTree( parents, 1, function()
					{
						selectionTreeSelection.select( orgUnitId, true );						
					});

				}, 100 );
			}


			me.onOrgUnitSelectSet = function( onOrgUnitSelectFunc )
			{
				me.onOrgUnitSelectFunc = onOrgUnitSelectFunc;
			}


			me.setUp_OrgUnitTreeSelection = function()
			{
				selectionTreeSelection.setMultipleSelectionAllowed( false );

				selectionTreeSelection.setOnSelectFunction( function()
				{					
					me.selectedOu = selectionTreeSelection.getSelectedObj();

					if ( me.selectedOu !== undefined )
					{
						if ( me.onOrgUnitSelectFunc !== undefined ) me.onOrgUnitSelectFunc( me.selectedOu, true );

						me.dialogFormTag.dialog( "close" );
					}

				});

				selectionTree.buildSelectionTree();
			}


			// Initial Setup Call
			me.initialSetup = function()
			{				
				me.FormPopupSetup();

				me.setUp_OrgUnitTreeSelection();
			}

			// --------------------------
			// Run methods

			// Initial Run Call
			me.initialSetup();
		}

		// -------------------------------------------
		// OrgUnit Map Popup Class


		// -------------------------------------------
		// OrgUnit Map Popup Class
		function OrgUnitMapPopup( TabularDEObj )
		{
			var me = this;

			me.TabularDEObj = TabularDEObj;

			me.dialogFormTag = $( "#orgUnitMapDialogForm" );

			me.tagId = '#orgUnitMapBig';
			me.tag = $( me.tagId );
			me.tagIdFront = me.tagId + ' ';

			me.width = 600;
			me.height = 600;

			me.centerLocation;
			me.latitude = 0;
			me.longitude = 0;

			me.gmap;
			me.currentEvent = null;

			me.zoomLvl_Init = 10;

			// overlay related
			me.overlays = new Array();
			me.marker_center;

			me.markers = [];

			me.FormPopupSetup = function()
			{
				// -- Set up the form -------------------
				me.dialogFormTag.dialog({
				  autoOpen: false,
				  width: me.width,
				  height: me.height,
				  modal: true				
				});		
			}

			me.mapSetup = function( ) //centerLoc )
			{
				var menu = new Gmap3Menu( me.tag );

				var centerLoc = new google.maps.LatLng( me.latitude, me.longitude );

				me.clearMarkers();

				// 1st call : init the map and create circles
				me.tag.gmap3({
					map:{
						options:{
							center: centerLoc
							,zoom: me.zoomLvl_Init
							,mapTypeId: google.maps.MapTypeId.ROADMAP
							,styles: [ { featureType: "poi", elementType: "labels", stylers: [ { visibility: "off" } ] } ]
							,streetViewControl: false
						}
						//,events:{ click: function(map, event){ }}
					}
				});
		
				me.gmap = me.tag.gmap3( 'get' );

				me.markers.push( new google.maps.Marker({
					position: centerLoc
					,map: me.gmap
					,icon: 'img/blue.png'
				}) );
			}

			me.clearMarkers = function() 
			{
				for (var i = 0; i < me.markers.length; i++ ) 
				{
					me.markers[i].setMap( null );
				}

				me.markers = [];
			}

			me.setUp_Map = function( latitude, longitude )
			{
				me.latitude = latitude;	
				me.longitude = longitude;
				
				GMapHelper.loadScript( '_TabularDEObj.orgUnitMapPopup.mapSetup', me.mapSetup );
				//_TabularDEObj.orgUnitMapPopup.mapSetup

			}

			// Initial Setup Call
			me.initialSetup = function()
			{				
				me.FormPopupSetup();
			}

			// --------------------------
			// Run methods

			// Initial Run Call
			me.initialSetup();
		}

		// -------------------------------------------
		// OrgUnit Map Popup Class


		// -------------------------------------------
		// Google Map Helper Class (Static)
		//  -- to load only when needed

		function GMapHelper() {}

		GMapHelper.hasLoaded = false;

		GMapHelper.loadScript = function( callBack_Str, callBack ) 
		{
			if ( GMapHelper.hasLoaded )
			{
				callBack();
			}
			else
			{
				var script = document.createElement('script');

				script.type = 'text/javascript';

				script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyB0wy06coUW9kJYWXA8Gqh-hBkBB17odLw&sensor=true&libraries=geometry&callback=' + callBack_Str;

				document.body.appendChild(script);

				GMapHelper.hasLoaded = true;
			}
		}

		// Google Map Helper Class (Static)
		// -------------------------------------------

		// ============================================================================


		// -------------------------------------------
		// -- DHISUtil Static Classes
		
		function DHISUtil() {}

		DHISUtil.data = { version: "" };

		DHISUtil.retrieveAndSet_DHISData = function()
		{
			// Only version info for now.
			RESTUtil.getAsynchData( _queryURL_systemInfo
			, function( json_data ) 
			{
				DHISUtil.data.version = json_data.version;
			});

			selectionTree.clearSelectedOrganisationUnits();
		}

		DHISUtil.getDHISVersion = function()
		{
			return DHISUtil.data.version;
		}

		DHISUtil.preRetrieve_UserInfo = function()
		{
			// pre retrieve user info by using 'retrieveManager', which saves/reuse the retrieval.
			DHISUtil.retrieveUserInfo();
		}

		DHISUtil.retrieveUserInfo = function( runFunc )
		{
			RESTUtil.retrieveManager.retrieveData( _queryURL_me + '.json?fields=*,userCredentials[*,userRoles[id,name]]'
			, function( json_data ) 
			{
				if ( runFunc !== undefined ) runFunc( json_data );
			});			
		}

		DHISUtil.retrieveUserAccount = function( runFunc )
		{
			RESTUtil.retrieveManager.retrieveData( _queryURL_me + '/user-account.json'
			, function( json_data ) 
			{
				if ( runFunc !== undefined ) runFunc( json_data );
			});			
		}


		// -------------------------------------------
		// -- AppUtil Static Classes
		
		function AppUtil() {}

		AppUtil.CheckCachedFileSynch = function()
		{
			var outOfSynch = false;
			var msg = "";

			if ( RESTUtil.retrieveManager === undefined )
			{
				outOfSynch = true;
				msg += "RESTUtil.retrieveManager not found";
			}

			if ( outOfSynch )
			{
				alert( $( 'span.msg_CacheClear' ).text() );
			}
		}


		AppUtil.copyAncestorsToParents = function( ouList )
		{
			if ( ouList.length > 0 
				&& ouList[0].parents === undefined 
				&& ouList[0].ancestors !== undefined 
				)
			{
				$.each( ouList, function( i_ou, item_ou )
				{
					item_ou.parents = item_ou.ancestors;
				});
			}
		}

		AppUtil.pageHScroll = function( option )
		{
			if ( option === "Right" )
			{
				// Scroll to right end
				var left = $(document).outerWidth() - $(window).width();
				$('body, html').scrollLeft( left );
			}
			else
			{
				$('body, html').scrollLeft( 0 );
			}
		}

		// -------------------------------------------
		// -- FormUtil Static Classes

		function FormUtil() {}

		FormUtil.setTagAsWait_SetRows = function( tagRows )
		{
			tagRows.each( function( i )
			{
				me.setTagAsWait( $( this ) );
			});
		}

		FormUtil.setTagAsWait = function( tag, classNameInput )
		{
			var className = ( classNameInput !== undefined ) ? classNameInput : 'waitRow' ;
			tag.addClass( className );
			
			Util.disableTag( tag, true );
		}
		
		FormUtil.setTagAsWait_Clear = function( tag, classNameInput )
		{
			var className = ( classNameInput !== undefined ) ? classNameInput : 'waitRow' ;
			tag.removeClass( className );
			
			Util.disableTag( tag, false );
		}

		FormUtil.setSelectTagOptions_YesNo = function( ctrlTag )
		{
			ctrlTag.append('<option value="">[Please select]</option>');
			ctrlTag.append('<option selected="selected" value="true">Yes</option>');
			ctrlTag.append('<option value="false">No</option>');
		}

		FormUtil.getStr_Views = function()
		{
			return "input[" + _view + "='" + _view_Yes + "'],select[" + _view + "='" + _view_Yes + "'],textarea[" + _view + "='" + _view_Yes + "']";
		}

		FormUtil.setTabBackgroundColor_Switch = function( ctrlTags )
		{
			ctrlTags.focus( function()
			{
				$( this ).closest( 'td' ).css('background-color', '#F7F7F7');
			});

			ctrlTags.focusout( function()
			{
				$( this ).closest( 'td' ).css('background-color', 'white');
			});

		}

		FormUtil.getFormattedAttributeValue = function( attributeObj )
		{
			var attributeValue = attributeObj.value;

			if ( attributeObj.type == "date" )
			{
				attributeValue = attributeValue.substring( 0, 10 );
			}

			return attributeValue;
		}

		FormUtil.abortAndClear_XhrRequest = function( xhrRequests )
		{
			$.each( xhrRequests, function( i_xhr, item_xhr )
			{
				item_xhr.abort();
			});

			return [];
		}

		FormUtil.validateValueType = function( tag, inputType )
		{
			var pass = true;

			// Clear
			Util.paintClear( tag );
			tag.attr( 'title', '' );
			tag.attr( 'notvalid', '' );

			if ( inputType == "NUMBER" )
			{
				var reg = new RegExp( '^[0-9]*$' );

				if ( !reg.test( tag.val() ) )
				{
					Util.paintWarning( tag );
					tag.attr( 'title', 'This field is Number Only field.' );
					tag.attr( 'notvalid', 'Y' );
					pass = false;
				}
			}
			else if ( inputType == "LETTER" )
			{
				var reg = new RegExp( '^[a-zA-Z]*$' );

				if ( !reg.test( tag.val() ) )
				{
					Util.paintWarning( tag );
					tag.attr( 'title', 'This field is Letter Only field.' );
					tag.attr( 'notvalid', 'Y' );
					pass = false;
				}
			}
			else if ( inputType == "DATE" )
			{
				// Due to '/' not doing date check properly, change to '-'
				var dateStr = tag.val().replace( /\//ig, '-' );

				if ( !moment( dateStr ).isValid() )
				{
					Util.paintWarning( tag );
					tag.attr( 'title', 'The date is not valid date.' );
					tag.attr( 'notvalid', 'Y' );
					pass = false;
				}
			}

			return pass;
		};

		// -------------------------------------------
		// -- PersonUtil Static Classes

		function PersonUtil() {}

		PersonUtil.primaryAttributeVal = "PrimaryAttributeVal";

		PersonUtil.getPersonByID = function( personId )
		{
			return $.parseJSON( RESTUtil.getSynchData( _queryURL_PersonQuery + "/" + personId + ".json" ) );			
		}
		
		PersonUtil.clearPersonByID_Reuse = function( personId )
		{
			var queryUrl = _queryURL_PersonQuery + "/" + personId + ".json";
			
			// remove any saved data from memory
			RESTUtil.retrieveManager.removeFromMemory( queryUrl );
		};

		PersonUtil.getPersonByID_Reuse = function( personId, successFunc, finalFunc )
		{			
			var queryUrl = _queryURL_PersonQuery + "/" + personId + ".json";

			RESTUtil.retrieveManager.retrieveData( queryUrl
			, successFunc
			, function()
			{
				console.log( "FAILED -- PersonUtil getPersonByID_Async(), personId: " + personId ); 
			}
			, function() {}
			, function() { if ( finalFunc !== undefined ) finalFunc(); } 
			);	
		}
		//RESTUtil.getAsynchData( _queryURL_PersonQuery + "/" + personId + ".json"
		//PersonUtil.getPersonByID_Reuse = function( personId, actionSuccess, actionError, loadingStart, loadingEnd )


		PersonUtil.addIDtypeToID = function( item_Person )
		{
			if ( Util.checkDefined( item_Person ) )
			{
				// Set attributeID as ID
				if( Util.checkDefined( item_Person.attributes ) )
				{
					$.each( item_Person.attributes, function( i_attribute, item_attribute ) 
					{
						item_attribute.id = item_attribute.attribute;
					});
				}
			}
		}


		PersonUtil.setPersonWithFirstAttributeData = function( personObjList, firstAttributeId )
		{
			$.each( personObjList, function( i_person, item_person )
			{
				var attritubeValue = "";

				if ( item_person.attributes === undefined )
				{
					item_person[ PersonUtil.primaryAttributeVal ] =  "";
				}
				else
				{
					// look for attribute value with id
					$.each( item_person.attributes, function( i_attribute, item_attribute )
					{
						if ( item_attribute.attribute == firstAttributeId )
						{
							attritubeValue = item_attribute.value;
							return false;
						}
					});

					item_person[ PersonUtil.primaryAttributeVal ] =  attritubeValue;

				}
			});
		}


		PersonUtil.setTagTypeValidation = function( inputTags, inputType )
		{			
			inputTags.off( "change" ).on( "change", function ( event ) 
			{
				var tag = $( this );

				FormUtil.validateValueType( tag, inputType );
			});
		}


		// -------------------------------------------
		// -- EventUtil Static Classes 

		function EventUtil() {}

		EventUtil.varSrcType_TEI_Attribute = "TEI_ATTRIBUTE";
		EventUtil.varSrcType_DE_CurrentEvent = "DATAELEMENT_CURRENT_EVENT";
		EventUtil.varSrcType_DE_NewestEventInProgram = "DATAELEMENT_NEWEST_EVENT_PROGRAM";
		EventUtil.varSrcType_DE_NewestEventInProgStage = "DATAELEMENT_NEWEST_EVENT_PROGRAM_STAGE";
		EventUtil.varSrcType_DE_PreviousEvent = "DATAELEMENT_PREVIOUS_EVENT";


		EventUtil.getProgramStageId_FromRow = function( trEventRow )
		{
			return trEventRow.find( "select.eventStage" ).attr( "selectedProgramStage" );
		}

		EventUtil.getEventId_FromRow = function( trEventRow )
		{
			return trEventRow.attr( "uid" );
		}


		EventUtil.clearLatestEvent_Reuse = function( TabularDEObj, personId )
		{			
			var orgUnitId = TabularDEObj.getOrgUnitId();
			var programId = TabularDEObj.getSelectedProgramId();

			var queryUrl = _queryURL_EventQuery + "&orgUnit=" + orgUnitId + "&program=" + programId + "&trackedEntityInstance=" + personId;

			// remove any saved data from memory
			RESTUtil.retrieveManager.removeFromMemory( queryUrl );
		};

		EventUtil.getLatestEvent_Reuse = function( TabularDEObj, personId, successFunc, finalFunc )
		{
			var orgUnitId = TabularDEObj.getOrgUnitId();
			var programId = TabularDEObj.getSelectedProgramId();

			var queryUrl = _queryURL_EventQuery + "&orgUnit=" + orgUnitId + "&program=" + programId + "&trackedEntityInstance=" + personId;
			

			RESTUtil.retrieveManager.retrieveData( queryUrl
			, successFunc
			, function()
			{
				console.log( "FAILED -- EventUtil getLatestEvent_Reuse(), queryUrl: " + queryUrl ); 
			}
			, function() {}
			, function() { if ( finalFunc !== undefined ) finalFunc(); } 
			);	
		}


		EventUtil.getEventBySrcType = function( reuse, orgUnitId, programId, personId, srcType, programStageId, currEventId, successFunc, finalFunc )
		{
			var retrievalFunc = ( reuse ) ? RESTUtil.retrieveManager.retrieveData : RESTUtil.getAsynchData;

			var queryUrl = _queryURL_EventQuery + "&orgUnit=" + orgUnitId + "&program=" + programId + "&trackedEntityInstance=" + personId;
			
			retrievalFunc( queryUrl
			, function( item_Events )
			{
				var foundEvent;

				if ( item_Events !== undefined && item_Events.events !== undefined && item_Events.events.length > 0 )
				{
					var events_InReverse = Util.sortByKey_Reverse( item_Events.events, "eventDate" );				

					if ( srcType == EventUtil.varSrcType_DE_NewestEventInProgram )
					{
						foundEvent = events_InReverse[0];
					}
					else if ( srcType == EventUtil.varSrcType_DE_NewestEventInProgStage )
					{
						foundEvent = ( programStageId ) ? ( Util.getMatchesFromList( events_InReverse, programStageId, "programStage" ) )[0] : events_InReverse[0];
					}
					else if ( srcType == EventUtil.varSrcType_DE_PreviousEvent && currEventId )
					{

						console.log( 'DATAELEMENT_PREVIOUS_EVENT case' );

						var lastWasCurrentEvent = false;

						$.each( events_InReverse, function( i_event, item_event )
						{

							console.log( 'events' );

							if ( lastWasCurrentEvent )
							{
								lastWasCurrentEvent = false;
								foundEvent = item_event;
								return false;
							}

							if ( item_event.event == currEventId ) lastWasCurrentEvent = true;

						});

						console.log( 'foundEvent: ' + JSON.stringify( foundEvent ) );

					}
				}

				// Do not need to run 'successFunc' if no result found
				if ( foundEvent !== undefined ) successFunc( foundEvent );
			}
			, function()
			{
				console.log( "FAILED -- EventUtil getEventBySrcType_Reuse(), queryUrl: " + queryUrl ); 
			}
			, function() {}
			, function() { if ( finalFunc !== undefined ) finalFunc(); } 
			);	
		}

		// (Functions not yet populated much - move from PersonEvent class)
		EventUtil.appendSelectOption_Option = function( selectTag, item_Option )
		{
			if ( typeof item_Option === "string" )
			{
				selectTag.append( "<option>" + item_Option + "</option>" );
			}
			else if ( typeof item_Option === "object" )
			{
				selectTag.append( "<option value='" + item_Option.code  + "'>" + item_Option.name + "</option>" );
			}
		}

		EventUtil.getNextRowFocus_Event = function( trCurrent )
		{
			var nextRowEventTag;

			var trTable = trCurrent.closest( 'table' );
			var trCurrent_EventRowNo = parseInt( trCurrent.attr( 'eventrowno' ) );

			
			trTable.find( 'tr.trEventData' ).each( function()
			{
				var eventRowNo = parseInt( $( this ).attr( 'eventrowno' ) );

				if( eventRowNo > trCurrent_EventRowNo )
				{
					var list = $( this ).find( 'input,select' ).filter( ':visible' ).filter( ':enabled' );
					if ( list.length > 0 )
					{
						nextRowEventTag = list.first();
						return false;
					}
				}
			});

			
			// If next row active tags were not found, focus on the button.
			if ( nextRowEventTag === undefined )
			{
				var buttonTag = trTable.parent().find( '.personEvent_addNewRow' );

				if ( buttonTag.length == 1 )
				{
					nextRowEventTag = buttonTag;
				}
			}


			return nextRowEventTag;
		}

		// Static Classes
		// =========================================================

		// =========================================================
		// Static Classes

		// Non-Genertic Util Helper Methods
		// -------

		// -------------------------------------------
		// -- Static Classes - Weekly/Monthly DatePicker Related

		function Weekly() {}

		Weekly.selectCurrentWeek = function() {
			window.setTimeout(function () {
				$('.ui-datepicker-calendar').filter( ':visible' ).find('.ui-datepicker-current-day a').addClass('ui-state-active');
			}, 1);
		}

		Weekly.setWeekPicker = function( inputTag, onSelectFunc )
		{
			inputTag.datepicker( {
			    changeMonth: true
				,changeYear: true
				,showOtherMonths: true
				,selectOtherMonths: true
				,showWeek: true
				,onSelect: function(dateText, inst) { 

					var date = $(this).datepicker('getDate');

					$(this).val( Weekly.getThisWeekStr( date ) );

					// Remove the event handler
					$( document ).off( 'mousemove', '.ui-datepicker-calendar:visible tr');
					$( document ).off( 'mouseleave', '.ui-datepicker-calendar:visible tr');

					if ( onSelectFunc !== undefined ) onSelectFunc();

				},
				beforeShowDay: function(date) {

					$( document ).on( 'mousemove', '.ui-datepicker-calendar:visible tr', function() { $(this).find('td a').addClass('ui-state-hover'); });

					$( document ).on( 'mouseleave', '.ui-datepicker-calendar:visible tr', function() { $(this).find('td a').removeClass('ui-state-hover'); });

					var cssClass = '';
					if( date >= _weekStartDate && date <= _weekEndDate )
						cssClass = 'ui-datepicker-current-day';
					return [true, cssClass];
				}
				,onChangeMonthYear: function( year, month, inst ) {
					Weekly.selectCurrentWeek();
				}
			});
		}

		Weekly.getThisWeekStr = function( date ) 
		{
			_weekStartDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay());
			_weekEndDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay() + 6);

			return $.format.date( _weekStartDate, _dateFormat_YYYYMMDD ) + ' - ' + $.format.date( _weekEndDate, _dateFormat_YYYYMMDD );
		}


		Weekly.getLastWeekStr = function( date ) 
		{
			_weekStartDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay());
 			_weekEndDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay() + 6);

			_weekStartDate.setDate( _weekStartDate.getDate() - 7 );
			_weekEndDate.setDate( _weekEndDate.getDate() - 7 );

			return $.format.date( _weekStartDate, _dateFormat_YYYYMMDD ) + ' - ' + $.format.date( _weekEndDate, _dateFormat_YYYYMMDD );
		}


		Weekly.getStartDate = function( weekStr ) 
		{
			var date;

			weekStr = Util.trim( weekStr );

			if ( weekStr.length == 23 )
			{
				var startDateStr = weekStr.substring(0, 10);

				date = Util.getDate_FromYYYYMMDD( startDateStr );
			}

			return date;
		}

		Weekly.getEndDate = function( weekStr ) 
		{
			var date;

			weekStr = Util.trim( weekStr );

			if ( weekStr.length == 23 )
			{
				var endDateStr = weekStr.substring(13, 23);

				date = Util.getDate_FromYYYYMMDD( endDateStr );
			}

			return date;
		}

		
		function Monthly() {}

		Monthly.populateMonthYear = function( monthTag, yearTag )
		{
			// Empty the list
			monthTag.empty();
			yearTag.empty();

			// Populate the month and year list
			monthTag.append( $( '<option></option>' ).attr( "value", 1 ).text( l10n.get("January") ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 2 ).text( l10n.get("February") ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 3 ).text( l10n.get("March") ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 4 ).text( l10n.get("April") ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 5 ).text( l10n.get("May") ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 6 ).text( l10n.get("June") ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 7 ).text( l10n.get("July") ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 8 ).text( l10n.get("August") ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 9 ).text( l10n.get("September") ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 10 ).text( l10n.get("October") ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 11 ).text( l10n.get("November") ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 12 ).text( l10n.get("December") ) );
			
			for( i = 1990; i < 2020; i++ )
			{
				yearTag.append( $( '<option></option>' ).attr( "value", i ).text( i ) );
			}			
		}

		Monthly.setDate = function( monthTag, yearTag, date )
		{
			// Set last month
			var newDate = new Date( date.getFullYear(), date.getMonth(), 1 );

			newDate.setMonth( newDate.getMonth(), 0 );

			monthTag.val( newDate.getMonth() + 1 );
			yearTag.val( newDate.getFullYear() );
		}

		Monthly.getStartDate = function( monthTag, yearTag )
		{
			return new Date( yearTag.val(), monthTag.val() - 1, 1 );
		}

		Monthly.getEndDate = function( monthTag, yearTag )
		{
			var date = new Date( yearTag.val(), monthTag.val(), 1 );

			// Set it to the last day of the last month.
			date.setDate( 0 );

			return date;
		}

		// -- Static Classes - Weekly/Monthly DatePicker Related
		// -------------------------------------------


		// -------------------------------------------
		// -- Static Classes - DB Setting Related

		function DBSetting() {}
		
		DBSetting._queryURL_SystemSettings = _queryURL_api + "systemSettings/";

		DBSetting.getSettingValue = function( settingName, successFunc, failFunc )
		{
			RESTUtil.getAsynchData( DBSetting._queryURL_SystemSettings + settingName
			, function( data )
			{
				successFunc( data );
			}
			, function( failMsg )
			{
				console.log( '[DBSetting.getSettingValue] Failed to get data from systemSettings/' + settingName + '.  Info: ' + JSON.stringify( failMsg ) );
				failFunc( failMsg );
			});
		}

		DBSetting.saveSettingValue = function( settingName, jsonData, successFunc, failFunc )
		{
			RESTUtil.submitData_Text( DBSetting._queryURL_SystemSettings + settingName, jsonData
			,successFunc, failFunc );
		}


		// -- Static Classes - DB Setting Related
		// -------------------------------------------


		// -------------------------------------
		// -- Static Classes - Message Manager Class

		function MsgManager() {}


		// --- App block/unblock ---
		MsgManager.cssBlock_Body = { 
			border: 'none'
			,padding: '15px'
			,backgroundColor: '#000'
			,'-webkit-border-radius': '10px'
			,'-moz-border-radius': '10px'
			,opacity: .5
			,color: '#fff'
			,width: '200px'
		};

		MsgManager.appBlock = function( msg )
		{
			if ( !Util.checkValue( msg ) ) msg = "Processing..";

			FormBlock.block( true, msg, MsgManager.cssBlock_Body );
		}

		MsgManager.appUnblock = function()
		{
			FormBlock.block( false );
		}


		// --- Messaging ---
		MsgManager.divMsgAreaTag;
		MsgManager.spanMsgAreaCloseTag;
		MsgManager.btnMsgAreaCloseTag;
		MsgManager.spanMsgAreaTextTag;

		MsgManager.initialSetup = function()
		{
			MsgManager.divMsgAreaTag = $( '#divMsgArea' );
			MsgManager.spanMsgAreaCloseTag = $( '#spanMsgAreaClose' );
			MsgManager.btnMsgAreaCloseTag = $( '#btnMsgAreaClose' );
			MsgManager.spanMsgAreaTextTag = $( '#spanMsgAreaText' );
				

			MsgManager.btnMsgAreaCloseTag.click( function()
			{
				MsgManager.divMsgAreaTag.hide( 'fast' );
			});
		}
	
		MsgManager.msgAreaShow = function( msg )
		{
			MsgManager.divMsgAreaTag.hide( 'fast' );
			MsgManager.spanMsgAreaTextTag.text( '' );

			MsgManager.spanMsgAreaTextTag.text( msg );
			MsgManager.divMsgAreaTag.show( 'medium' );

			console.log( ' -- Msg: ' + msg );
		}


		// -- End of Message Manager Class
		// -------------------------------------



	</script>

</head>

<body>

	<div id="dialog-loading" style="display:none;">
		<table border="0" cellpadding="0" cellspacing="0" align="right" valign="top">
		<tr>
		<td><a id="forceClose" href="" style="color:Tomato;font-size:75%;">[X]</a></td>
		</tr>
		</table>
		<table border="0" cellpadding="0" cellspacing="0" width="180px" height="100%" align="center" valign="middle">
			<tr valign="middle">
				<td height="50px" valign="middle" align="right">
					<img src="img/loading_big_blue.gif" alt="Loading" />
				</td>
				<td height="50px" valign="middle" align="left" style="font-size: medium;">
					&nbsp;&nbsp;- 
				</td>
				<td data-l10n-id="loading" height="50px" valign="middle" align="left" style="font-size: medium;">
				</td>
			</tr>
		</table>
	</div>

	<div id="personDialogForm" class="ui-widget" style="margin:0; padding:0; display:none;">
		<b><span data-l10n-id="personInfo" nameId='PersonInfo' ></span></b>

		<div style="margin: 3px; padding: 4px 7px; border: solid 1px #888;">
			<table id="person_Table" class="tbTEIDetail" style="width:100%;">
			</table>
		</div>
		
		<input id="person_Result" type="hidden" />
		<input id="person_formType" type="hidden" />
		<input id="person_id" type="hidden" />
	</div>		

	<div id="orgUnitMapDialogForm" class="ui-widget" style="margin:0;padding:0;">
		<div id="orgUnitMapBig" class="gmap3"></div>
	</div>

	<div id="orgUnitSelectionTreeDialogForm" class="ui-widget" style="margin:0;padding:0;display:none;">
		<table style="padding: 0; margin: 0;">
			<thead>
				<tr>
					<td>
						<select id="treeSelectedId" name="treeSelectedId" multiple="multiple" style="display:none"/>
					</td>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>											
						<div id="selectionTree"></div>	
					</td>
				</tr>
			</tbody>
		</table>

	</div>

	<div id="settingDialogForm" class="ui-widget" style="margin:0;padding:0;display:none;"">
		<b><span data-l10n-id="appSetting" nameId='SettingFormTitle'></span></b>
		<br>
		<br>
		<table id="setting_Table" class="listTable" style="width:95%;">
			<tr>
				<td data-l10n-id="countryLevel"> <span title='Compulsory' class='mandatory'>*</span></td><td><select id="countryLevels"></select></td>
			</tr>
			<tr id="trLatestVersion" style="display: none;">
				<td data-l10n-id="latestVersion"></td><td><input id="latestVersion" type="Text" size="5" /></td>
			</tr>
			<tr id="trIncompleteActionUserRole" style="display: none;">
				<td data-l10n-id="incompleteActionUserRole"></td><td><input id="incompleteActionUserRole" type="Text" size="20" /></td>
			</tr>
		</table>
	</div>

	<div id="header">
		<img id="headerBanner" src="img/logo_banner.png" style="cursor:pointer" title="View home page">
		<span id="headerText" style="cursor:pointer" title="View home page"></span>
		<div id="headerRightSideControls">
				<a href='' id='settingFormOpen' style="color: White;" data-l10n-id="setting"></a> | <a href="https://docs.google.com/document/d/1S6WD_oYdewVWFvsDnr1CL8yM2easN5mDc7j8QWI09Sw" target="_blank" style="color: White;">v <span id="currentVersion">1.54</span></a>
				| <button type="button" id="closeButton" class="button" style="font-size: 11px;"><span data-l10n-id="close" nameId='closeButton'></span></button>
		</div>
	</div>

	<div id="divMsgArea" style="display: none;">
		<span id="spanMsgAreaClose"><img src="img/hide.png" title="Close" id="btnMsgAreaClose"></span>
		<span id="spanMsgAreaText"></span>
	</div>

	<div style="display: block;margin-top: 38px;">		

		<table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td align="left" valign="top">

					<div style="margin-top: 4px;">

						<div><span data-l10n-id="appTitle" id="appTitle" nameId='MainTitle' class="pageTitle" style="display:none;"></span><div>

						<table id="settingConsole" class="tbBorderNone" style="margin-top: 4px;">
						  <tr class="valignTop">

							<td id="orgUnitRow" style="display:none;">
								<table>
								<tr>
								  <td class="consoleTitle">	
									<span data-l10n-id="searchOrgUnit" nameId='OrgUnit'></span>
								  </td>
								  <td style="white-space: nowrap;">
									<input type="text" id="orgUnitName" size="30"/><input type="button" id="orgUnitTreeBtn" value="T" title="Open OrgUnitTree" style="cursor:pointer; margin:0px; padding:1px 2px; color:#777777; background-color: #F2F9FF; border-left: none;"><span id="personFoundNo" style="font-size: 9px;color:#CCCCCC;margin-left:1px;"></span>
								  </td>
								 </tr>
								 </table>

								<div id='orgUnitLoading' style='display:none'>
									<img src='img/ui-anim_basic.gif'/><span data-l10n-id="retrieving"></span>
								</div>

							</td>

							<td id="defaultProgramRow" style="display:none;">
								<table>
								<tr>
								  <td class="consoleTitle">	
									<span data-l10n-id="searchProgram" nameId='DefaultProgram'></span>
								  </td>
								  <td>
									<select id="defaultProgram"></select> 
								  </td>
								 </tr>
								 </table>

								<div id='programLoading' style='display:none'>
									<img src='img/ui-anim_basic.gif'/><span data-l10n-id="loading"></span>
								</div>

							</td>

							<td id="defaultDateRow" style="display:none;">
								<table>
								<tr>
								  <td class="consoleTitle">	
									<span data-l10n-id="searchPeriod" nameId='Period'></span>
								  </td>
								  <td style="white-space: nowrap;">
									<input type="radio" name="period" value="month"/><span data-l10n-id="month" nameId='PeriodMonth'></span>
									<input type="radio" name="period" value="week"/><span data-l10n-id="week" nameId='PeriodWeek'></span>
									<input type="radio" name="period" value="custom"/><span data-l10n-id="custom" nameId='PeriodOther'></span>
									
									<span id="defaultMonth" style="display:none;"><select id="defaultMonth_Month"></select> <select id="defaultMonth_Year"></select></span> 

									<input type="text" id="defaultWeek" class="defaultDatePicker" style="display:none; width:160px;"></input>

									<span id="defaultDatePeriod" style="display:none;"><input type="text" id="defaultDateFrom" class="defaultDatePicker" style="width:80px;"></input> - <input type="text" id="defaultDateTo" class="defaultDatePicker"  style="width:80px;"></input></span>
								  </td>
								</tr>
								</table>
							</td>

							<td id="defaultRetrievalRow" style="display:none; vertical-align:middle; padding-left:5px;">
								<button type="button" id="executeRetrieval" class="BlueButton" style="width: 50px;" ><span data-l10n-id="executeRetrieval" nameId='executeRetrieval'></span></button>

							</td>

						  </tr>
						  <tr id="personEventSearchOptions" style="display:none;">
							<td colspan="3" class="valignTop" style="padding-top:4px;padding-bottom:3px;">

							<span data-l10n-id="programStatus" nameId='ProgramStatus'></span>
							<select id="programStatusList">
								<option data-l10n-id="active" value="ACTIVE"></option>
								<option data-l10n-id="completed" value="COMPLETED"></option>
								<option data-l10n-id="cancelled" value="CANCELLED"></option>
							</select>&nbsp;&nbsp;

							<input id="searchAllProgram" type="checkbox" style="vertical-align:bottom;" /><span data-l10n-id="searchProgramPerson" nameId='SearchAllProgram' style="color:#222222; font-style:italic;"></span>&nbsp;&nbsp;&nbsp;
							<input id="listAllPersonHistoricalEvents" type="checkbox" style="vertical-align:bottom;" /><span data-l10n-id="listEventsPerson" nameId='ListAllHistoricalEvents' style="color:#222222; font-style:italic;"></span>
						</td>
					  </tr>
					  <tr id="searchResultMsgRow" style="display:none;">
						<td colspan="3">
							&nbsp;&nbsp;<span id="searchResultMessage" style="color:#444444;font-style:italic;"> </span>
							&nbsp;&nbsp;<span id="defaultProgramNote"></span>
						</td>
					  </tr>
					  </table>
				</div>

				</td>
				<td align="right" valign="top">
					<div id="orgUnitMapSmall" style="display:none;margin-top:2px;margin-right:4px;"><a href="" id="orgUnitMapAnchor"><img id="orgUnitMapImage" src="" alt="" /></a></div>
				</td>
			</tr>
		</table>


		<div style="line-height:5px;"></div>
		<br>

		<div id="mainSection_Person" class="tbStyle_Person" style="display:none;" >

			<div style="margin-top:-10px; margin-bottom:6px;">
				<button type="button" class="person_addNewRow BlueButton"><span data-l10n-id="addNewRow" nameId='AddNewRow'></span></button>
			</div>

			<table id="mainTable_Person" border="1" class="tbStyle_Person" style="font-size:small;">
				<colgroup>
					<col />
					<col width="100px" />
				</colgroup>
			</table>	

			<div style="margin-top:4px;">
				<button type="button" class="person_addNewRow BlueButton"><span data-l10n-id="addNewRow" nameId='AddNewRow'></span></button>
			</div>
		</div>


		<div id="mainSection_Event" class="tbStyle_Person" style="display:none;">

			<button type='button' class='personEvent_addNewRow BlueButton' style="margin-top: -10px; margin-bottom:8px;"><span data-l10n-id="addEvent" nameId='AddNewEventRow'></span></button>

			<table id="mainTable_Event" border="1" class="tbStyle_PersonDetail" style="margin-left: 0px;font-size:small;">
				<tr class='trEventHead'>
					<th class='orig' align='center'><span data-l10n-id="date" nameId='EventTableHeader_Date'></span></th>
					<th class='orig'></th>
					<th class='orig' align='center'><span data-l10n-id="status" nameId='EventTableHeader_Status'></span></th>
					<th class='orig' type='delete'>&nbsp;</th>
				</tr>
			</table>

			<button type='button' class='personEvent_addNewRow BlueButton' style="margin-top:4px;"><span data-l10n-id="addEvent" nameId='AddNewEventRow'></span></button>

		</div>

		<br>

		<!--
		<button type='button' id='testBtn'>Test</button>
		-->
		<div id='programRuleLoading' style='display:none'>
			<img src='img/ui-anim_basic.gif'/>retrieving..</span>
		</div>


		<div id="translationTagDiv" style="display:none;">
			<span data-l10n-id="addPerson" nameId='AddPerson'></span>
			<span data-l10n-id="updatePerson" nameId='UpdatePerson'></span>

			<span data-l10n-id="dateOrgunit" nameId='EventTableHeader_Date_OrgUnit'></span>
			<span data-l10n-id="programAndStage" nameId='EventTableHeader_Program_Stage'></span>
			<span data-l10n-id="status" nameId='EventTableHeader_Status'></span>
			<span data-l10n-id="addEvent" nameId='AddNewEventRow'></span>

			<span data-l10n-id="create" nameId='CreateEvent'></span>
			<span data-l10n-id="complete" nameId='CompleteEvent'></span>

			<span class="msg_CacheClear" nameId='Msg_CacheClear'>[Warning] Application files are not in synch. Please clear cache in browser to remove older javascript files.</span>
			<span class="msg_MandatoryFill" nameId='Msg_MandatoryFill'>[Message] Mandatory field has to be filled.</span>
			<span class="msg_ValidFill" nameId='Msg_ValidFill'>[Message] Invalid fields have to be cleared.</span>			
			<span class="msg_NoProgramAttributes" nameId='Msg_NoProgramAttributes'>[Message] The selected program does not have any person attribtues.</span>
			<span class="msg_SelectDefaultProgram" nameId='Msg_SelectDefaultProgram'>[Message] Please select the default program in order to proceed this.</span>
			<span class="msg_ProgramAttributeAtLeast" nameId='Msg_ProgramAttributeAtLeast'>[Message] The program needs to have at least one display attribute for this!</span>
			<span class="msg_SamePersonInList" nameId='Msg_SamePersonInList'>[Message] The same person exists in the list already.</span>
			<span class="msg_CanNotEnrol_PreviousEnroll" nameId='Msg_CanNotEnrol_PreviousEnroll'>[Message] Can not enroll to the program.  It has previous non-active enrollment to the program and the program is set to only enroll once.</span>
			<span class="msg_CheckEventDateStage" nameId='Msg_CheckEventDateStage'>[Message] Please check event date value and event stage selection, and try again.</span>
			<span class="msg_NotEnrolled" nameId='Msg_NotEnrolled'>[Message] The TEI is not yet enrolled to the program.  Update the TEI Info first to create event.</span>
			<span class="msg_FailedToEnroll" nameId='Msg_FailedToEnroll'>[Message] Failed to enroll - </span>
			<span class="msg_FailedToCreateEvent" nameId='Msg_FailedToCreateEvent'>[Message] Failed to create the event: </span>
			<span class="msg_EventDeleted" nameId='Msg_EventDeleted'>[Message] Successfully deleted the event!</span>
			<span class="msg_EventDeleteFailed" nameId='Msg_EventDeleteFailed'>[Message] Failed to delete the event!</span>
			<span class="msg_EventRetrievalFailed" nameId='Msg_EventRetrievalFailed'>[Message] Failed to retrieve the events!</span>
			<span class="msg_EventUpdateFailed" nameId='Msg_EventUpdateFailed'>[Message] Failed to update the event</span>
			<span class="msg_CompulsoryFill" nameId='Msg_CompulsoryFill'>[Message] Please fill the compulsory fields in order to proceed.</span>
			<span class="msg_ProgramRuleError" nameId='Msg_ProgramRuleError'>[Message] Please resolve the program rule error case(s) before proceeding.</span>
			<span class="msg_PersonNotFoundDHIS" nameId='Msg_PersonNotFoundDHIS'>[Message] Tracked Entity 'Person' was not found in this DHIS system.  Please add 'Person' Tracked Entity first.</span>
			<span class="msg_SelectDefaultProgram" nameId='Msg_SelectDefaultProgram'>[Message] Please select the Default Program.</span>
			<span class="msg_PersonNotFound" nameId='Msg_PersonNotFound'>[Message] Person Not Found</span>
			<span class="msg_PersonCreated" nameId='Msg_PersonCreated'>[Message] Person created successfully!</span>
			<span class="msg_ProgramEnrolled" nameId='Msg_ProgramEnrolled'>[Message] Enrolled to the program</span>
			<span class="msg_ProgramEnrollFailed" nameId='Msg_ProgramEnrollFailed'>[Message] Failed to enroll - </span>
			<span class="msg_PersonInfoUpdated" nameId='Msg_PersonInfoUpdated'>[Message] Person info updated successfully!</span>
			<span class="msg_PersonCreateUpdateFailed" nameId='Msg_PersonCreateUpdateFailed'>[Message] Failed to create/update the person.  Detail: </span>
			<span class="msg_DefaultLanguageEdit" nameId='Msg_DefaultLanguageEdit'>[Message] Default langauge can not be edited.</span>
			<span class="msg_SettingData_MandatoryCountryLevel" nameId='Msg_SettingData_MandatoryCountryLevel'>[Message] Country Level is a mandatory field.  Please set the Country Level to continue.</span>
			<span class="msg_SettingData_FailedToSave" nameId='Msg_SettingData_FailedToSave'>[Message] Failed to save the setting data.</span>
			<span class="msg_SettingData_CountryLevelNotDefined" nameId='Msg_SettingData_CountryLevelNotDefined'>[Message] Country Level is not defined!  Aborted the task.</span>
			<span class="msg_SettingData_OrgUnitLevelNotFound" nameId='Msg_SettingData_OrgUnitLevelNotFound'>[Message] Organisation Unit Level not found.  Please check Organisation Unit level set or manifest.webapp dhis.href value.</span>

			<span class="msg_ConfirmDelete" nameId='Msg_ConfirmDelete'>[Confirm] Are you sure that you want to delete?</span>
			<span class="msg_ConfirmEventComplete" nameId='Msg_ConfirmEventComplete'>[Confirm] Are you sure that you want to complete this event?</span>
			<span class="msg_ConfirmEventIncomplete" nameId='Msg_ConfirmEventIncomplete'>[Confirm] Are you sure that you want to incomplete this event?</span>
		</div>
	</div>

</body>

</html>